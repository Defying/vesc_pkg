@const-symbol-strings(def hd -1)(def ca -1)(def dp -1)(def dq -1)(def j -1)(def id -1)(def fo -1)(def ak -1)(def hc -1)(def bg -1)(def bp -1)(def fd -1)(def el -1)(def ic -1)(def be -1)(def bs 1)(def cu'())(def hj'())(def ef'())(def cl 0)(def hb -1)(def fu'())(def gb 31)(def cw(systime))(def gs(systime))(def hu(systime))(def cy(systime))(def hp'(0xFF0000u32 0xFFFF00u32 0x00FF00u32 0x00FFFFu32 0x0000FFu32 0xFF00FFu32))(def hm'(0x00FFFF00 0x0000FF00 0x0000FFFF 0x000000FF 0x00FF00FF 0x00FF0000))(def gl 101)(def cc 102)(def gf'((hw . 0)(hs . 10)(ec . 24)(fv . 29)(cx . 202)))(def gv 0)(def di 0)(def cf 0)(def fy 0)(def fe 1)(def dy 0)(def eg 0)(def fa 0)(def gt [0 0 0 0 1 2 3 4 5 7 8 11 14 16 18 19 25 30 33 37 43 48 53 60 67 71 76 82 92 97 100])(def gg 422i32)(def ch'((gd .(0 i gg -1))(crc .(1 i 60967 -1))(cj .(2 i -1 -1))(cm .(3 b 1 -1))(fq .(4 b 1 -1))(ee .(5 i 0 -1))(z .(6 i 5 -1))(gz .(7 i 0 -1))(bh .(8 i 5 -1))(ep .(9 b 1 -1))(ae .(10 b 1 -1))(by .(11 f -4.0 -1))(ie .(12 i 30 -1))(ds .(13 i 120 -1))(fh .(14 f 0.5 -1))(at .(15 f 0.5 -1))(cd .(16 f 0.2 -1))(bq .(17 f 0.5 -1))(hy .(18 i -1 -1))(ci .(19 i 10 -1))(ei .(20 i 2 -1))(es .(21 b 0 -1))(dk .(22 i 18 -1))(l .(23 i 13 -1))(gm .(24 i 2 -1))(ed .(25 b 0 -1))(hn .(26 b 1 -1))(gr .(27 i 17 -1))(fx .(28 i 13 -1))(av .(29 i 2 -1))(he .(30 b 0 -1))(hl .(31 b 1 -1))(fc .(32 i -1 -1))(ig .(33 i -1 -1))(co .(34 i 1 -1))(ho .(35 i -1 -1))(ht .(36 i -1 -1))(am .(37 i -1 -1))(bo .(38 i -1 -1))(ey .(39 i -1 -1))(dn .(40 i -1 -1))(gy .(41 i -1 -1))))@const-start(defun ej(dg){(var aq(length dg))(var fb(floor(/ aq 4.0)))(var gk(floor(* aq 3(/ 1 4.0))))(looprange i 0 aq {(if(and(>= i fb)(< i gk)){(if(or(= i fb)(= i(- gk 1))){(setix dg i 0x007F0000)} {(setix dg i 0x00FF0000)})} {(setix dg i 0x00000000)})})})(defun dv(){(setq gv(mod(+ gv 1)2))(var ad(if(= gv 0)0xFFFFFFFF 0x00000000))(gj hj ad)(gj ef ad)})(defun ao(){(setq di(mod(+ di 1)2))(gj ef(if(= di 0)0x00FF0000 0x00000000))})(defun dz(cn){(var hv(ix hm cf))(gj hj(if(= cn 0)hv 0xFF000000))(gj ef hv)(setq cf(mod(+ cf 1)6))})(defun max(dm b)(if(> dm b)dm b))(defun min(dm b)(if(< dm b)dm b))(defun dr(){(var bn(+(length hj)(length ef)))(looprange i 0 bn {(var y(abs(- i fy)))(var hx(max 0(- 255(* y 51))))(var ad(color-make hx 0 0))(if(< i(length hj))(setix hj i ad)(setix ef(- i(length hj))ad))})(setq fy(+ fy fe))(if(or(>= fy bn)(< fy 0))(setq fe(* fe -1)))})(defun dl(cq){(var aq(length cq))(var er(floor(* aq cl)))(looprange ac 0 aq {(var dt 0)(var ab 0)(if(or(< ac er)(and(= ac 0)(<= er 1))){(if(or(< cl 0.2)(and(= ac 0)(<= er 1))){(setq dt 255)(setq ab 0)} {(setq dt(floor(* 255(- 1(/ cl 0.8)))))(setq ab(floor(* 255(/ cl 0.8))))})} {(setq dt 0)(setq ab 0)})(var ad 0x00)(setq ad(bits-enc-int ad 16 dt 8))(setq ad(bits-enc-int ad 8 ab 8))(setix cq ac ad)})})(defun ag(){(var bk(length hp))(looprange ac 0(length hj){(var p(mod(+ dy ac(length hj))bk))(var ad(ix hp p))(setix hj ac ad)})(looprange ac 0(length ef){(var p(mod(+ dy ac(length ef))bk))(var ad(ix hp p))(setix ef ac ad)})(setq dy(mod(+ dy 1)bk))})(defun bu(){(var ex(mod eg 3))(var l(length hj))(var fx(length ef))(var eb(floor(/ l 2)))(var cs(floor(/ fx 2)))(cond((= ex 0){(looprange i 0 eb(setix hj i 0x00000000))(looprange i eb l(setix hj i 0x00FF0000))(looprange i 0 cs(setix ef i 0x00000000))(looprange i cs fx(setix ef i 0x00FF0000))})((= ex 1){(looprange i 0 eb(setix hj i 0x00FF0000))(looprange i eb l(setix hj i 0x000000FF))(looprange i 0 cs(setix ef i 0x00FF0000))(looprange i cs fx(setix ef i 0x000000FF))})((= ex 2){(looprange i 0 eb(setix hj i 0x000000FF))(looprange i eb l(setix hj i 0x00000000))(looprange i 0 cs(setix ef i 0x000000FF))(looprange i cs fx(setix ef i 0x00000000))}))(setq eg(mod(+ eg 1)3))})(defun bj(){(if(> id 250.0){(hi)}{(if(and(!= j 1)(!= j 2)(!= j 3)){(dl cu)}{(ha j)})})})(defun hi(){(var ci(length cu))(var cp(*(abs bg)1.1112))(var v 0.0)(if(< cp 1.0){(setq v cp)} {(setq v 1.0)})(var hk(floor(* v ci)))(var ba 0x00FFFF00u32)(if(>(abs bg)0.85){(setq ba 0x00FF0000u32)} {(if(>(abs bg)0.7){(setq ba 0x00FF8800u32)})})(looprange ac 0 ci {(setix cu ac(if(< ac hk)ba 0x00000000u32))})})(defun ha(j){(var ci(length cu))(var ar(if(or(= j 1)(= j 3))0xFF 0x00))(var bl(if(or(= j 2)(= j 3))0xFF 0x00))(looprange ac 0 ci {(setix cu ac(if(< ac(/ ci 2))ar bl))})})(defun gj(dg ad){(looprange ac 0(length dg){(setix dg ac ad)})})(defun hz(){(gj cu 0x00)(gj hj 0x00)(gj ef 0x00)})(defun fj(cq){(looprange ac 0(length cq){(var ad(color-split(ix cq ac)1))(var al(color-make(ix ad 1)(ix ad 0)(ix ad 2)(ix ad 3)))(setix cq ac al)})})(defun af(bz){(if(=(cg'es)1){(setq cu(reverse cu))})(if(=(cg'ed)1){(setq hj(reverse hj))})(if(=(cg'he)1){(setq ef(reverse ef))})(var fq(cg'fq))(var at(cg'at))(var hy(cg'hy))(var dk(cg'dk))(var gr(cg'gr))(var hn(cg'hn))(var hl(cg'hl))(var au(if(and(>= bz 0)(!= fq 0))(to-i(* 0xFF at))0x00))(var aw(if(and(< bz 0)(!= fq 0))(to-i(* 0xFF at))0x00))(if(or(= hn 2)(= hn 3)){(setq hj(append(list au)hj))})(if(or(= hl 2)(= hl 3)){(setq ef(append(list aw)ef))})(if(or(= hn 4)(= hn 5)){(var a(take hj(length hj)))(setq hj(bm(+(length hj)4)0))(var cr 0)(looprange bd 0(length hj){(if(or(and(= hn 4)(or(= bd 2)(= bd 7)(= bd 13)(= bd 18)))(and(= hn 5)(or(= bd 1)(= bd 5)(= bd 10)(= bd 3)))){(setix hj bd au)}{(setix hj bd(ix a cr))(setq cr(+ cr 1))})})})(if(or(= hl 4)(= hl 5)){(var a(take ef(length ef)))(setq ef(bm(+(length ef)4)0))(var cr 0)(looprange bd 0(length ef){(if(or(and(= hl 4)(or(= bd 2)(= bd 7)(= bd 13)(= bd 18)))(and(= hl 5)(or(= bd 1)(= bd 5)(= bd 10)(= bd 3)))){(setix ef bd aw)}{(setix ef bd(ix a cr))(setq cr(+ cr 1))})})})(var ei(cg'ei))(var gm(cg'gm))(var av(cg'av))(var l(length hj))(var fx(length ef))(if(and(>= dk 0)(= hy dk)(= dk gr)){(var ek(append cu hj ef))(var bn(length ek))(var eu(rgbled-buffer bn ei))(rgbled-color eu 0 ek bs)(if(not-eq(first(trap(rgbled-init dk gm)))'exit-ok){(ez'dk -1)(an"Invalid Pin")(hq'dk -1)(hq'crc(n))}{(br 0.01)(rgbled-update eu)(br 0.01)})(free eu)} {(if(and(>= dk 0)(= dk gr)){(var ek(append hj ef))(var bn(length ek))(var eu(rgbled-buffer bn gm))(rgbled-color eu 0 ek bs)(if(not-eq(first(trap(rgbled-init dk gm)))'exit-ok){(ez'dk -1)(an"Invalid Pin")(hq'dk -1)(hq'crc(n))}{(br 0.01)(rgbled-update eu)(br 0.01)})(free eu)}{(if(and(>= hy 0)(= hy gr)){(if(!= ei av)(fj cu))(var ek(append cu ef))(var bn(length ek))(var eu(rgbled-buffer bn av))(rgbled-color eu 0 ek bs)(if(not-eq(first(trap(rgbled-init hy ei)))'exit-ok){(ez'hy -1)(an"Invalid Pin")(hq'hy -1)(hq'crc(n))}{(br 0.01)(rgbled-update eu)(br 0.01)})(free eu)}{(if(>= hy 0){(var dd(rgbled-buffer(length cu)ei))(rgbled-color dd 0 cu(cg'bq))(if(not-eq(first(trap(rgbled-init hy ei)))'exit-ok){(ez'hy -1)(an"Invalid Pin")(hq'hy -1)(hq'crc(n))}{(br 0.01)(rgbled-update dd)(br 0.01)})(free dd)})(if(>= gr 0){(var ff(rgbled-buffer fx ei))(rgbled-color ff 0 ef bs)(if(not-eq(first(trap(rgbled-init gr av)))'exit-ok){(ez'gr -1)(an"Invalid Pin")(hq'gr -1)(hq'crc(n))}{(br 0.01)(rgbled-update ff)(br 0.01)})(free ff)})})(if(>= dk 0){(var ay(rgbled-buffer l ei))(rgbled-color ay 0 hj bs)(if(not-eq(first(trap(rgbled-init dk gm)))'exit-ok){(ez'dk -1)(an"Invalid Pin")(hq'dk -1)(hq'crc(n))}{(br 0.01)(rgbled-update ay)(br 0.01)})(free ay)})})})})(defunret eo(){(var ce'())(var bc(cg'cj))(ez'cj -1)(var bi(systime))(loopwhile-thd 150(<=(secs-since bi)10){(if(and(>= bc 0)(<=(secs-since bi)5)){(setq ce(list bc))}{(setq ce(can-scan))})(loopforeach cj ce {(setq hb cj)(ge cj(list(assoc gf'hw)))(br 0.5)(if(>=(cg'cj)0){(if(not-eq(cg'cj)bc){(hq'cj(cg'cj))(hq'crc(n))})(return 1)})})})(return 0)})(defun ge(cj gw){(send-data(append(list gl)gw)2 cj)})(defun status (){(var gh"status ")(setq gh(str-merge gh(str-from-n(if(<(secs-since cy)1)1 0)"%d ")))(setq gh(str-merge gh(str-from-n(if(<(secs-since cw)1)1 0)"%d ")))(setq gh(str-merge gh(str-from-n(if(<(secs-since gs)1)1 0)"%d ")))(send-data gh)})(defun ai(){(var fc(cg'fc))(var ig(cg'ig))(uart-stop)(if(>= ig 0){(if(not-eq(first(trap(gpio-configure ig'pin-mode-out)))'exit-ok){(ez'ig -1)(an"Invalid Pin")(hq'ig -1)(hq'crc(n))})})(if(>= fc 0){(if(not-eq(first(trap(gpio-configure fc'pin-mode-in-pu)))'exit-ok){(ez'fc -1)(an"Invalid Pin")(hq'fc -1)(hq'crc(n))}{(uart-start 1 fc -1 115200)(set-bms-val'bms-cell-num 15)(set-bms-val'bms-temp-adc-num 4)(set-bms-val'bms-temp-cell-max 45)})})})(defunret cg(ib){(var ew(assoc ch ib))(if ew(return(car(cdr(cdr(cdr ew)))))(return nil))})(defun save-config(){(loopforeach ax ch {(var ib(first ax))(if(eq ib'crc){(hq ib(n))}{(hq ib(cg ib))})})(send-data"Settings Saved!")})(defunret n(){(var i 0)(var fg(-(length ch)1))(var ga(bufcreate fg))(loopforeach ax ch {(var ib(first ax))(if(not-eq ib'crc){(bufset-i32 ga i(cg ib))(+ i 1)})})(var crc(crc16 ga))(free ga)(return crc)})(defun gn(){(loopforeach ax ch {(var ib(first ax))(var fs(hh ib))(ez ib fs)})})(defun restore-config(){(loopforeach ax ch {(var ib(first ax))(var df(if(eq ib'gd)gg(ix ax 3)))(hq ib df)})(gn)(send-data"Settings Restored!")})(defun hh(ib)(let((fm(first(assoc ch ib)))(cn(second(assoc ch ib))))(cond((eq cn'i)(eeprom-read-i fm))((eq cn'f)(eeprom-read-f fm))((eq cn'b)(eeprom-read-i fm)))))(defun hq(ib fs)(let((fm(first(assoc ch ib)))(cn(second(assoc ch ib))))(cond((eq cn'i)(eeprom-store-i fm fs))((eq cn'f)(eeprom-store-f fm fs))((eq cn'b)(eeprom-store-i fm fs)))))(defun an(q)(send-data(str-merge"msg "q)))(defun bm(hf fs)(map(fn(x)fs)(range hf)))(defun ck(){(if(!=(str-cmp(to-str(sysinfo'hw-type))"hw-express")0){(exit-error"bx running on hw-express")})(var aj(+(first(sysinfo'fw-ver))(*(second(sysinfo'fw-ver))0.01)))(if(< aj 6.05)(exit-error"hw-express fr de hr running 6.05"))(if(not-eq(hh'gd)gg)(restore-config)(gn))(if(!=(n)(to-i(hh'crc))){(an"Error: crc corrupt")(restore-config)})(spawn az)(event-register-handler(spawn ft))(event-enable'event-data-rx)(spawn eo)(if(=(conf-get'wifi-mode)0){(an"WiFi is disabled. Please enable and reboot.")}{(event-enable'event-esp-now-rx)(setq fu(list(cg'ho)(cg'ht)(cg'am)(cg'bo)(cg'ey)(cg'dn)))(cv fu)(spawn fw)})(ai)(spawn k)})(defun recv-config(cm fq ee z gz bh ep ae by ie ds fh at cd bq hy ci ei es dk l gm ed hn gr fx av he hl fc ig co){(ez'cm(to-i cm))(ez'fq(to-i fq))(ez'ee(to-i ee))(ez'z(to-i z))(ez'gz(to-i gz))(ez'bh(to-i bh))(ez'ep(to-i ep))(ez'ae(to-i ae))(ez'by(to-float by))(ez'ie(to-i ie))(ez'ds(to-i ds))(ez'fh(to-float fh))(ez'at(to-float at))(ez'cd(to-float cd))(ez'bq(to-float bq))(ez'hy(to-i hy))(ez'ci(to-i ci))(ez'ei(to-i ei))(ez'es(to-i es))(ez'dk(to-i dk))(ez'l(to-i l))(ez'gm(to-i gm))(ez'ed(to-i ed))(ez'hn(to-i hn))(ez'gr(to-i gr))(ez'fx(to-i fx))(ez'av(to-i av))(ez'he(to-i he))(ez'hl(to-i hl))(var bt(cg'fc))(ez'fc(to-i fc))(var ct(cg'ig))(ez'ig(to-i ig))(ez'co(to-i co))(if(or(!=(to-i fc)bt)(!=(to-i ig)ct)){(ai)})})(defun aa(o)(let((e(max 0(min(- o 2700)(- 1500 1)))))(let((i(* e(/ 30.0 1500))))(let((bv(floor i)))(let((f(- i bv)))(let((dm(bufget-u8 gt bv))(b(bufget-u8 gt(+ bv 1))))(max 0(min(round(+ dm(* f(- b dm))))100))))))))(defun c(dx){(atomic {(if(and(>(buflen dx)1)(=(bufget-u8 dx 0)cc)){(bufcpy dx 0 dx 1(-(buflen dx)1))(eval(read dx))})})(if(and(>(buflen dx)1)(=(bufget-u8 dx 0)gl)){(setq cy(systime))(match(cossa gf(bufget-u8 dx 1))(hw {(ez'cj hb)})(cx {(var ia(bufget-u8 dx 2))(ez'cm(bits-dec-int ia 0 1))(ez'fq(bits-dec-int ia 1 1))})(ec {(setq dq(bufget-u8 dx 2))(setq hd(bufget-u8 dx 3))(if(= dq 3){(setq ca 0.0)(setq bg(bufget-u8 dx 4))}{(setq ca(to-float(bufget-i8 dx 4)))(setq bg 0.0)})(setq id(/(to-float(bufget-i16 dx 5))10))(setq hc(/(to-float(bufget-i16 dx 7))10))(setq fo(/(to-float(bufget-i16 dx 9))10))(ez'fh(/(bufget-u8 dx 11)100.0))(ez'cd(/(bufget-u8 dx 12)100.0))(ez'bq(/(bufget-u8 dx 13)100.0))})(fv {(setq cl(/(bufget-u8 dx 2)100.0))})(hs {(var et(bufget-u8 dx 2))(if(= et 69){(setq hd(bufget-u8 dx 3))} {(setq ca(/(to-float(bufget-i16 dx 5))10))(setq dp(/(to-float(bufget-i16 dx 7))10))(setq dq(bufget-u8 dx 9))(setq j(bufget-u8 dx 10))(setq fo(/(to-float(bufget-i16 dx 22))10))(setq id(to-float(bufget-i16 dx 24)))(setq ak(/(to-float(bufget-i16 dx 26))10))(setq hc(/(to-float(bufget-i16 dx 28))10))(setq bg(-(/(bufget-u8 dx 30)100.0)0.5))(if(>= et 2){(setq bp(bufget-f32 dx 34))(setq fd(/(bufget-u8 dx 38)2.0))(setq el(/(bufget-u8 dx 39)2.0))})(if(>= et 3){(setq ic(bufget-u32 dx 41))(setq be(/(bufget-u8 dx 53)2.0))})})})(_ nil))})(free dx)})(defun az(){(var bz 0)(var cb 0)(var fl(secs-since 0))(var gu 0)(var hg 0)(loopwhile-thd 100 t {(setq gu(secs-since 0))(var cj(cg'cj))(ge cj(append(list(assoc gf'ec))'(102 108 111 97 116 45 97 99 99 101 115 115 111 114 105 101 115 49 46 48 0)))(ge cj(list(assoc gf'cx)))(ge cj(list(assoc gf'fv)))(if(=(cg'cm)1){(setq cu(bm(cg'ci)0))(setq hj(bm(cg'l)0))(setq ef(bm(cg'fx)0))(setq bz 0)(var w 10)(if(= dq 4)(setq w(*w -1)))(if(> id w){(setq bz 1)})(if(< id(* w -1)){(setq bz -1)})(if(=(cg'ep)1){(if(> ca 70)(setq cb 1)(setq cb 0))})(gx(secs-since hu)bz cb)(if(or(!= bz 0)(= cb 1)){(setq hu(systime))})} {(hz)})(af bz)(setq fl(+ fl 0.1))(var ah(- fl(secs-since 0)))(if(> ah 0){(br ah)(setq fl(secs-since 0))})})})(defun send-config(){(var du"settings ")(loopforeach ax ch {(let((ib(first ax))(cn(third ax))){(var value(hh ib))(setq du(str-merge du(cond((eq cn'b)(str-from-n value"%d "))((eq cn'i)(str-from-n value"%d "))((eq cn'f)(str-from-n value"%.2f ")))))})})(send-data du)(send-data"Settings Read!")})(defun cv(bw){(esp-now-start)(esp-now-del-peer fu)(esp-now-add-peer fu)})(defun pair-pubmote(dh){(if(=(conf-get'wifi-mode)0){(an"WiFi is disabled. Please enable and reboot.")}{(cond((>= dh 0){(ez'gy(to-i32 dh))(setq gb(systime))(setq fa 1)})((= dh -1){(cv fu)(hq'ho(ix fu 0))(hq'ht(ix fu 1))(hq'am(ix fu 2))(hq'bo(ix fu 3))(hq'ey(ix fu 4))(hq'dn(ix fu 5))(hq'gy(cg'gy))(hq'crc(n))(setq fa 0)})((= dh -2){(setq fu'())(hq'ho -1)(hq'crc(n))(setq fa 0)}))})})(defun fw(){(var fl(secs-since 0))(var gu 0)(var hg 0)(loopwhile-thd 100 t {(setq gu(secs-since 0))(if(and(>(secs-since gb)30)(>= fa 2)){(atomic(pair-pubmote -2))})(if(= fa 1){(esp-now-del-peer fu)(setq fu'(255 255 255 255 255 255))(esp-now-add-peer fu)(var dx(bufcreate 6))(var cz(get-mac-addr))(looprange i 0(buflen dx){(bufset-u8 dx i(ix cz i))})(esp-now-send fu dx)(free dx)(esp-now-del-peer fu)(setq fa 2)})(if(and(= fa 0)(>=(cg'ho)0)(<=(secs-since cw)5)(>=(cg'cj)0)){(ge(cg'cj)(list(assoc gf'hs)3))(var dx(bufcreate 32))(bufset-u8 dx 0 69)(bufset-u8 dx 1 hd)(bufset-i16 dx 2(floor(* ca 10)))(bufset-i16 dx 4(floor(* dp 10)))(bufset-u8 dx 6 dq)(bufset-u8 dx 7 j)(bufset-i16 dx 8(floor(* fo 10)))(bufset-i16 dx 10(floor id))(bufset-i16 dx 12(floor(* ak 10)))(bufset-i16 dx 14(floor(* hc 10)))(bufset-u8 dx 16(floor(*(+ bg 0.5)100)))(bufset-f32 dx 17 bp'little-endian)(bufset-u8 dx 21(floor(* fd 2)))(bufset-u8 dx 22(floor(* el 2)))(bufset-u32 dx 23 ic)(bufset-u8 dx 27(floor(* be 2)))(bufset-i32 dx 28(cg'gy))(esp-now-send fu dx)(free dx)})(setq hg(secs-since 0))(setq fl(+ fl 0.05))(var ah(- fl(secs-since 0)))(if(> ah 0){(br ah)(setq fl(secs-since 0))})})})(defun ft()(loopwhile t(recv((event-esp-now-rx(? bw)(? em)(? dx)(? dw))(gp bw em dx dw))((event-data-rx .(? dx))(c dx))(_ nil))))(defun ez(ib value){(let((ew(assoc ch ib)))(if ew(loopforeach ea ch {(if(eq(car ea)ib)(setcdr ea(list(car(cdr ea))(car(cdr(cdr ea)))(car(cdr(cdr(cdr ea))))value)))})(setq ch(cons(cons ib(list 0'cn 0 value))ch))))})(defun gp(bw em dx dw){(if(= fa 2){(setq fu bw)(esp-now-add-peer fu)(var gi(bufcreate 4))(bufset-i32 gi 0(cg'gy))(esp-now-send fu gi)(free gi)(esp-now-del-peer fu)(atomic(pair-pubmote -1))}{(if(and(=(buflen dx)16)(=(bufget-i32 dx 0'little-endian)(cg'gy))){(setq cw(systime))(print(list"fk"bw em dx dw))(var jsx(bufget-f32 dx 4'little-endian))(var jsy(bufget-f32 dx 8'little-endian))(var bt-c(bufget-u8 dx 12))(var bt-z(bufget-u8 dx 13))(var is-rev(bufget-u8 dx 14))(print(list jsy jsx bt-c bt-z is-rev))(if(>=(cg'cj)0){(can-cmd(cg'cj)(str-replace(to-str(list jsy jsx bt-c bt-z is-rev))"(""(set-remote-state "))})})})})(defun br(x)(yield(* x 1000000)))@const-end(defun gx(u bz cb){(var ie(cg'ie))(var g(secs-since cy))(if(>(length cu)0){(if(=(cg'gz)0)(bj))})(var da(cg'ee))(setq bs(cg'fh))(var ie(cg'ie))(if(and(>= u ie)(<= g 1)){(setq da(cg'z))(setq bs(cg'cd))})(if(and(<=(secs-since 0)ie)(= bz 0))(setq da(cg'bh)))(if(and(>(length hj)0)(>(length ef)0)){(cond((= dq 15){(hz)(ej cu)(ej hj)})((and(> u(cg'ds))(< g 1)){(hz)})((and(or(= da 1)(= cb 1))(< g 1)){(dl hj)(dl ef)})((or(= da 0)(and(> g 1)(>(secs-since 0)ie))){(gj(if(>= bz 0)hj ef)0xFFFFFFFFu32)(gj(if(< bz 0)hj ef)0x00FF0000u32)})((= da 2){(gj(if(>= bz 0)hj ef)0x0000FFFFu32)(gj(if(< bz 0)hj ef)0x00FF00FFu32)})((= da 3){(gj(if(>= bz 0)hj ef)0x000000FFu32)(gj(if(< bz 0)hj ef)0x0000FF00u32)})((= da 4){(gj(if(>= bz 0)hj ef)0x00FFFF00u32)(gj(if(< bz 0)hj ef)0x0000FF00u32)})((= da 5){(ag)})((= da 6){(dv)})((= da 7){(dz 0)})((= da 8){(dz 1)})((= da 9){(dr)})((= da 10){(bu)}))(if(and(=(cg'ae)1)(<= hc(cg'by)))(ao))})})(defun k(){(var bf 5)(var fl(secs-since 0))(var gu 0)(var hg 0)(var en(bufcreate 64))(loopwhile-thd 100 t {(setq gu(secs-since 0))(if(>=(cg'fc)0){(var r(uart-read en(buflen en)nil nil 0.5))(if(> r 5){(var dj 0)(var db 0)(var eh 0)(var m 0)(var fp 0)(var i 0)(loopwhile(and(< i(- r 5))(not(and(= dj 1)(= db 1)(= eh 1)(= m 1)(= fp 1)))){(if(and(<(+ i 2)r)(=(bufget-u8 en i)0xFF)(=(bufget-u8 en(+ i 1))0x55)(=(bufget-u8 en(+ i 2))0xAA)){(setq gs(systime))(if(<(+ i 3)r){(var h(bufget-u8 en(+ i 3)))(var bb(+ i 4))(loopwhile(and(< bb(- r 2))(not(and(<(+ bb 2)r)(=(bufget-u8 en bb)0xFF)(=(bufget-u8 en(+ bb 1))0x55)(=(bufget-u8 en(+ bb 2))0xAA)))){(setq bb(+ bb 1))})(var hf(- bb i))(if(>= hf 6){(var dc(bufcreate hf))(bufcpy dc 0 en i hf)(if(>=(buflen dc)2){(var crc(bufget-u16 en(- bb 2)))(var ev 0)(looprange bd 0(-(buflen dc)2){(setq ev(+ ev(bufget-u8 dc bd)))})(if(eq crc ev){(cond((and(= h 2)(= db 0)){(setq db 1)(var s 0)(var fz 0)(looprange bd 4(-(buflen dc)4){(if(eq(mod bd 2)0){(if(and(= s 0)(=(cg'co)1)){(set-bms-val'bms-soc(/(aa(bufget-i16 dc bd))100.0))})(var fi(/(bufget-i16 dc bd)1000.0))(set-bms-val'bms-v-cell s fi)(setq s(+ s 1))(setq fz(+ fz fi))})})(set-bms-val'bms-v-tot fz)})((and(= h 3)(= eh 0)){(setq eh 1)(if(=(cg'co)0){(set-bms-val'bms-soc(/(bufget-u8 dc 4)100.0))})})((and(= h 5)(= fp 0)){(setq fp 1)(var gq 0.055)(var ap(*(bufget-i16 dc 4)gq))(set-bms-val'bms-i-in-ic ap)})((and(= h 0)(= dj 0)){(setq dj 1)})((and(= h 4)(= m 0)){(setq m 1)(set-bms-val'bms-temp-ic(bufget-i8 dc(-(buflen dc)3)))(looprange bd 4(-(buflen dc)3){(set-bms-val'bms-temps-adc(- bd 4)(bufget-i8 dc bd))})}))(setq i bb)})})(free dc)})(setq i bb)} {(setq i(+ i 1))})} {(setq i(+ i 1))})})(send-bms-can)}{ })(if(>=(cg'ig)0){(if(and(>(secs-since gs)bf)(<(secs-since cy)1)(or(= dq 0)(> dq 5))){(gpio-write(cg'ig)1)(br 0.1)(gpio-write(cg'ig)0)})})})(setq hg(secs-since 0))(setq fl(+ fl 0.05))(var ah(- fl(secs-since 0)))(if(> ah 0){(br ah)(setq fl(secs-since 0))})})})(ck)