@const-symbol-strings(def he -1)(def ev -1)(def bp -1)(def di -1)(def cb -1)(def e -1)(def ba -1)(def ab -1)(def hx -1)(def gw -1)(def bi -1)(def ho -1)(def gj -1)(def ds -1)(def cq -1)(def ht 1)(def au'())(def fa'())(def aj'())(def g 0)(def el -1)(def bk'())(def gg 31)(def hq 0)(def dr 0)(def ft 0)(def ay 0)(def q'(0xFF0000u32 0xFFFF00u32 0x00FF00u32 0x00FFFFu32 0x0000FFu32 0xFF00FFu32))(def gk'(0x00FFFF00 0x0000FF00 0x0000FFFF 0x000000FF 0x00FF00FF 0x00FF0000))(def aq 101)(def j 102)(def ge'((gr . 0)(cd . 10)(em . 24)(fk . 29)(fw . 202)))(def hf 0)(def ao 0)(def ia 0)(def ff 0)(def z 1)(def ad 0)(def ch 0)(def cr 0)(def cz [0 0 0 0 1 2 3 4 5 7 8 11 14 16 18 19 25 30 33 37 43 48 53 60 67 71 76 82 92 97 100])(def gq 422i32)(def id'((o .(0 i gq -1))(crc .(1 i 60967 -1))(cy .(2 i -1 -1))(ar .(3 b 1 -1))(er .(4 b 1 -1))(de .(5 i 0 -1))(ef .(6 i 5 -1))(cp .(7 i 0 -1))(dt .(8 i 5 -1))(fb .(9 b 1 -1))(n .(10 b 1 -1))(ez .(11 f -4.0 -1))(fc .(12 i 30 -1))(fh .(13 i 120 -1))(bg .(14 f 0.5 -1))(dp .(15 f 0.5 -1))(fs .(16 f 0.2 -1))(s .(17 f 0.5 -1))(h .(18 i -1 -1))(dx .(19 i 10 -1))(ei .(20 i 2 -1))(hw .(21 b 0 -1))(fx .(22 i 18 -1))(en .(23 i 13 -1))(fd .(24 i 2 -1))(hs .(25 b 0 -1))(dn .(26 b 1 -1))(ga .(27 i 17 -1))(hl .(28 i 13 -1))(ci .(29 i 2 -1))(gl .(30 b 0 -1))(ex .(31 b 1 -1))(ac .(32 i -1 -1))(cl .(33 i -1 -1))(fr .(34 i 1 -1))(dk .(35 i -1 -1))(fo .(36 i -1 -1))(bb .(37 i -1 -1))(hc .(38 i -1 -1))(cm .(39 i -1 -1))(et .(40 i -1 -1))(hn .(41 i -1 -1))))@const-start(defun hm(a){(var av(length a))(var gs(floor(/ av 4.0)))(var cs(floor(* av 3(/ 1 4.0))))(looprange i 0 av {(if(and(>= i gs)(< i cs)){(if(or(= i gs)(= i(- cs 1))){(setix a i 0x007F0000)} {(setix a i 0x00FF0000)})} {(setix a i 0x00000000)})})})(defun eh(){(setq hf(mod(+ hf 1)2))(var ak(if(= hf 0)0xFFFFFFFF 0x00000000))(k fa ak)(k aj ak)})(defun eg(){(setq ao(mod(+ ao 1)2))(k aj(if(= ao 0)0x00FF0000 0x00000000))})(defun ew(gd){(var gz(ix gk ia))(k fa(if(= gd 0)gz 0xFF000000))(k aj gz)(setq ia(mod(+ ia 1)6))})(defun max(da b)(if(> da b)da b))(defun min(da b)(if(< da b)da b))(defun cg(){(var ck(+(length fa)(length aj)))(looprange i 0 ck {(var bd(abs(- i ff)))(var ap(max 0(- 255(* bd 51))))(var ak(color-make ap 0 0))(if(< i(length fa))(setix fa i ak)(setix aj(- i(length fa))ak))})(setq ff(+ ff z))(if(or(>= ff ck)(< ff 0))(setq z(* z -1)))})(defun ct(ie){(var av(length ie))(var am(floor(* av g)))(looprange cc 0 av {(var fg 0)(var dy 0)(if(or(< cc am)(and(= cc 0)(<= am 1))){(if(or(< g 0.2)(and(= cc 0)(<= am 1))){(setq fg 255)(setq dy 0)} {(setq fg(floor(* 255(- 1(/ g 0.8)))))(setq dy(floor(* 255(/ g 0.8))))})} {(setq fg 0)(setq dy 0)})(var ak 0x00)(setq ak(bits-enc-int ak 16 fg 8))(setq ak(bits-enc-int ak 8 dy 8))(setix ie cc ak)})})(defun ic(){(var bq(length q))(looprange cc 0(length fa){(var fe(mod(+ ad cc(length fa))bq))(var ak(ix q fe))(setix fa cc ak)})(looprange cc 0(length aj){(var fe(mod(+ ad cc(length aj))bq))(var ak(ix q fe))(setix aj cc ak)})(setq ad(mod(+ ad 1)bq))})(defun gx(){(var bx(mod ch 3))(var en(length fa))(var hl(length aj))(var y(floor(/ en 2)))(var ee(floor(/ hl 2)))(cond((= bx 0){(looprange i 0 y(setix fa i 0x00000000))(looprange i y en(setix fa i 0x00FF0000))(looprange i 0 ee(setix aj i 0x00000000))(looprange i ee hl(setix aj i 0x00FF0000))})((= bx 1){(looprange i 0 y(setix fa i 0x00FF0000))(looprange i y en(setix fa i 0x000000FF))(looprange i 0 ee(setix aj i 0x00FF0000))(looprange i ee hl(setix aj i 0x000000FF))})((= bx 2){(looprange i 0 y(setix fa i 0x000000FF))(looprange i y en(setix fa i 0x00000000))(looprange i 0 ee(setix aj i 0x000000FF))(looprange i ee hl(setix aj i 0x00000000))}))(setq ch(mod(+ ch 1)3))})(defun es(){(if(> e 250.0){(fm)}{(if(and(!= cb 1)(!= cb 2)(!= cb 3)){(ct au)}{(gb cb)})})})(defun fm(){(var dx(length au))(var at(*(abs gw)1.1112))(var du 0.0)(if(< at 1.0){(setq du at)} {(setq du 1.0)})(var bl(floor(* du dx)))(var hg 0x00FFFF00u32)(if(>(abs gw)0.85){(setq hg 0x00FF0000u32)} {(if(>(abs gw)0.7){(setq hg 0x00FF8800u32)})})(looprange cc 0 dx {(setix au cc(if(< cc bl)hg 0x00000000u32))})})(defun gb(cb){(var dx(length au))(var dd(if(or(= cb 1)(= cb 3))0xFF 0x00))(var fz(if(or(= cb 2)(= cb 3))0xFF 0x00))(looprange cc 0 dx {(setix au cc(if(< cc(/ dx 2))dd fz))})})(defun k(a ak){(looprange cc 0(length a){(setix a cc ak)})})(defun dj(){(k au 0x00)(k fa 0x00)(k aj 0x00)})(defun ce(ie){(looprange cc 0(length ie){(var ak(color-split(ix ie cc)1))(var fp(color-make(ix ak 1)(ix ak 0)(ix ak 2)(ix ak 3)))(setix ie cc fp)})})(defun p(al){(if(=(an'hw)1){(setq au(reverse au))})(if(=(an'hs)1){(setq fa(reverse fa))})(if(=(an'gl)1){(setq aj(reverse aj))})(var er(an'er))(var dp(an'dp))(var h(an'h))(var fx(an'fx))(var ga(an'ga))(var dn(an'dn))(var ex(an'ex))(var dz(if(and(> al 0)(= er 0))(to-i(* 0xFF dp))0x00))(var bf(if(and(< al 0)(= er 0))(to-i(* 0xFF dp))0x00))(if(or(= dn 2)(= dn 3)){(setq fa(append(list dz)fa))})(if(or(= ex 2)(= ex 3)){(setq aj(append(list bf)aj))})(if(or(= dn 4)(= dn 5)){(var eu(take fa(length fa)))(setq fa(ib(+(length fa)4)0))(var bj 0)(looprange gm 0(length fa){(if(or(and(= dn 4)(or(= gm 2)(= gm 7)(= gm 13)(= gm 18)))(and(= dn 5)(or(= gm 1)(= gm 5)(= gm 10)(= gm 3)))){(setix fa gm dz)}{(setix fa gm(ix eu bj))(setq bj(+ bj 1))})})})(if(or(= ex 4)(= ex 5)){(var eu(take aj(length aj)))(setq aj(ib(+(length aj)4)0))(var bj 0)(looprange gm 0(length aj){(if(or(and(= ex 4)(or(= gm 2)(= gm 7)(= gm 13)(= gm 18)))(and(= ex 5)(or(= gm 1)(= gm 5)(= gm 10)(= gm 3)))){(setix aj gm bf)}{(setix aj gm(ix eu bj))(setq bj(+ bj 1))})})})(var ei(an'ei))(var fd(an'fd))(var ci(an'ci))(var en(length fa))(var hl(length aj))(if(and(>= fx 0)(= h fx)(= fx ga)){(var hd(append au fa aj))(var ck(length hd))(var c(rgbled-buffer ck ei))(rgbled-color c 0 hd ht)(if(not-eq(first(trap(rgbled-init fx fd)))'exit-ok){(cv'fx -1)(hh"Invalid Pin")(cf'fx -1)(cf'crc(gf))}{(bz 0.01)(rgbled-update eb)(bz 0.01)})(free c)} {(if(and(>= fx 0)(= fx ga)){(var hd(append fa aj))(var ck(length hd))(var c(rgbled-buffer ck fd))(rgbled-color c 0 hd ht)(if(not-eq(first(trap(rgbled-init fx fd)))'exit-ok){(cv'fx -1)(hh"Invalid Pin")(cf'fx -1)(cf'crc(gf))}{(bz 0.01)(rgbled-update eb)(bz 0.01)})(free c)}{(if(and(>= h 0)(= h ga)){(if(!= ei ci)(ce au))(var hd(append au aj))(var ck(length hd))(var c(rgbled-buffer ck ci))(rgbled-color c 0 hd ht)(if(not-eq(first(trap(rgbled-init h ei)))'exit-ok){(cv'h -1)(hh"Invalid Pin")(cf'h -1)(cf'crc(gf))}{(bz 0.01)(rgbled-update hi)(bz 0.01)})(free c)}{(if(>= h 0){(var hi(rgbled-buffer(length au)ei))(rgbled-color hi 0 au(an's))(if(not-eq(first(trap(rgbled-init h ei)))'exit-ok){(cv'h -1)(hh"Invalid Pin")(cf'h -1)(cf'crc(gf))}{(bz 0.01)(rgbled-update hi)(bz 0.01)})(free hi)})(if(>= ga 0){(var u(rgbled-buffer hl ei))(rgbled-color u 0 aj ht)(if(not-eq(first(trap(rgbled-init ga ci)))'exit-ok){(cv'ga -1)(hh"Invalid Pin")(cf'ga -1)(cf'crc(gf))}{(bz 0.01)(rgbled-update u)(bz 0.01)})(free u)})})(if(>= fx 0){(var eb(rgbled-buffer en ei))(rgbled-color eb 0 fa ht)(if(not-eq(first(trap(rgbled-init fx fd)))'exit-ok){(cv'fx -1)(hh"Invalid Pin")(cf'fx -1)(cf'crc(gf))}{(bz 0.01)(rgbled-update eb)(bz 0.01)})(free eb)})})})})(defunret dh(){(var gv'())(var bt(an'cy))(cv'cy -1)(var ep(systime))(loopwhile-thd 150(<=(secs-since ep)10){(if(and(>= bt 0)(<=(secs-since ep)5)){(setq gv(list bt))}{(setq gv(can-scan))})(loopforeach cy gv {(setq el cy)(gn cy(list(assoc ge'gr)))(bz 0.5)(if(>=(an'cy)0){(if(not-eq(an'cy)bt){(cf'cy(an'cy))(cf'crc(gf))})(return 1)})})})(return 0)})(defun gn(cy hz){(send-data(append(list aq)hz)2 cy)})(defun status (){(var az"status ")(setq az(str-merge az(str-from-n(if(<(secs-since ay)1)1 0)"%d ")))(setq az(str-merge az(str-from-n(if(<(secs-since hq)1)1 0)"%d ")))(setq az(str-merge az(str-from-n(if(<(secs-since dr)1)1 0)"%d ")))(send-data az)})(defun bv(){(var ac(an'ac))(var cl(an'cl))(uart-stop)(if(>= cl 0){(if(not-eq(first(trap(gpio-configure cl'pin-mode-out)))'exit-ok){(cv'cl -1)(hh"Invalid Pin")(cf'cl -1)(cf'crc(gf))})})(if(>= ac 0){(if(not-eq(first(trap(gpio-configure ac'pin-mode-in-pu)))'exit-ok){(cv'ac -1)(hh"Invalid Pin")(cf'ac -1)(cf'crc(gf))}{(uart-start 1 ac -1 115200)(set-bms-val'bms-cell-num 15)(set-bms-val'bms-temp-adc-num 4)(set-bms-val'bms-temp-cell-max 45)})})})(defunret an(af){(var gh(assoc id af))(if gh(return(car(cdr(cdr(cdr gh)))))(return nil))})(defun save-config(){(loopforeach bw id {(var af(first bw))(if(eq af'crc){(cf af(gf))}{(cf af(an af))})})(send-data"Settings Saved!")})(defunret gf(){(var i 0)(var cw(-(length id)1))(var fj(bufcreate cw))(loopforeach bw id {(var af(first bw))(if(not-eq af'crc){(bufset-i32 fj i(an af))(+ i 1)})})(var crc(crc16 fj))(free fj)(return crc)})(defun dg(){(loopforeach bw id {(var af(first bw))(var fy(cn af))(cv af fy)})})(defun restore-config(){(loopforeach bw id {(var af(first bw))(var ah(if(eq af'o)gq(ix bw 3)))(cf af ah)})(dg)(send-data"Settings Restored!")})(defun cn(af)(let((ea(first(assoc id af)))(gd(second(assoc id af))))(cond((eq gd'i)(eeprom-read-i ea))((eq gd'f)(eeprom-read-f ea))((eq gd'b)(eeprom-read-i ea)))))(defun cf(af fy)(let((ea(first(assoc id af)))(gd(second(assoc id af))))(cond((eq gd'i)(eeprom-store-i ea fy))((eq gd'f)(eeprom-store-f ea fy))((eq gd'b)(eeprom-store-i ea fy)))))(defun hh(bn)(send-data(str-merge"msg "bn)))(defun ib(ec fy)(map(fn(x)fy)(range ec)))(defun bo(){(if(!=(str-cmp(to-str(sysinfo'hw-type))"hw-express")0){(exit-error"gu running on hw-express")})(var dl(+(first(sysinfo'fw-ver))(*(second(sysinfo'fw-ver))0.01)))(if(< dl 6.05)(exit-error"hw-express ed dv by running 6.05"))(if(not-eq(cn'o)gq)(restore-config)(dg))(if(!=(gf)(to-i(cn'crc))){(hh"Error: crc corrupt")(restore-config)})(spawn ae)(event-register-handler(spawn dc))(event-enable'event-data-rx)(spawn dh)(if(=(conf-get'wifi-mode)0){(hh"WiFi is disabled. Please enable and reboot.")}{(event-enable'event-esp-now-rx)(setq bk(list(an'dk)(an'fo)(an'bb)(an'hc)(an'cm)(an'et)))(v bk)(spawn ca)})(bv)(spawn w)})(defun recv-config(ar er de ef cp dt fb n ez fc fh bg dp fs s h dx ei hw fx en fd hs dn ga hl ci gl ex ac cl fr){(cv'ar(to-i ar))(cv'er(to-i er))(cv'de(to-i de))(cv'ef(to-i ef))(cv'cp(to-i cp))(cv'dt(to-i dt))(cv'fb(to-i fb))(cv'n(to-i n))(cv'ez(to-float ez))(cv'fc(to-i fc))(cv'fh(to-i fh))(cv'bg(to-float bg))(cv'dp(to-float dp))(cv'fs(to-float fs))(cv's(to-float s))(cv'h(to-i h))(cv'dx(to-i dx))(cv'ei(to-i ei))(cv'hw(to-i hw))(cv'fx(to-i fx))(cv'en(to-i en))(cv'fd(to-i fd))(cv'hs(to-i hs))(cv'dn(to-i dn))(cv'ga(to-i ga))(cv'hl(to-i hl))(cv'ci(to-i ci))(cv'gl(to-i gl))(cv'ex(to-i ex))(var m(an'ac))(cv'ac(to-i ac))(var df(an'cl))(cv'cl(to-i cl))(cv'fr(to-i fr))(if(or(!=(to-i ac)m)(!=(to-i cl)df)){(bv)})})(defun fv(cu)(let((db(max 0(min(- cu 2700)(- 1500 1)))))(let((i(* db(/ 30.0 1500))))(let((bh(floor i)))(let((f(- i bh)))(let((da(bufget-u8 cz bh))(b(bufget-u8 cz(+ bh 1))))(max 0(min(round(+ da(* f(- b da))))100))))))))(defun dw(bc){(atomic {(if(and(>(buflen bc)1)(=(bufget-u8 bc 0)j)){(bufcpy bc 0 bc 1(-(buflen bc)1))(eval(read bc))})})(if(and(>(buflen bc)1)(=(bufget-u8 bc 0)aq)){(setq ay(systime))(match(cossa ge(bufget-u8 bc 1))(gr {(cv'cy el)})(fw {(var r(bufget-u8 bc 2))(cv'ar(bits-dec-int r 0 1))(cv'er(bits-dec-int r 1 1))})(em {(setq di(bufget-u8 bc 2))(setq he(bufget-u8 bc 3))(if(= di 3){(setq ev 0.0)(setq gw(bufget-u8 bc 4))}{(setq ev(to-float(bufget-i8 bc 4)))(setq gw 0.0)})(setq e(/(to-float(bufget-i16 bc 5))10))(setq hx(/(to-float(bufget-i16 bc 7))10))(setq ba(/(to-float(bufget-i16 bc 9))10))(cv'bg(/(bufget-u8 bc 11)100.0))(cv'fs(/(bufget-u8 bc 12)100.0))(cv's(/(bufget-u8 bc 13)100.0))})(fk {(setq g(/(bufget-u8 bc 2)100.0))})(cd {(var co(bufget-u8 bc 2))(if(= co 69){(setq he(bufget-u8 bc 3))} {(setq ev(/(to-float(bufget-i16 bc 5))10))(setq bp(/(to-float(bufget-i16 bc 7))10))(setq di(bufget-u8 bc 9))(setq cb(bufget-u8 bc 10))(setq ba(/(to-float(bufget-i16 bc 22))10))(setq e(to-float(bufget-i16 bc 24)))(setq ab(/(to-float(bufget-i16 bc 26))10))(setq hx(/(to-float(bufget-i16 bc 28))10))(setq gw(-(/(bufget-u8 bc 30)100.0)0.5))(if(>= co 2){(setq bi(bufget-f32 bc 34))(setq ho(/(bufget-u8 bc 38)2.0))(setq gj(/(bufget-u8 bc 39)2.0))})(if(>= co 3){(setq ds(bufget-u32 bc 41))(setq cq(/(bufget-u8 bc 53)2.0))})})})(_ nil))})(free bc)})(defun ae(){(var al 0)(var hu 0)(var bu(secs-since 0))(var fl 0)(var hv 0)(loopwhile-thd 100 t {(setq fl(secs-since 0))(var cy(an'cy))(gn cy(append(list(assoc ge'em))'(102 108 111 97 116 45 97 99 99 101 115 115 111 114 105 101 115 49 46 48 0)))(gn cy(list(assoc ge'fw)))(gn cy(list(assoc ge'fk)))(if(=(an'ar)1){(setq au(ib(an'dx)0))(setq fa(ib(an'en)0))(setq aj(ib(an'hl)0))(setq al 0)(var eo 10)(if(= di 4)(setq eo(*eo -1)))(if(> e eo){(setq al 1)})(if(< e(* eo -1)){(setq al -1)})(if(=(an'fb)1){(if(> ev 70)(setq hu 1)(setq hu 0))})(ha(secs-since ft)al hu)(if(or(!= al 0)(= hu 1)){(setq ft(systime))})} {(dj)})(p al)(setq bu(+ bu 0.1))(var aw(- bu(secs-since 0)))(if(> aw 0){(bz aw)(setq bu(secs-since 0))})})})(defun send-config(){(var cj"settings ")(loopforeach bw id {(let((af(first bw))(gd(third bw))){(var value(cn af))(setq cj(str-merge cj(cond((eq gd'b)(str-from-n value"%d "))((eq gd'i)(str-from-n value"%d "))((eq gd'f)(str-from-n value"%.2f ")))))})})(send-data cj)(send-data"Settings Read!")})(defun v(be){(esp-now-start)(esp-now-del-peer bk)(esp-now-add-peer bk)})(defun pair-pubmote(l){(if(=(conf-get'wifi-mode)0){(hh"WiFi is disabled. Please enable and reboot.")}{(cond((>= l 0){(cv'hn l)(setq gg(systime))(setq cr 1)})((= l -1){(v bk)(cf'dk(ix bk 0))(cf'fo(ix bk 1))(cf'bb(ix bk 2))(cf'hc(ix bk 3))(cf'cm(ix bk 4))(cf'et(ix bk 5))(cf'hn hn)(cf'crc(gf))(setq cr 0)})((= l -2){(setq bk'())(cf'dk -1)(cf'crc(gf))(setq cr 0)}))})})(defun ca(){(var bu(secs-since 0))(var fl 0)(var hv 0)(loopwhile-thd 100 t {(setq fl(secs-since 0))(if(and(>(secs-since gg)30)(>= cr 2)){(atomic(pair-pubmote -2))})(if(= cr 1){(esp-now-del-peer bk)(setq bk'(255 255 255 255 255 255))(esp-now-add-peer bk)(esp-now-send bk"42069")(esp-now-del-peer bk)(setq cr 2)})(if(and(= cr 0)(>=(an'dk)0)(<=(secs-since hq)5)(>=(an'cy)0)){(gn(an'cy)(list(assoc ge'cd)3))(var bc(bufcreate 32))(bufset-u8 bc 0 69)(bufset-u8 bc 1 he)(bufset-i16 bc 2(floor(* ev 10)))(bufset-i16 bc 4(floor(* bp 10)))(bufset-u8 bc 6 di)(bufset-u8 bc 7 cb)(bufset-i16 bc 8(floor(* ba 10)))(bufset-i16 bc 10(floor e))(bufset-i16 bc 12(floor(* ab 10)))(bufset-i16 bc 14(floor(* hx 10)))(bufset-u8 bc 16(floor(*(+ gw 0.5)100)))(bufset-f32 bc 17 bi'little-endian)(bufset-u8 bc 21(floor(* ho 2)))(bufset-u8 bc 22(floor(* gj 2)))(bufset-u32 bc 23 ds)(bufset-u8 bc 27(floor(* cq 2)))(bufset-i32 bc 28(an'hn))(esp-now-send bk bc)(free bc)})(setq hv(secs-since 0))(setq bu(+ bu 0.05))(var aw(- bu(secs-since 0)))(if(> aw 0){(bz aw)(setq bu(secs-since 0))})})})(defun dc()(loopwhile t(recv((event-esp-now-rx(? be)(? hy)(? bc)(? fq))(gp be hy bc fq))((event-data-rx .(? bc))(dw bc))(_ nil))))(defun cv(af value){(let((gh(assoc id af)))(if gh(loopforeach fi id {(if(eq(car fi)af)(setcdr fi(list(car(cdr fi))(car(cdr(cdr fi)))(car(cdr(cdr(cdr fi))))value)))})(setq id(cons(cons af(list 0'gd 0 value))id))))})(defun gp(be hy bc fq){(if(= cr 2){(setq bk be)(esp-now-add-peer bk)(esp-now-send bk(an'hn))(esp-now-del-peer bk)(setq cr 3)}{(if(and(=(buflen bc)15)(=(bufget-i32 bc 11)(an'hn))){(setq hq(systime))(var jsx(bufget-f32 bc 0'little-endian))(var jsy(bufget-f32 bc 4'little-endian))(var bt-c(bufget-u8 bc 8))(var bt-z(bufget-u8 bc 9))(var is-rev(bufget-u8 bc 10))(ej(an'cy)(hb(to-str(list jsy jsx bt-c bt-z is-rev))"(""(set-remote-state "))})})})(defun bz(x)(yield(* x 1000000)))@const-end(defun ha(gt al hu){(var fc(an'fc))(var gi(secs-since ay))(if(>(length au)0){(if(=(an'cp)0)(es))})(var dq(an'de))(setq ht(an'bg))(var fc(an'fc))(if(>= gi 1){(setq dq 0)}{(if(and(<=(secs-since 0)fc)(= al 0))(setq dq(an'dt)))(if(> gt fc){(setq dq(an'ef))(setq ht(an'fs))})})(if(and(>(length fa)0)(>(length aj)0)){(cond((= di 15){(dj)(hm au)(hm fa)})((and(> gt(an'fh))(< gi 1)){(dj)})((or(= dq 1)(= hu 1)){(ct fa)(ct aj)})((= dq 0){(k(if(>= al 0)fa aj)0xFFFFFFFFu32)(k(if(< al 0)fa aj)0x00FF0000u32)})((= dq 2){(k(if(>= al 0)fa aj)0x0000FFFFu32)(k(if(< al 0)fa aj)0x00FF00FFu32)})((= dq 3){(k(if(>= al 0)fa aj)0x000000FFu32)(k(if(< al 0)fa aj)0x0000FF00u32)})((= dq 4){(k(if(>= al 0)fa aj)0x00FFFF00u32)(k(if(< al 0)fa aj)0x0000FF00u32)})((= dq 5){(ic)})((= dq 6){(eh)})((= dq 7){(ew 0)})((= dq 8){(ew 1)})((= dq 9){(cg)})((= dq 10){(gx)}))(if(and(=(an'n)1)(<= hx(an'ez)))(eg))})})(defun w(){(var ey 5)(var bu(secs-since 0))(var fl 0)(var hv 0)(var cx(bufcreate 64))(loopwhile-thd 100 t {(setq fl(secs-since 0))(if(>=(an'ac)0){(var ai(uart-read cx(buflen cx)nil nil 0.5))(if(> ai 5){(var hj 0)(var aa 0)(var bs 0)(var ek 0)(var br 0)(var i 0)(loopwhile(and(< i(- ai 5))(not(and(= hj 1)(= aa 1)(= bs 1)(= ek 1)(= br 1)))){(if(and(<(+ i 2)ai)(=(bufget-u8 cx i)0xFF)(=(bufget-u8 cx(+ i 1))0x55)(=(bufget-u8 cx(+ i 2))0xAA)){(setq dr(systime))(if(<(+ i 3)ai){(var dm(bufget-u8 cx(+ i 3)))(var ax(+ i 4))(loopwhile(and(< ax(- ai 2))(not(and(<(+ ax 2)ai)(=(bufget-u8 cx ax)0xFF)(=(bufget-u8 cx(+ ax 1))0x55)(=(bufget-u8 cx(+ ax 2))0xAA)))){(setq ax(+ ax 1))})(var ec(- ax i))(if(>= ec 6){(var bm(bufcreate ec))(bufcpy bm 0 cx i ec)(if(>=(buflen bm)2){(var crc(bufget-u16 cx(- ax 2)))(var hp 0)(looprange gm 0(-(buflen bm)2){(setq hp(+ hp(bufget-u8 bm gm)))})(if(eq crc hp){(cond((and(= dm 2)(= aa 0)){(setq aa 1)(var hk 0)(var gy 0)(looprange gm 4(-(buflen bm)4){(if(eq(mod gm 2)0){(if(and(= hk 0)(=(an'fr)1)){(set-bms-val'bms-soc(/(fv(bufget-i16 bm gm))100.0))})(var hr(/(bufget-i16 bm gm)1000.0))(set-bms-val'bms-v-cell hk hr)(setq hk(+ hk 1))(setq gy(+ gy hr))})})(set-bms-val'bms-v-tot gy)})((and(= dm 3)(= bs 0)){(setq bs 1)(if(=(an'fr)0){(set-bms-val'bms-soc(/(bufget-u8 bm 4)100.0))})})((and(= dm 5)(= br 0)){(setq br 1)(var fu 0.055)(var ag(*(bufget-i16 bm 4)fu))(set-bms-val'bms-i-in-ic ag)})((and(= dm 0)(= hj 0)){(setq hj 1)})((and(= dm 4)(= ek 0)){(setq ek 1)(set-bms-val'bms-temp-ic(bufget-i8 bm(-(buflen bm)3)))(looprange gm 4(-(buflen bm)3){(set-bms-val'bms-temps-adc(- gm 4)(bufget-i8 bm gm))})}))(setq i ax)})})(free bm)})(setq i ax)} {(setq i(+ i 1))})} {(setq i(+ i 1))})})(send-bms-can)}{ })(if(>=(an'cl)0){(if(and(>(secs-since dr)ey)(<(secs-since ay)1)(or(= di 0)(> di 5))){(gpio-write(an'cl)1)(bz 0.1)(gpio-write(an'cl)0)})})})(setq hv(secs-since 0))(setq bu(+ bu 0.05))(var aw(- bu(secs-since 0)))(if(> aw 0){(bz aw)(setq bu(secs-since 0))})})})(bo)