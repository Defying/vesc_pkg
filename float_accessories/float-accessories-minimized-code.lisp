@const-symbol-strings(def v -1)(def hx -1)(def ar -1)(def fz -1)(def ep -1)(def bq -1)(def di -1)(def o -1)(def cu -1)(def bm -1)(def bb -1)(def bj -1)(def cg -1)(def bd -1)(def bc -1)(def ag 1)(def ie'())(def ao'())(def fu'())(def p 0)(def he -1)(def eb'())(def ff 31)(def cn 0)(def fy 0)(def ds 0)(def hp 0)(def hm'(0xFF0000u32 0xFFFF00u32 0x00FF00u32 0x00FFFFu32 0x0000FFu32 0xFF00FFu32))(def co'(0x00FFFF00 0x0000FF00 0x0000FFFF 0x000000FF 0x00FF00FF 0x00FF0000))(def cz 0)(def ae 420i32)(def be'((ht .(0 i ae -1))(crc .(1 i 60967 -1))(ee .(2 i -1 -1))(gd .(3 b 1 -1))(fb .(4 b 1 -1))(hh .(5 i 0 -1))(ac .(6 i 5 -1))(dj .(7 i 0 -1))(bh .(8 i 5 -1))(av .(9 b 1 -1))(ho .(10 b 1 -1))(ek .(11 f -4.0 -1))(ec .(12 i 30 -1))(gv .(13 i 120 -1))(hy .(14 f 0.5 -1))(io .(15 f 0.5 -1))(ej .(16 f 0.2 -1))(ch .(17 f 0.5 -1))(hu .(18 i -1 -1))(es .(19 i 10 -1))(hs .(20 i 2 -1))(ah .(21 b 0 -1))(dm .(22 i 18 -1))(fk .(23 i 13 -1))(ea .(24 i 2 -1))(gy .(25 b 0 -1))(ca .(26 b 0 -1))(bk .(27 i 17 -1))(ev .(28 i 13 -1))(dc .(29 i 2 -1))(hn .(30 b 0 -1))(eo .(31 b 0 -1))(aq .(32 i -1 -1))(fd .(33 i -1 -1))(ei .(34 i 1 -1))(gw .(35 i -1 -1))(eu .(36 i -1 -1))(ha .(37 i -1 -1))(bp .(38 i -1 -1))(aa .(39 i -1 -1))(gj .(40 i -1 -1))(fi .(41 i -1 -1))))@const-start(def gq 0)(defun ih(){(setq gq(mod(+ gq 1)2))(var cd(if(= gq 0)0xFFFFFFFF 0x00000000))(looprange i 0(length ao){(setix ao i cd)})(looprange i 0(length fu){(setix fu i cd)})})(def cc 0)(defun bi(){(setq cc(mod(+ cc 1)2))(var cd(if(= cc 0)0x00FF0000 0x00000000))(looprange i 0(length fu){(setix fu i cd)})})(def fq 0)(defun dw(){(var gz(ix co fq))(looprange i 0(length ao)(setix ao i gz))(looprange i 0(length fu)(setix fu i gz))(setq fq(mod(+ fq 1)6))})(def eg 0)(defun ez(){(var ci(bufget-u32 co(* eg 4)))(looprange i 0(length ao)(setix ao i 0xFFFFFFFF))(looprange i 0(length fu)(setix fu i ci))(setq eg(mod(+ eg 1)6))})(def fc 0)(def ay 1)(defun max(ba b)(if(> ba b)ba b))(defun min(ba b)(if(< ba b)ba b))(defun by(){(var at(+(length ao)(length fu)))(looprange i 0 at {(var al(abs(- i fc)))(var aj(max 0(- 255(* al 51))))(var cd(color-make aj 0 0))(if(< i(length ao))(setix ao i cd)(setix fu(- i(length ao))cd))})(setq fc(+ fc ay))(if(or(>= fc at)(< fc 0))(setq ay(* ay -1)))})(defun ik(bs){(var hk(length bs))(var dl(floor(* hk p)))(looprange gu 0 hk {(var hb 0)(var bf 0)(if(or(< gu dl)(and(= gu 0)(<= dl 1))){(if(or(< p 0.2)(and(= gu 0)(<= dl 1))){(setq hb 255)(setq bf 0)} {(setq hb(floor(* 255(- 1(/ p 0.8)))))(setq bf(floor(* 255(/ p 0.8))))})} {(setq hb 0)(setq bf 0)})(var cd 0x00)(setq cd(bits-enc-int cd 16 hb 8))(setq cd(bits-enc-int cd 8 bf 8))(setix bs gu cd)})})(def dp 0)(defun au(){(var br(length hm))(looprange gu 0(length ao){(var ck(mod(+ dp gu(length ao))br))(var cd(ix hm ck))(setix ao gu cd)})(looprange gu 0(length fu){(var ck(mod(+ dp gu(length fu))br))(var cd(ix hm ck))(setix fu gu cd)})(setq dp(mod(+ dp 1)br))})(def ef 0)(defun ed(){(var fj(mod ef 3))(var fk(length ao))(var ev(length fu))(var af(floor(/ fk 2)))(var gb(floor(/ ev 2)))(cond((= fj 0){(looprange i 0 af(setix ao i 0x00000000))(looprange i af fk(setix ao i 0x00FF0000))(looprange i 0 gb(setix fu i 0x00000000))(looprange i gb ev(setix fu i 0x00FF0000))})((= fj 1){(looprange i 0 af(setix ao i 0x00FF0000))(looprange i af fk(setix ao i 0x000000FF))(looprange i 0 gb(setix fu i 0x00FF0000))(looprange i gb ev(setix fu i 0x000000FF))})((= fj 2){(looprange i 0 af(setix ao i 0x000000FF))(looprange i af fk(setix ao i 0x00000000))(looprange i 0 gb(setix fu i 0x000000FF))(looprange i gb ev(setix fu i 0x00000000))}))(setq ef(mod(+ ef 1)3))})(defun ic(){(if(> bq 250.0){(cw)}{(if(and(!= ep 1)(!= ep 2)(!= ep 3)){(ik ie)}{(hi ep)})})})(defun cw(){(var es(length ie))(var er(*(abs bm)1.1112))(var el 0.0)(if(< er 1.0){(setq el er)} {(setq el 1.0)})(var dh(floor(* el es)))(var fa 0x00FFFF00u32)(if(>(abs bm)0.85){(setq fa 0x00FF0000u32)} {(if(>(abs bm)0.7){(setq fa 0x00FF8800u32)})})(looprange gu 0 es {(setix ie gu(if(< gu dh)fa 0x00000000u32))})})(defun hi(ep){(var es(length ie))(var hj(if(or(= ep 1)(= ep 3))0xFF 0x00))(var id(if(or(= ep 2)(= ep 3))0xFF 0x00))(looprange gu 0 es {(setix ie gu(if(< gu(/ es 2))hj id))})})(defun an(){(looprange gu 0(length ie){(setix ie gu 0x00)})(looprange gu 0(length ao){(setix ao gu 0x00)})(looprange gu 0(length fu){(setix fu gu 0x00)})})(defun eh(bs){(looprange gu 0(length bs){(var cd(color-split(ix bs gu)1))(var fg(color-make(ix cd 1)(ix cd 0)(ix cd 2)(ix cd 3)))(setix bs gu fg)})})(defun cl(ga){(if(=(q'ah)1){(setq ie(reverse ie))})(if(=(q'gy)1){(setq ao(reverse ao))})(if(=(q'hn)1){(setq fu(reverse fu))})(var fb(q'fb))(var io(q'io))(var hu(q'hu))(var dm(q'dm))(var bk(q'bk))(var ca(q'ca))(var eo(q'eo))(var cx(if(and(> ga 0)(= fb 0))(to-i(* 0xFF io))0x00))(var ii(if(and(< ga 0)(= fb 0))(to-i(* 0xFF io))0x00))(if(= ca 1){(setq ao(append(list cx)ao))})(if(= eo 1){(setq fu(append(list ii)fu))})(if(or(= ca 2)(= ca 3)){(var cq(take ao(length ao)))(setq ao(z(+(length ao)4)0))(var fp 0)(looprange hw 0(length ao){(if(or(and(= ca 2)(or(= hw 2)(= hw 7)(= hw 13)(= hw 18)))(and(= ca 3)(or(= hw 1)(= hw 5)(= hw 10)(= hw 3)))){(setix ao hw cx)}{(setix ao hw(ix cq fp))(setq fp(+ fp 1))})})})(if(or(= eo 2)(= eo 3)){(var cq(take fu(length fu)))(setq fu(z(+(length fu)4)0))(var fp 0)(looprange hw 0(length fu){(if(or(and(= eo 2)(or(= hw 2)(= hw 7)(= hw 13)(= hw 18)))(and(= eo 3)(or(= hw 1)(= hw 5)(= hw 10)(= hw 3)))){(setix fu hw ii)}{(setix fu hw(ix cq fp))(setq fp(+ fp 1))})})})(var hs(q'hs))(var ea(q'ea))(var dc(q'dc))(var fk(length ao))(var ev(length fu))(if(and(>= dm 0)(= hu dm)(= dm bk)){(var n(append ie ao fu))(var at(length n))(var fm(rgbled-buffer at hs))(rgbled-color fm 0 n ag)(if(not-eq(first(trap(rgbled-init dm ea)))'exit-ok){(a'dm -1)(am"Invalid Pin")(hd'dm -1)(hd'crc(ew))}{(fv 0.01)(rgbled-update il)(fv 0.01)})(free fm)} {(if(and(>= dm 0)(= dm bk)){(var n(append ao fu))(var at(length n))(var fm(rgbled-buffer at ea))(rgbled-color fm 0 n ag)(if(not-eq(first(trap(rgbled-init dm ea)))'exit-ok){(a'dm -1)(am"Invalid Pin")(hd'dm -1)(hd'crc(ew))}{(fv 0.01)(rgbled-update il)(fv 0.01)})(free fm)}{(if(and(>= hu 0)(= hu bk)){(if(!= hs dc)(eh ie))(var n(append ie fu))(var at(length n))(var fm(rgbled-buffer at dc))(rgbled-color fm 0 n ag)(if(not-eq(first(trap(rgbled-init hu hs)))'exit-ok){(a'hu -1)(am"Invalid Pin")(hd'hu -1)(hd'crc(ew))}{(fv 0.01)(rgbled-update hq)(fv 0.01)})(free fm)}{(if(>= hu 0){(var hq(rgbled-buffer(length ie)hs))(rgbled-color hq 0 ie(q'ch))(if(not-eq(first(trap(rgbled-init hu hs)))'exit-ok){(a'hu -1)(am"Invalid Pin")(hd'hu -1)(hd'crc(ew))}{(fv 0.01)(rgbled-update hq)(fv 0.01)})(free hq)})(if(>= bk 0){(var dn(rgbled-buffer ev hs))(rgbled-color dn 0 fu ag)(if(not-eq(first(trap(rgbled-init bk dc)))'exit-ok){(a'bk -1)(am"Invalid Pin")(hd'bk -1)(hd'crc(ew))}{(fv 0.01)(rgbled-update dn)(fv 0.01)})(free dn)})})(if(>= dm 0){(var il(rgbled-buffer fk hs))(rgbled-color il 0 ao ag)(if(not-eq(first(trap(rgbled-init dm ea)))'exit-ok){(a'dm -1)(am"Invalid Pin")(hd'dm -1)(hd'crc(ew))}{(fv 0.01)(rgbled-update il)(fv 0.01)})(free il)})})})})(defunret ct(){(var ij'())(var ft(q'ee))(a'ee -1)(var w(systime))(loopwhile-thd 150(<=(secs-since w)10){(if(and(>= ft 0)(<=(secs-since w)5)){(setq ij(list ft))}{(setq ij(can-scan))})(loopforeach ee ij {(setq he ee)(hv ee(list(assoc bw'ey)))(fv 0.5)(if(>=(q'ee)0){(if(not-eq(q'ee)ft){(hd'ee(q'ee))(hd'crc(ew))})(return 1)})})})(return 0)})(def bv 101)(def dk 102)(def bw'((ey . 0)(az . 10)(ap . 24)(fe . 29)(cb . 202)))(defun hv(ee g){(send-data(append(list bv)g)2 ee)})(defun status (){(var fw"status ")(setq fw(str-merge fw(str-from-n(if(<(secs-since hp)1)1 0)"%d ")))(setq fw(str-merge fw(str-from-n(if(<(secs-since cn)1)1 0)"%d ")))(setq fw(str-merge fw(str-from-n(if(<(secs-since fy)1)1 0)"%d ")))(send-data fw)})(defun ab(){(var aq(q'aq))(var fd(q'fd))(uart-stop)(if(>= fd 0){(if(not-eq(first(trap(gpio-configure fd'pin-mode-out)))'exit-ok){(a'fd -1)(am"Invalid Pin")(hd'fd -1)(hd'crc(ew))})})(if(>= aq 0){(if(not-eq(first(trap(gpio-configure aq'pin-mode-in-pu)))'exit-ok){(a'aq -1)(am"Invalid Pin")(hd'aq -1)(hd'crc(ew))}{(uart-start 1 aq -1 115200)(set-bms-val'bms-cell-num 15)(set-bms-val'bms-temp-adc-num 4)(set-bms-val'bms-temp-cell-max 45)})})})(defunret q(bt){(var fl(assoc be bt))(if fl(return(car(cdr(cdr(cdr fl)))))(return nil))})(defun save-config(){(loopforeach h be {(var bt(first h))(if(eq bt'crc){(hd bt(ew))}{(hd bt(q bt))})})(send-data"Settings Saved!")})(defunret ew(){(var i 0)(var ad(-(length be)1))(var im(bufcreate ad))(loopforeach h be {(var bt(first h))(if(not-eq bt'crc){(bufset-i32 im i(q bt))(+ i 1)})})(var crc(crc16 im))(free im)(return crc)})(defun en(){(loopforeach h be {(var bt(first h))(var u(ib bt))(a bt u)})})(defun restore-config(){(loopforeach h be {(var bt(first h))(var dv(if(eq bt'ht)ae(ix h 3)))(hd bt dv)})(en)(send-data"Settings Restored!")})(defun ib(bt)(let((cf(first(assoc be bt)))(em(second(assoc be bt))))(cond((eq em'i)(eeprom-read-i cf))((eq em'f)(eeprom-read-f cf))((eq em'b)(eeprom-read-i cf)))))(defun hd(bt u)(let((cf(first(assoc be bt)))(em(second(assoc be bt))))(cond((eq em'i)(eeprom-store-i cf u))((eq em'f)(eeprom-store-f cf u))((eq em'b)(eeprom-store-i cf u)))))(defun am(dr)(send-data(str-merge"msg "dr)))(defun z(ex u)(map(fn(x)u)(range ex)))(defun fh(ga j gk){(var ai(if(< ga 0)j gk))(var de(if(< ga 0)gk j))(looprange gu 0(length ao){(setix ao gu de)})(looprange gu 0(length fu){(setix fu gu ai)})})(defun bz(){(if(!=(str-cmp(to-str(sysinfo'hw-type))"hw-express")0){(exit-error"hf running on hw-express")})(def bn(+(first(sysinfo'fw-ver))(*(second(sysinfo'fw-ver))0.01)))(if(< bn 6.05)(exit-error"hw-express fs k bx running 6.05"))(if(not-eq(ib'ht)ae)(restore-config)(en))(if(!=(ew)(to-i(ib'crc))){(am"Error: crc corrupt")(restore-config)})(spawn bl)(event-register-handler(spawn aw))(event-enable'event-data-rx)(spawn ct)(if(=(conf-get'wifi-mode)0){(am"WiFi is disabled. Please enable and reboot.")}{(event-enable'event-esp-now-rx)(setq eb(list(q'gw)(q'eu)(q'ha)(q'bp)(q'aa)(q'gj)))(hr eb)(spawn cy)})(ab)(spawn gf)})(defun recv-config(gd fb hh ac dj bh av ho ek ec gv hy io ej ch hu es hs ah dm fk ea gy ca bk ev dc hn eo aq fd ei){(a'gd(to-i gd))(a'fb(to-i fb))(a'hh(to-i hh))(a'ac(to-i ac))(a'dj(to-i dj))(a'bh(to-i bh))(a'av(to-i av))(a'ho(to-i ho))(a'ek(to-float ek))(a'ec(to-i ec))(a'gv(to-i gv))(a'hy(to-float hy))(a'io(to-float io))(a'ej(to-float ej))(a'ch(to-float ch))(a'hu(to-i hu))(a'es(to-i es))(a'hs(to-i hs))(a'ah(to-i ah))(a'dm(to-i dm))(a'fk(to-i fk))(a'ea(to-i ea))(a'gy(to-i gy))(a'ca(to-i ca))(a'bk(to-i bk))(a'ev(to-i ev))(a'dc(to-i dc))(a'hn(to-i hn))(a'eo(to-i eo))(var dz(q'aq))(a'aq(to-i aq))(var gx(q'fd))(a'fd(to-i fd))(a'ei(to-i ei))(if(or(!=(to-i aq)dz)(!=(to-i fd)gx)){(ab)})})(def da [0 0 0 0 1 2 3 4 5 7 8 11 14 16 18 19 25 30 33 37 43 48 53 60 67 71 76 82 92 97 100])(defun m(gg)(let((dy(max 0(min(- gg 2700)(- 1500 1)))))(let((i(* dy(/ 30.0 1500))))(let((gp(floor i)))(let((f(- i gp)))(let((ba(bufget-u8 da gp))(b(bufget-u8 da(+ gp 1))))(max 0(min(round(+ ba(* f(- b ba))))100))))))))(defun bo(et){(atomic {(if(and(>(buflen et)1)(=(bufget-u8 et 0)dk)){(bufcpy et 0 et 1(-(buflen et)1))(eval(read et))})})(if(and(>(buflen et)1)(=(bufget-u8 et 0)bv)){(setq hp(systime))(match(cossa bw(bufget-u8 et 1))(ey {(a'ee he)})(cb {(var l(bufget-u8 et 2))(a'gd(bits-dec-int l 0 1))(a'fb(bits-dec-int l 1 1))})(ap {(setq fz(bufget-u8 et 2))(setq v(bufget-u8 et 3))(if(= fz 3){(setq hx 0.0)(setq bm(bufget-u8 et 4))}{(setq hx(to-float(bufget-i8 et 4)))(setq bm 0.0)})(setq bq(/(to-float(bufget-i16 et 5))10))(setq cu(/(to-float(bufget-i16 et 7))10))(setq di(/(to-float(bufget-i16 et 9))10))(a'hy(/(bufget-u8 et 11)100.0))(a'ej(/(bufget-u8 et 12)100.0))(a'ch(/(bufget-u8 et 13)100.0))})(fe {(setq p(/(bufget-u8 et 2)100.0))})(az {(var hc(bufget-u8 et 2))(if(= hc 69){(setq v(bufget-u8 et 3))} {(setq hx(/(to-float(bufget-i16 et 5))10))(setq ar(/(to-float(bufget-i16 et 7))10))(setq fz(bufget-u8 et 9))(setq ep(bufget-u8 et 10))(setq di(/(to-float(bufget-i16 et 22))10))(setq bq(to-float(bufget-i16 et 24)))(setq o(/(to-float(bufget-i16 et 26))10))(setq cu(/(to-float(bufget-i16 et 28))10))(setq bm(-(/(bufget-u8 et 30)100.0)0.5))(if(>= hc 2){(setq bb(bufget-f32 et 34))(setq bj(/(bufget-u8 et 38)2.0))(setq cg(/(bufget-u8 et 39)2.0))})(if(>= hc 3){(setq bd(bufget-u32 et 41))(setq bc(/(bufget-u8 et 53)2.0))})})})(_ nil))})(free et)})(defun bl(){(var ga 0)(var dg 0)(var ax 1)(var gh(systime))(var dd 0)(var gr 0)(var gi(secs-since 0))(var df 0)(var y 0)(loopwhile-thd 100 t {(setq df(secs-since 0))(var ee(q'ee))(hv ee(append(list(assoc bw'ap))'(102 108 111 97 116 45 97 99 99 101 115 115 111 114 105 101 115 49 46 48 0)))(hv ee(list(assoc bw'cb)))(hv ee(list(assoc bw'fe)))(if(=(q'gd)1){(setq ie(z(q'es)0))(setq ao(z(q'fk)0))(setq fu(z(q'ev)0))(setq ga 0)(var cj 10)(if(= fz 4)(setq cj(*cj -1)))(if(> bq cj){(setq ga 1)})(if(< bq(* cj -1)){(setq ga -1)})(if(=(q'av)1){(if(> hx 70)(setq gr 1)(setq gr 0))})(if(= cz 1){(setq ga 0)(a'ec 10)(a'gv 20)(if(<(secs-since gh)(q'ec)){(setq ga ax)(setq ax(* ax -1))})})(gm(secs-since ds)dg ga dd gr)(setq dg ga)(if(or(!= ga 0)(= gr 1)){(setq dd 0)(setq ds(systime))})(if(< dd 2)(cl ga))} {(an)(cl ga)})(setq gi(+ gi 0.1))(var s(- gi(secs-since 0)))(if(> s 0){(fv s)(setq gi(secs-since 0))})})})(defun send-config(){(var ce"settings ")(loopforeach h be {(let((bt(first h))(em(third h))){(var value(ib bt))(setq ce(str-merge ce(cond((eq em'b)(str-from-n value"%d "))((eq em'i)(str-from-n value"%d "))((eq em'f)(str-from-n value"%.2f ")))))})})(send-data ce)(send-data"Settings Read!")})(defun hr(bu){(esp-now-start)(esp-now-del-peer eb)(esp-now-add-peer eb)})(def hl 0)(defun pair-pubmote(gl){(if(=(conf-get'wifi-mode)0){(am"WiFi is disabled. Please enable and reboot.")}{(cond((>= gl 0){(a'fi gl)(setq ff(systime))(setq hl 1)})((= gl -1){(hr eb)(hd'gw(ix eb 0))(hd'eu(ix eb 1))(hd'ha(ix eb 2))(hd'bp(ix eb 3))(hd'aa(ix eb 4))(hd'gj(ix eb 5))(hd'fi fi)(hd'crc(ew))(setq hl 0)})((= gl -2){(setq eb'())(hd'gw -1)(hd'crc(ew))(setq hl 0)}))})})(defun cy(){(var gi(secs-since 0))(var df 0)(var y 0)(loopwhile-thd 100 t {(setq df(secs-since 0))(if(and(>(secs-since ff)30)(>= hl 2)){(atomic(pair-pubmote -2))})(if(= hl 1){(esp-now-del-peer eb)(setq eb'(255 255 255 255 255 255))(esp-now-add-peer eb)(esp-now-send eb"42069")(esp-now-del-peer eb)(setq hl 2)})(if(and(= hl 0)(>=(q'gw)0)(<=(secs-since cn)5)(>=(q'ee)0)){(hv(q'ee)(list(assoc bw'az)3))(var et(bufcreate 32))(bufset-u8 et 0 69)(bufset-u8 et 1 v)(bufset-i16 et 2(floor(* hx 10)))(bufset-i16 et 4(floor(* ar 10)))(bufset-u8 et 6 fz)(bufset-u8 et 7 ep)(bufset-i16 et 8(floor(* di 10)))(bufset-i16 et 10(floor bq))(bufset-i16 et 12(floor(* o 10)))(bufset-i16 et 14(floor(* cu 10)))(bufset-u8 et 16(floor(*(+ bm 0.5)100)))(bufset-f32 et 17 bb'little-endian)(bufset-u8 et 21(floor(* bj 2)))(bufset-u8 et 22(floor(* cg 2)))(bufset-u32 et 23 bd)(bufset-u8 et 27(floor(* bc 2)))(bufset-i32 et 28(q'fi))(esp-now-send eb et)(free et)})(setq y(secs-since 0))(setq gi(+ gi 0.05))(var s(- gi(secs-since 0)))(if(> s 0){(fv s)(setq gi(secs-since 0))})})})(defun aw()(loopwhile t(recv((event-esp-now-rx(? bu)(? ak)(? et)(? bg))(e bu ak et bg))((event-data-rx .(? et))(bo et))(_ nil))))(defun a(bt value){(let((fl(assoc be bt)))(if fl(loopforeach fo be {(if(eq(car fo)bt)(setcdr fo(list(car(cdr fo))(car(cdr(cdr fo)))(car(cdr(cdr(cdr fo))))value)))})(setq be(cons(cons bt(list 0'em 0 value))be))))})@const-end(defun e(bu ak et bg){(if(= hl 2){(setq eb bu)(esp-now-add-peer eb)(esp-now-send eb(q'fi))(esp-now-del-peer eb)(setq hl 3)}{(if(and(=(buflen et)15)(=(bufget-i32 et 11)(q'fi))){(setq cn(systime))(var jsx(bufget-f32 et 0'little-endian))(var jsy(bufget-f32 et 4'little-endian))(var bt-c(bufget-u8 et 8))(var bt-z(bufget-u8 et 9))(var is-rev(bufget-u8 et 10))(cp(q'ee)(c(to-str(list jsy jsx bt-c bt-z is-rev))"(""(set-remote-state "))})})(free et)})(defun fv(x)(yield(* x 1000000)))(defun gm(dt dg ga dd gr){(var ec(q'ec))(var hg(secs-since hp))(if(or(> hg ec)(< dt(q'gv))){(if(>(length ie)0){(if(=(q'dj)0)(ic))})(var gs(q'hh))(setq ag(q'hy))(var ec(q'ec))(if(>= hg ec){(setq gs 0)}{(if(and(<=(secs-since 0)ec)(= ga 0))(setq gs(q'bh)))(if(> dt ec){(setq gs(q'ac))(setq ag(q'ej))})})(var j 0x00)(var gk 0x00)(if(and(>(length ao)0)(>(length fu)0)){(cond((or(= gs 1)(= gr 1)){(ik ao)(ik fu)})((= gs 0){(setq j 0xFFFFFFFFu32)(setq gk 0x00FF0000u32)(fh ga j gk)})((= gs 2){(setq j 0xFF00FFFFu32)(setq gk 0x00FF00FFu32)(fh ga j gk)})((= gs 3){(setq j 0xFF0000FFu32)(setq gk 0x0000FF00u32)(fh ga j gk)})((= gs 4){(setq j 0xFFFFFF00u32)(setq gk 0x0000FF00u32)(fh ga j gk)})((= gs 5){(au)})((= gs 6){(ih)})((= gs 7){(dw)})((= gs 8){(ez)})((= gs 9){(by)})((= gs 10){(ed)}))(if(and(=(q'ho)1)(<= cu(q'ek)))(bi))})} {(if(< dd 2){(an)(setq dd(+ dd 1))})})})(defun gf(){(var fr 5)(var gi(secs-since 0))(var df 0)(var y 0)(var db(bufcreate 64))(loopwhile-thd 100 t {(setq df(secs-since 0))(if(>=(q'aq)0){(var du(uart-read db(buflen db)nil nil 0.5))(if(> du 5){(var fx 0)(var ia 0)(var hz 0)(var cr 0)(var dq 0)(var i 0)(loopwhile(and(< i(- du 5))(not(and(= fx 1)(= ia 1)(= hz 1)(= cr 1)(= dq 1)))){(if(and(<(+ i 2)du)(=(bufget-u8 db i)0xFF)(=(bufget-u8 db(+ i 1))0x55)(=(bufget-u8 db(+ i 2))0xAA)){(setq fy(systime))(if(<(+ i 3)du){(var cv(bufget-u8 db(+ i 3)))(var ge(+ i 4))(loopwhile(and(< ge(- du 2))(not(and(<(+ ge 2)du)(=(bufget-u8 db ge)0xFF)(=(bufget-u8 db(+ ge 1))0x55)(=(bufget-u8 db(+ ge 2))0xAA)))){(setq ge(+ ge 1))})(var ex(- ge i))(if(>= ex 6){(var ig(bufcreate ex))(bufcpy ig 0 db i ex)(if(>=(buflen ig)2){(var crc(bufget-u16 db(- ge 2)))(var r 0)(looprange hw 0(-(buflen ig)2){(setq r(+ r(bufget-u8 ig hw)))})(if(eq crc r){(cond((and(= cv 2)(= ia 0)){(setq ia 1)(var gt 0)(var cs 0)(looprange hw 4(-(buflen ig)4){(if(eq(mod hw 2)0){(if(and(= gt 0)(=(q'ei)1)){(set-bms-val'bms-soc(/(m(bufget-i16 ig hw))100.0))})(var gn(/(bufget-i16 ig hw)1000.0))(set-bms-val'bms-v-cell gt gn)(setq gt(+ gt 1))(setq cs(+ cs gn))})})(set-bms-val'bms-v-tot cs)})((and(= cv 3)(= hz 0)){(setq hz 1)(if(=(q'ei)0){(set-bms-val'bms-soc(/(bufget-u8 ig 4)100.0))})})((and(= cv 5)(= dq 0)){(setq dq 1)(var cm 0.055)(var dx(*(bufget-i16 ig 4)cm))(set-bms-val'bms-i-in-ic dx)})((and(= cv 0)(= fx 0)){(setq fx 1)})((and(= cv 4)(= cr 0)){(setq cr 1)(set-bms-val'bms-temp-ic(bufget-i8 ig(-(buflen ig)3)))(looprange hw 4(-(buflen ig)3){(set-bms-val'bms-temps-adc(- hw 4)(bufget-i8 ig hw))})}))(setq i ge)})})(free ig)})(setq i ge)} {(setq i(+ i 1))})} {(setq i(+ i 1))})})(send-bms-can)}{ })(if(>=(q'fd)0){(if(and(>(secs-since fy)fr)(<(secs-since hp)1)(or(= fz 0)(> fz 5))){(gpio-write(q'fd)1)(fv 0.1)(gpio-write(q'fd)0)})})})(setq y(secs-since 0))(setq gi(+ gi 0.05))(var s(- gi(secs-since 0)))(if(> s 0){(fv s)(setq gi(secs-since 0))})})})(bz)