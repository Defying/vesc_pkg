@const-symbol-strings(def dc -1)(def bm -1)(def av -1)(def br -1)(def aa -1)(def hx -1)(def m -1)(def aj -1)(def el -1)(def dh -1)(def bn -1)(def ei -1)(def fj -1)(def fl -1)(def dk -1)(def ey 1)(def dp'())(def gh'())(def cy'())(def dd 0)(def bx -1)(def fs'())(def cv 31)(def ce 0)(def cd 0)(def dv 0)(def g 0)(def fw'(0xFF0000u32 0xFFFF00u32 0x00FF00u32 0x00FFFFu32 0x0000FFu32 0xFF00FFu32))(def al'(0x00FFFF00 0x0000FF00 0x0000FFFF 0x000000FF 0x00FF00FF 0x00FF0000))(def gi 420i32)(def cf'((cn .(0 i gi -1))(crc .(1 i 60967 -1))(bt .(2 i -1 -1))(eo .(3 b 1 -1))(dn .(4 b 1 -1))(gy .(5 i 0 -1))(hl .(6 i 5 -1))(ej .(7 i 0 -1))(ai .(8 i 5 -1))(aw .(9 b 1 -1))(ba .(10 b 1 -1))(ef .(11 f -4.0 -1))(y .(12 i 30 -1))(fo .(13 i 120 -1))(ck .(14 f 0.5 -1))(s .(15 f 0.5 -1))(bl .(16 f 0.2 -1))(ae .(17 f 0.5 -1))(ew .(18 i -1 -1))(gg .(19 i 10 -1))(gb .(20 i 2 -1))(dw .(21 b 0 -1))(ci .(22 i 18 -1))(fd .(23 i 13 -1))(fa .(24 i 2 -1))(ib .(25 b 0 -1))(ha .(26 b 0 -1))(cg .(27 i 17 -1))(fe .(28 i 13 -1))(hs .(29 i 2 -1))(ht .(30 b 0 -1))(gp .(31 b 0 -1))(hb .(32 i -1 -1))(gw .(33 i -1 -1))(gm .(34 i 1 -1))(eg .(35 i -1 -1))(hw .(36 i -1 -1))(gn .(37 i -1 -1))(ft .(38 i -1 -1))(cp .(39 i -1 -1))(ez .(40 i -1 -1))(gk .(41 i -1 -1))))@const-start(def bb 0)(defun az(){(setq bb(mod(+ bb 1)2))(var dt(if(= bb 0)0xFFFFFFFF 0x00000000))(looprange i 0(length gh){(setix gh i dt)})(looprange i 0(length cy){(setix cy i dt)})})(def fx 0)(defun dr(){(setq fx(mod(+ fx 1)2))(looprange i 0(length cy){(setix cy i(if(= fx 0)0x00FF0000 0x00000000))})})(def a 0)(defun dz(ed){(var h(ix al a))(looprange i 0(length gh)(setix gh i(if(= ed 0)h 0xFF000000)))(looprange i 0(length cy)(setix cy i h))(setq a(mod(+ a 1)6))})(def cm 0)(def af 1)(defun max(ic b)(if(> ic b)ic b))(defun min(ic b)(if(< ic b)ic b))(defun ga(){(var cj(+(length gh)(length cy)))(looprange i 0 cj {(var bv(abs(- i cm)))(var j(max 0(- 255(* bv 51))))(var dt(color-make j 0 0))(if(< i(length gh))(setix gh i dt)(setix cy(- i(length gh))dt))})(setq cm(+ cm af))(if(or(>= cm cj)(< cm 0))(setq af(* af -1)))})(defun o(k){(var ay(length k))(var dg(floor(* ay dd)))(looprange am 0 ay {(var ex 0)(var an 0)(if(or(< am dg)(and(= am 0)(<= dg 1))){(if(or(< dd 0.2)(and(= am 0)(<= dg 1))){(setq ex 255)(setq an 0)} {(setq ex(floor(* 255(- 1(/ dd 0.8)))))(setq an(floor(* 255(/ dd 0.8))))})} {(setq ex 0)(setq an 0)})(var dt 0x00)(setq dt(bits-enc-int dt 16 ex 8))(setq dt(bits-enc-int dt 8 an 8))(setix k am dt)})})(def ev 0)(defun fu(){(var en(length fw))(looprange am 0(length gh){(var ah(mod(+ ev am(length gh))en))(var dt(ix fw ah))(setix gh am dt)})(looprange am 0(length cy){(var ah(mod(+ ev am(length cy))en))(var dt(ix fw ah))(setix cy am dt)})(setq ev(mod(+ ev 1)en))})(def et 0)(defun dy(){(var q(mod et 3))(var fd(length gh))(var fe(length cy))(var au(floor(/ fd 2)))(var r(floor(/ fe 2)))(cond((= q 0){(looprange i 0 au(setix gh i 0x00000000))(looprange i au fd(setix gh i 0x00FF0000))(looprange i 0 r(setix cy i 0x00000000))(looprange i r fe(setix cy i 0x00FF0000))})((= q 1){(looprange i 0 au(setix gh i 0x00FF0000))(looprange i au fd(setix gh i 0x000000FF))(looprange i 0 r(setix cy i 0x00FF0000))(looprange i r fe(setix cy i 0x000000FF))})((= q 2){(looprange i 0 au(setix gh i 0x000000FF))(looprange i au fd(setix gh i 0x00000000))(looprange i 0 r(setix cy i 0x000000FF))(looprange i r fe(setix cy i 0x00000000))}))(setq et(mod(+ et 1)3))})(defun ih(){(if(> hx 250.0){(cq)}{(if(and(!= aa 1)(!= aa 2)(!= aa 3)){(o dp)}{(v aa)})})})(defun cq(){(var gg(length dp))(var ec(*(abs dh)1.1112))(var hz 0.0)(if(< ec 1.0){(setq hz ec)} {(setq hz 1.0)})(var cu(floor(* hz gg)))(var hr 0x00FFFF00u32)(if(>(abs dh)0.85){(setq hr 0x00FF0000u32)} {(if(>(abs dh)0.7){(setq hr 0x00FF8800u32)})})(looprange am 0 gg {(setix dp am(if(< am cu)hr 0x00000000u32))})})(defun v(aa){(var gg(length dp))(var fp(if(or(= aa 1)(= aa 3))0xFF 0x00))(var ac(if(or(= aa 2)(= aa 3))0xFF 0x00))(looprange am 0 gg {(setix dp am(if(< am(/ gg 2))fp ac))})})(defun ep(){(looprange am 0(length dp){(setix dp am 0x00)})(looprange am 0(length gh){(setix gh am 0x00)})(looprange am 0(length cy){(setix cy am 0x00)})})(defun gq(k){(looprange am 0(length k){(var dt(color-split(ix k am)1))(var fz(color-make(ix dt 1)(ix dt 0)(ix dt 2)(ix dt 3)))(setix k am fz)})})(defun fc(ar){(if(=(ax'dw)1){(setq dp(reverse dp))})(if(=(ax'ib)1){(setq gh(reverse gh))})(if(=(ax'ht)1){(setq cy(reverse cy))})(var dn(ax'dn))(var s(ax's))(var ew(ax'ew))(var ci(ax'ci))(var cg(ax'cg))(var ha(ax'ha))(var gp(ax'gp))(var hq(if(and(> ar 0)(= dn 0))(to-i(* 0xFF s))0x00))(var dx(if(and(< ar 0)(= dn 0))(to-i(* 0xFF s))0x00))(if(= ha 1){(setq gh(append(list hq)gh))})(if(= gp 1){(setq cy(append(list dx)cy))})(if(or(= ha 2)(= ha 3)){(var bs(take gh(length gh)))(setq gh(at(+(length gh)4)0))(var bd 0)(looprange fr 0(length gh){(if(or(and(= ha 2)(or(= fr 2)(= fr 7)(= fr 13)(= fr 18)))(and(= ha 3)(or(= fr 1)(= fr 5)(= fr 10)(= fr 3)))){(setix gh fr hq)}{(setix gh fr(ix bs bd))(setq bd(+ bd 1))})})})(if(or(= gp 2)(= gp 3)){(var bs(take cy(length cy)))(setq cy(at(+(length cy)4)0))(var bd 0)(looprange fr 0(length cy){(if(or(and(= gp 2)(or(= fr 2)(= fr 7)(= fr 13)(= fr 18)))(and(= gp 3)(or(= fr 1)(= fr 5)(= fr 10)(= fr 3)))){(setix cy fr dx)}{(setix cy fr(ix bs bd))(setq bd(+ bd 1))})})})(var gb(ax'gb))(var fa(ax'fa))(var hs(ax'hs))(var fd(length gh))(var fe(length cy))(if(and(>= ci 0)(= ew ci)(= ci cg)){(var by(append dp gh cy))(var cj(length by))(var fk(rgbled-buffer cj gb))(rgbled-color fk 0 by ey)(if(not-eq(first(trap(rgbled-init ci fa)))'exit-ok){(gd'ci -1)(cz"Invalid Pin")(ho'ci -1)(ho'crc(he))}{(eu 0.01)(rgbled-update cb)(eu 0.01)})(free fk)} {(if(and(>= ci 0)(= ci cg)){(var by(append gh cy))(var cj(length by))(var fk(rgbled-buffer cj fa))(rgbled-color fk 0 by ey)(if(not-eq(first(trap(rgbled-init ci fa)))'exit-ok){(gd'ci -1)(cz"Invalid Pin")(ho'ci -1)(ho'crc(he))}{(eu 0.01)(rgbled-update cb)(eu 0.01)})(free fk)}{(if(and(>= ew 0)(= ew cg)){(if(!= gb hs)(gq dp))(var by(append dp cy))(var cj(length by))(var fk(rgbled-buffer cj hs))(rgbled-color fk 0 by ey)(if(not-eq(first(trap(rgbled-init ew gb)))'exit-ok){(gd'ew -1)(cz"Invalid Pin")(ho'ew -1)(ho'crc(he))}{(eu 0.01)(rgbled-update hc)(eu 0.01)})(free fk)}{(if(>= ew 0){(var hc(rgbled-buffer(length dp)gb))(rgbled-color hc 0 dp(ax'ae))(if(not-eq(first(trap(rgbled-init ew gb)))'exit-ok){(gd'ew -1)(cz"Invalid Pin")(ho'ew -1)(ho'crc(he))}{(eu 0.01)(rgbled-update hc)(eu 0.01)})(free hc)})(if(>= cg 0){(var hg(rgbled-buffer fe gb))(rgbled-color hg 0 cy ey)(if(not-eq(first(trap(rgbled-init cg hs)))'exit-ok){(gd'cg -1)(cz"Invalid Pin")(ho'cg -1)(ho'crc(he))}{(eu 0.01)(rgbled-update hg)(eu 0.01)})(free hg)})})(if(>= ci 0){(var cb(rgbled-buffer fd gb))(rgbled-color cb 0 gh ey)(if(not-eq(first(trap(rgbled-init ci fa)))'exit-ok){(gd'ci -1)(cz"Invalid Pin")(ho'ci -1)(ho'crc(he))}{(eu 0.01)(rgbled-update cb)(eu 0.01)})(free cb)})})})})(defunret hd(){(var bo'())(var be(ax'bt))(gd'bt -1)(var bh(systime))(loopwhile-thd 150(<=(secs-since bh)10){(if(and(>= be 0)(<=(secs-since bh)5)){(setq bo(list be))}{(setq bo(can-scan))})(loopforeach bt bo {(setq bx bt)(gz bt(list(assoc bu'z)))(eu 0.5)(if(>=(ax'bt)0){(if(not-eq(ax'bt)be){(ho'bt(ax'bt))(ho'crc(he))})(return 1)})})})(return 0)})(def fq 101)(def hi 102)(def bu'((z . 0)(ie . 10)(e . 24)(dl . 29)(eh . 202)))(defun gz(bt bc){(send-data(append(list fq)bc)2 bt)})(defun status (){(var fi"status ")(setq fi(str-merge fi(str-from-n(if(<(secs-since g)1)1 0)"%d ")))(setq fi(str-merge fi(str-from-n(if(<(secs-since ce)1)1 0)"%d ")))(setq fi(str-merge fi(str-from-n(if(<(secs-since cd)1)1 0)"%d ")))(send-data fi)})(defun w(){(var hb(ax'hb))(var gw(ax'gw))(uart-stop)(if(>= gw 0){(if(not-eq(first(trap(gpio-configure gw'pin-mode-out)))'exit-ok){(gd'gw -1)(cz"Invalid Pin")(ho'gw -1)(ho'crc(he))})})(if(>= hb 0){(if(not-eq(first(trap(gpio-configure hb'pin-mode-in-pu)))'exit-ok){(gd'hb -1)(cz"Invalid Pin")(ho'hb -1)(ho'crc(he))}{(uart-start 1 hb -1 115200)(set-bms-val'bms-cell-num 15)(set-bms-val'bms-temp-adc-num 4)(set-bms-val'bms-temp-cell-max 45)})})})(defunret ax(cs){(var hu(assoc cf cs))(if hu(return(car(cdr(cdr(cdr hu)))))(return nil))})(defun save-config(){(loopforeach bk cf {(var cs(first bk))(if(eq cs'crc){(ho cs(he))}{(ho cs(ax cs))})})(send-data"Settings Saved!")})(defunret he(){(var i 0)(var bq(-(length cf)1))(var bg(bufcreate bq))(loopforeach bk cf {(var cs(first bk))(if(not-eq cs'crc){(bufset-i32 bg i(ax cs))(+ i 1)})})(var crc(crc16 bg))(free bg)(return crc)})(defun fy(){(loopforeach bk cf {(var cs(first bk))(var hm(ff cs))(gd cs hm)})})(defun restore-config(){(loopforeach bk cf {(var cs(first bk))(var bz(if(eq cs'cn)gi(ix bk 3)))(ho cs bz)})(fy)(send-data"Settings Restored!")})(defun ff(cs)(let((fb(first(assoc cf cs)))(ed(second(assoc cf cs))))(cond((eq ed'i)(eeprom-read-i fb))((eq ed'f)(eeprom-read-f fb))((eq ed'b)(eeprom-read-i fb)))))(defun ho(cs hm)(let((fb(first(assoc cf cs)))(ed(second(assoc cf cs))))(cond((eq ed'i)(eeprom-store-i fb hm))((eq ed'f)(eeprom-store-f fb hm))((eq ed'b)(eeprom-store-i fb hm)))))(defun cz(hn)(send-data(str-merge"msg "hn)))(defun at(hk hm)(map(fn(x)hm)(range hk)))(defun cr(ar gl gj){(var hy(if(< ar 0)gl gj))(var co(if(< ar 0)gj gl))(looprange am 0(length gh){(setix gh am co)})(looprange am 0(length cy){(setix cy am hy)})})(defun df(){(if(!=(str-cmp(to-str(sysinfo'hw-type))"hw-express")0){(exit-error"gu running on hw-express")})(def fh(+(first(sysinfo'fw-ver))(*(second(sysinfo'fw-ver))0.01)))(if(< fh 6.05)(exit-error"hw-express cx ao hh running 6.05"))(if(not-eq(ff'cn)gi)(restore-config)(fy))(if(!=(he)(to-i(ff'crc))){(cz"Error: crc corrupt")(restore-config)})(spawn gx)(event-register-handler(spawn ad))(event-enable'event-data-rx)(spawn hd)(if(=(conf-get'wifi-mode)0){(cz"WiFi is disabled. Please enable and reboot.")}{(event-enable'event-esp-now-rx)(setq fs(list(ax'eg)(ax'hw)(ax'gn)(ax'ft)(ax'cp)(ax'ez)))(gf fs)(spawn id)})(w)(spawn hv)})(defun recv-config(eo dn gy hl ej ai aw ba ef y fo ck s bl ae ew gg gb dw ci fd fa ib ha cg fe hs ht gp hb gw gm){(gd'eo(to-i eo))(gd'dn(to-i dn))(gd'gy(to-i gy))(gd'hl(to-i hl))(gd'ej(to-i ej))(gd'ai(to-i ai))(gd'aw(to-i aw))(gd'ba(to-i ba))(gd'ef(to-float ef))(gd'y(to-i y))(gd'fo(to-i fo))(gd'ck(to-float ck))(gd's(to-float s))(gd'bl(to-float bl))(gd'ae(to-float ae))(gd'ew(to-i ew))(gd'gg(to-i gg))(gd'gb(to-i gb))(gd'dw(to-i dw))(gd'ci(to-i ci))(gd'fd(to-i fd))(gd'fa(to-i fa))(gd'ib(to-i ib))(gd'ha(to-i ha))(gd'cg(to-i cg))(gd'fe(to-i fe))(gd'hs(to-i hs))(gd'ht(to-i ht))(gd'gp(to-i gp))(var du(ax'hb))(gd'hb(to-i hb))(var ch(ax'gw))(gd'gw(to-i gw))(gd'gm(to-i gm))(if(or(!=(to-i hb)du)(!=(to-i gw)ch)){(w)})})(def bj [0 0 0 0 1 2 3 4 5 7 8 11 14 16 18 19 25 30 33 37 43 48 53 60 67 71 76 82 92 97 100])(defun bi(di)(let((hj(max 0(min(- di 2700)(- 1500 1)))))(let((i(* hj(/ 30.0 1500))))(let((fg(floor i)))(let((f(- i fg)))(let((ic(bufget-u8 bj fg))(b(bufget-u8 bj(+ fg 1))))(max 0(min(round(+ ic(* f(- b ic))))100))))))))(defun gr(er){(atomic {(if(and(>(buflen er)1)(=(bufget-u8 er 0)hi)){(bufcpy er 0 er 1(-(buflen er)1))(eval(read er))})})(if(and(>(buflen er)1)(=(bufget-u8 er 0)fq)){(setq g(systime))(match(cossa bu(bufget-u8 er 1))(z {(gd'bt bx)})(eh {(var ia(bufget-u8 er 2))(gd'eo(bits-dec-int ia 0 1))(gd'dn(bits-dec-int ia 1 1))})(e {(setq br(bufget-u8 er 2))(setq dc(bufget-u8 er 3))(if(= br 3){(setq bm 0.0)(setq dh(bufget-u8 er 4))}{(setq bm(to-float(bufget-i8 er 4)))(setq dh 0.0)})(setq hx(/(to-float(bufget-i16 er 5))10))(setq el(/(to-float(bufget-i16 er 7))10))(setq m(/(to-float(bufget-i16 er 9))10))(gd'ck(/(bufget-u8 er 11)100.0))(gd'bl(/(bufget-u8 er 12)100.0))(gd'ae(/(bufget-u8 er 13)100.0))})(dl {(setq dd(/(bufget-u8 er 2)100.0))})(ie {(var ca(bufget-u8 er 2))(if(= ca 69){(setq dc(bufget-u8 er 3))} {(setq bm(/(to-float(bufget-i16 er 5))10))(setq av(/(to-float(bufget-i16 er 7))10))(setq br(bufget-u8 er 9))(setq aa(bufget-u8 er 10))(setq m(/(to-float(bufget-i16 er 22))10))(setq hx(to-float(bufget-i16 er 24)))(setq aj(/(to-float(bufget-i16 er 26))10))(setq el(/(to-float(bufget-i16 er 28))10))(setq dh(-(/(bufget-u8 er 30)100.0)0.5))(if(>= ca 2){(setq bn(bufget-f32 er 34))(setq ei(/(bufget-u8 er 38)2.0))(setq fj(/(bufget-u8 er 39)2.0))})(if(>= ca 3){(setq fl(bufget-u32 er 41))(setq dk(/(bufget-u8 er 53)2.0))})})})(_ nil))})(free er)})(defun gx(){(var ar 0)(var em 0)(var ab 0)(var bf 0)(var l(secs-since 0))(var ee 0)(var ig 0)(loopwhile-thd 100 t {(setq ee(secs-since 0))(var bt(ax'bt))(gz bt(append(list(assoc bu'e))'(102 108 111 97 116 45 97 99 99 101 115 115 111 114 105 101 115 49 46 48 0)))(gz bt(list(assoc bu'eh)))(gz bt(list(assoc bu'dl)))(if(=(ax'eo)1){(setq dp(at(ax'gg)0))(setq gh(at(ax'fd)0))(setq cy(at(ax'fe)0))(setq ar 0)(var fv 10)(if(= br 4)(setq fv(*fv -1)))(if(> hx fv){(setq ar 1)})(if(< hx(* fv -1)){(setq ar -1)})(if(=(ax'aw)1){(if(> bm 70)(setq bf 1)(setq bf 0))})(fm(secs-since dv)em ar ab bf)(setq em ar)(if(or(!= ar 0)(= bf 1)){(setq ab 0)(setq dv(systime))})(if(< ab 2)(fc ar))} {(ep)(fc ar)})(setq l(+ l 0.1))(var ge(- l(secs-since 0)))(if(> ge 0){(eu ge)(setq l(secs-since 0))})})})(defun send-config(){(var ds"settings ")(loopforeach bk cf {(let((cs(first bk))(ed(third bk))){(var value(ff cs))(setq ds(str-merge ds(cond((eq ed'b)(str-from-n value"%d "))((eq ed'i)(str-from-n value"%d "))((eq ed'f)(str-from-n value"%.2f ")))))})})(send-data ds)(send-data"Settings Read!")})(defun gf(cc){(esp-now-start)(esp-now-del-peer fs)(esp-now-add-peer fs)})(def p 0)(defun pair-pubmote(ea){(if(=(conf-get'wifi-mode)0){(cz"WiFi is disabled. Please enable and reboot.")}{(cond((>= ea 0){(gd'gk ea)(setq cv(systime))(setq p 1)})((= ea -1){(gf fs)(ho'eg(ix fs 0))(ho'hw(ix fs 1))(ho'gn(ix fs 2))(ho'ft(ix fs 3))(ho'cp(ix fs 4))(ho'ez(ix fs 5))(ho'gk gk)(ho'crc(he))(setq p 0)})((= ea -2){(setq fs'())(ho'eg -1)(ho'crc(he))(setq p 0)}))})})(defun id(){(var l(secs-since 0))(var ee 0)(var ig 0)(loopwhile-thd 100 t {(setq ee(secs-since 0))(if(and(>(secs-since cv)30)(>= p 2)){(atomic(pair-pubmote -2))})(if(= p 1){(esp-now-del-peer fs)(setq fs'(255 255 255 255 255 255))(esp-now-add-peer fs)(esp-now-send fs"42069")(esp-now-del-peer fs)(setq p 2)})(if(and(= p 0)(>=(ax'eg)0)(<=(secs-since ce)5)(>=(ax'bt)0)){(gz(ax'bt)(list(assoc bu'ie)3))(var er(bufcreate 32))(bufset-u8 er 0 69)(bufset-u8 er 1 dc)(bufset-i16 er 2(floor(* bm 10)))(bufset-i16 er 4(floor(* av 10)))(bufset-u8 er 6 br)(bufset-u8 er 7 aa)(bufset-i16 er 8(floor(* m 10)))(bufset-i16 er 10(floor hx))(bufset-i16 er 12(floor(* aj 10)))(bufset-i16 er 14(floor(* el 10)))(bufset-u8 er 16(floor(*(+ dh 0.5)100)))(bufset-f32 er 17 bn'little-endian)(bufset-u8 er 21(floor(* ei 2)))(bufset-u8 er 22(floor(* fj 2)))(bufset-u32 er 23 fl)(bufset-u8 er 27(floor(* dk 2)))(bufset-i32 er 28(ax'gk))(esp-now-send fs er)(free er)})(setq ig(secs-since 0))(setq l(+ l 0.05))(var ge(- l(secs-since 0)))(if(> ge 0){(eu ge)(setq l(secs-since 0))})})})(defun ad()(loopwhile t(recv((event-esp-now-rx(? cc)(? de)(? er)(? gt))(aq cc de er gt))((event-data-rx .(? er))(gr er))(_ nil))))(defun gd(cs value){(let((hu(assoc cf cs)))(if hu(loopforeach cl cf {(if(eq(car cl)cs)(setcdr cl(list(car(cdr cl))(car(cdr(cdr cl)))(car(cdr(cdr(cdr cl))))value)))})(setq cf(cons(cons cs(list 0'ed 0 value))cf))))})(defun aq(cc de er gt){(if(= p 2){(setq fs cc)(esp-now-add-peer fs)(esp-now-send fs(ax'gk))(esp-now-del-peer fs)(setq p 3)}{(if(and(=(buflen er)15)(=(bufget-i32 er 11)(ax'gk))){(setq ce(systime))(var jsx(bufget-f32 er 0'little-endian))(var jsy(bufget-f32 er 4'little-endian))(var bt-c(bufget-u8 er 8))(var bt-z(bufget-u8 er 9))(var is-rev(bufget-u8 er 10))(dq(ax'bt)(bw(to-str(list jsy jsx bt-c bt-z is-rev))"(""(set-remote-state "))})})(free er)})(defun eu(x)(yield(* x 1000000)))@const-end(defun fm(ct em ar ab bf){(var y(ax'y))(var c(secs-since g))(if(or(> c y)(< ct(ax'fo))){(if(>(length dp)0){(if(=(ax'ej)0)(ih))})(var da(ax'gy))(setq ey(ax'ck))(var y(ax'y))(if(>= c y){(setq da 0)}{(if(and(<=(secs-since 0)y)(= ar 0))(setq da(ax'ai)))(if(> ct y){(setq da(ax'hl))(setq ey(ax'bl))})})(var gl 0x00)(var gj 0x00)(if(and(>(length gh)0)(>(length cy)0)){(cond((or(= da 1)(= bf 1)){(o gh)(o cy)})((= da 0){(setq gl 0xFFFFFFFFu32)(setq gj 0x00FF0000u32)(cr ar gl gj)})((= da 2){(setq gl 0x0000FFFFu32)(setq gj 0x00FF00FFu32)(cr ar gl gj)})((= da 3){(setq gl 0x000000FFu32)(setq gj 0x0000FF00u32)(cr ar gl gj)})((= da 4){(setq gl 0x00FFFF00u32)(setq gj 0x0000FF00u32)(cr ar gl gj)})((= da 5){(fu)})((= da 6){(az)})((= da 7){(dz 0)})((= da 8){(dz 1)})((= da 9){(ga)})((= da 10){(dy)}))(if(and(=(ax'ba)1)(<= el(ax'ef)))(dr))})} {(if(< ab 2){(ep)(setq ab(+ ab 1))})})})(defun hv(){(var ag 5)(var l(secs-since 0))(var ee 0)(var ig 0)(var db(bufcreate 64))(loopwhile-thd 100 t {(setq ee(secs-since 0))(if(>=(ax'hb)0){(var ak(uart-read db(buflen db)nil nil 0.5))(if(> ak 5){(var u 0)(var hp 0)(var bp 0)(var dj 0)(var n 0)(var i 0)(loopwhile(and(< i(- ak 5))(not(and(= u 1)(= hp 1)(= bp 1)(= dj 1)(= n 1)))){(if(and(<(+ i 2)ak)(=(bufget-u8 db i)0xFF)(=(bufget-u8 db(+ i 1))0x55)(=(bufget-u8 db(+ i 2))0xAA)){(setq cd(systime))(if(<(+ i 3)ak){(var gv(bufget-u8 db(+ i 3)))(var ek(+ i 4))(loopwhile(and(< ek(- ak 2))(not(and(<(+ ek 2)ak)(=(bufget-u8 db ek)0xFF)(=(bufget-u8 db(+ ek 1))0x55)(=(bufget-u8 db(+ ek 2))0xAA)))){(setq ek(+ ek 1))})(var hk(- ek i))(if(>= hk 6){(var eb(bufcreate hk))(bufcpy eb 0 db i hk)(if(>=(buflen eb)2){(var crc(bufget-u16 db(- ek 2)))(var ap 0)(looprange fr 0(-(buflen eb)2){(setq ap(+ ap(bufget-u8 eb fr)))})(if(eq crc ap){(cond((and(= gv 2)(= hp 0)){(setq hp 1)(var cw 0)(var hf 0)(looprange fr 4(-(buflen eb)4){(if(eq(mod fr 2)0){(if(and(= cw 0)(=(ax'gm)1)){(set-bms-val'bms-soc(/(bi(bufget-i16 eb fr))100.0))})(var dm(/(bufget-i16 eb fr)1000.0))(set-bms-val'bms-v-cell cw dm)(setq cw(+ cw 1))(setq hf(+ hf dm))})})(set-bms-val'bms-v-tot hf)})((and(= gv 3)(= bp 0)){(setq bp 1)(if(=(ax'gm)0){(set-bms-val'bms-soc(/(bufget-u8 eb 4)100.0))})})((and(= gv 5)(= n 0)){(setq n 1)(var gs 0.055)(var es(*(bufget-i16 eb 4)gs))(set-bms-val'bms-i-in-ic es)})((and(= gv 0)(= u 0)){(setq u 1)})((and(= gv 4)(= dj 0)){(setq dj 1)(set-bms-val'bms-temp-ic(bufget-i8 eb(-(buflen eb)3)))(looprange fr 4(-(buflen eb)3){(set-bms-val'bms-temps-adc(- fr 4)(bufget-i8 eb fr))})}))(setq i ek)})})(free eb)})(setq i ek)} {(setq i(+ i 1))})} {(setq i(+ i 1))})})(send-bms-can)}{ })(if(>=(ax'gw)0){(if(and(>(secs-since cd)ag)(<(secs-since g)1)(or(= br 0)(> br 5))){(gpio-write(ax'gw)1)(eu 0.1)(gpio-write(ax'gw)0)})})})(setq ig(secs-since 0))(setq l(+ l 0.05))(var ge(- l(secs-since 0)))(if(> ge 0){(eu ge)(setq l(secs-since 0))})})})(df)