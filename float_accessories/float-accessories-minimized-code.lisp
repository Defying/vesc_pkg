@const-symbol-strings(def en -1)(def gn -1)(def gu -1)(def el -1)(def gj -1)(def ep -1)(def hg -1)(def ex -1)(def cq -1)(def ab -1)(def fo -1)(def at -1)(def p -1)(def dh -1)(def q -1)(def aa 1)(def ey'())(def id'())(def ea'())(def ao 0)(def cj -1)(def s'())(def by 31)(def hn 0)(def ga 0)(def fc 0)(def c 0)(def fi'(0xFF0000u32 0xFFFF00u32 0x00FF00u32 0x00FFFFu32 0x0000FFu32 0xFF00FFu32))(def aw'(0x00FFFF00 0x0000FF00 0x0000FFFF 0x000000FF 0x00FF00FF 0x00FF0000))(def hj 101)(def cd 102)(def di'((hr . 0)(cy . 10)(dp . 24)(ar . 29)(hv . 202)))(def ev 0)(def ei 0)(def gv 0)(def fg 0)(def gx 1)(def cw 0)(def bz 0)(def gz 0)(def bj [0 0 0 0 1 2 3 4 5 7 8 11 14 16 18 19 25 30 33 37 43 48 53 60 67 71 76 82 92 97 100])(def ce 422i32)(def dl'((bw .(0 i ce -1))(crc .(1 i 60967 -1))(hu .(2 i -1 -1))(fz .(3 b 1 -1))(dt .(4 b 1 -1))(dj .(5 i 0 -1))(ej .(6 i 5 -1))(es .(7 i 0 -1))(fu .(8 i 5 -1))(eg .(9 b 1 -1))(bk .(10 b 1 -1))(cu .(11 f -4.0 -1))(ci .(12 i 30 -1))(et .(13 i 120 -1))(ck .(14 f 0.5 -1))(hs .(15 f 0.5 -1))(gi .(16 f 0.2 -1))(gg .(17 f 0.5 -1))(bb .(18 i -1 -1))(gf .(19 i 10 -1))(cg .(20 i 2 -1))(ee .(21 b 0 -1))(ag .(22 i 18 -1))(gq .(23 i 13 -1))(hm .(24 i 2 -1))(cl .(25 b 0 -1))(ct .(26 b 1 -1))(dc .(27 i 17 -1))(dv .(28 i 13 -1))(be .(29 i 2 -1))(cs .(30 b 0 -1))(l .(31 b 1 -1))(hi .(32 i -1 -1))(au .(33 i -1 -1))(eh .(34 i 1 -1))(dn .(35 i -1 -1))(al .(36 i -1 -1))(ie .(37 i -1 -1))(ho .(38 i -1 -1))(fx .(39 i -1 -1))(a .(40 i -1 -1))(bt .(41 i -1 -1))))@const-start(defun bp(eu){(var gh(length eu))(var dz(floor(/ gh 4.0)))(var bh(floor(* gh 3(/ 1 4.0))))(looprange i 0 gh {(if(and(>= i dz)(< i bh)){(if(or(= i dz)(= i(- bh 1))){(setix eu i 0x007F0000)} {(setix eu i 0x00FF0000)})} {(setix eu i 0x00000000)})})})(defun cz(){(setq ev(mod(+ ev 1)2))(var dk(if(= ev 0)0xFFFFFFFF 0x00000000))(z id dk)(z ea dk)})(defun az(){(setq ei(mod(+ ei 1)2))(z ea(if(= ei 0)0x00FF0000 0x00000000))})(defun gy(ft){(var fe(ix aw gv))(z id(if(= ft 0)fe 0xFF000000))(z ea fe)(setq gv(mod(+ gv 1)6))})(defun max(fw b)(if(> fw b)fw b))(defun min(fw b)(if(< fw b)fw b))(defun hc(){(var ez(+(length id)(length ea)))(looprange i 0 ez {(var bn(abs(- i fg)))(var r(max 0(- 255(* bn 51))))(var dk(color-make r 0 0))(if(< i(length id))(setix id i dk)(setix ea(- i(length id))dk))})(setq fg(+ fg gx))(if(or(>= fg ez)(< fg 0))(setq gx(* gx -1)))})(defun ew(bm){(var gh(length bm))(var ff(floor(* gh ao)))(looprange df 0 gh {(var fr 0)(var dw 0)(if(or(< df ff)(and(= df 0)(<= ff 1))){(if(or(< ao 0.2)(and(= df 0)(<= ff 1))){(setq fr 255)(setq dw 0)} {(setq fr(floor(* 255(- 1(/ ao 0.8)))))(setq dw(floor(* 255(/ ao 0.8))))})} {(setq fr 0)(setq dw 0)})(var dk 0x00)(setq dk(bits-enc-int dk 16 fr 8))(setq dk(bits-enc-int dk 8 dw 8))(setix bm df dk)})})(defun co(){(var aj(length fi))(looprange df 0(length id){(var gk(mod(+ cw df(length id))aj))(var dk(ix fi gk))(setix id df dk)})(looprange df 0(length ea){(var gk(mod(+ cw df(length ea))aj))(var dk(ix fi gk))(setix ea df dk)})(setq cw(mod(+ cw 1)aj))})(defun cv(){(var ch(mod bz 3))(var gq(length id))(var dv(length ea))(var cc(floor(/ gq 2)))(var dr(floor(/ dv 2)))(cond((= ch 0){(looprange i 0 cc(setix id i 0x00000000))(looprange i cc gq(setix id i 0x00FF0000))(looprange i 0 dr(setix ea i 0x00000000))(looprange i dr dv(setix ea i 0x00FF0000))})((= ch 1){(looprange i 0 cc(setix id i 0x00FF0000))(looprange i cc gq(setix id i 0x000000FF))(looprange i 0 dr(setix ea i 0x00FF0000))(looprange i dr dv(setix ea i 0x000000FF))})((= ch 2){(looprange i 0 cc(setix id i 0x000000FF))(looprange i cc gq(setix id i 0x00000000))(looprange i 0 dr(setix ea i 0x000000FF))(looprange i dr dv(setix ea i 0x00000000))}))(setq bz(mod(+ bz 1)3))})(defun em(){(if(> ep 250.0){(av)}{(if(and(!= gj 1)(!= gj 2)(!= gj 3)){(ew ey)}{(hd gj)})})})(defun av(){(var gf(length ey))(var cp(*(abs ab)1.1112))(var gl 0.0)(if(< cp 1.0){(setq gl cp)} {(setq gl 1.0)})(var db(floor(* gl gf)))(var ge 0x00FFFF00u32)(if(>(abs ab)0.85){(setq ge 0x00FF0000u32)} {(if(>(abs ab)0.7){(setq ge 0x00FF8800u32)})})(looprange df 0 gf {(setix ey df(if(< df db)ge 0x00000000u32))})})(defun hd(gj){(var gf(length ey))(var cb(if(or(= gj 1)(= gj 3))0xFF 0x00))(var fb(if(or(= gj 2)(= gj 3))0xFF 0x00))(looprange df 0 gf {(setix ey df(if(< df(/ gf 2))cb fb))})})(defun z(eu dk){(looprange df 0(length eu){(setix eu df dk)})})(defun ht(){(z ey 0x00)(z id 0x00)(z ea 0x00)})(defun u(bm){(looprange df 0(length bm){(var dk(color-split(ix bm df)1))(var g(color-make(ix dk 1)(ix dk 0)(ix dk 2)(ix dk 3)))(setix bm df g)})})(defun dx(v){(if(=(bf'ee)1){(setq ey(reverse ey))})(if(=(bf'cl)1){(setq id(reverse id))})(if(=(bf'cs)1){(setq ea(reverse ea))})(var dt(bf'dt))(var hs(bf'hs))(var bb(bf'bb))(var ag(bf'ag))(var dc(bf'dc))(var ct(bf'ct))(var l(bf'l))(var hw(if(and(> v 0)(= dt 0))(to-i(* 0xFF hs))0x00))(var ai(if(and(< v 0)(= dt 0))(to-i(* 0xFF hs))0x00))(if(or(= ct 2)(= ct 3)){(setq id(append(list hw)id))})(if(or(= l 2)(= l 3)){(setq ea(append(list ai)ea))})(if(or(= ct 4)(= ct 5)){(var dd(take id(length id)))(setq id(m(+(length id)4)0))(var cn 0)(looprange gp 0(length id){(if(or(and(= ct 4)(or(= gp 2)(= gp 7)(= gp 13)(= gp 18)))(and(= ct 5)(or(= gp 1)(= gp 5)(= gp 10)(= gp 3)))){(setix id gp hw)}{(setix id gp(ix dd cn))(setq cn(+ cn 1))})})})(if(or(= l 4)(= l 5)){(var dd(take ea(length ea)))(setq ea(m(+(length ea)4)0))(var cn 0)(looprange gp 0(length ea){(if(or(and(= l 4)(or(= gp 2)(= gp 7)(= gp 13)(= gp 18)))(and(= l 5)(or(= gp 1)(= gp 5)(= gp 10)(= gp 3)))){(setix ea gp ai)}{(setix ea gp(ix dd cn))(setq cn(+ cn 1))})})})(var cg(bf'cg))(var hm(bf'hm))(var be(bf'be))(var gq(length id))(var dv(length ea))(if(and(>= ag 0)(= bb ag)(= ag dc)){(var cm(append ey id ea))(var ez(length cm))(var ed(rgbled-buffer ez cg))(rgbled-color ed 0 cm aa)(if(not-eq(first(trap(rgbled-init ag hm)))'exit-ok){(o'ag -1)(an"Invalid Pin")(am'ag -1)(am'crc(ah))}{(bl 0.01)(rgbled-update de)(bl 0.01)})(free ed)} {(if(and(>= ag 0)(= ag dc)){(var cm(append id ea))(var ez(length cm))(var ed(rgbled-buffer ez hm))(rgbled-color ed 0 cm aa)(if(not-eq(first(trap(rgbled-init ag hm)))'exit-ok){(o'ag -1)(an"Invalid Pin")(am'ag -1)(am'crc(ah))}{(bl 0.01)(rgbled-update de)(bl 0.01)})(free ed)}{(if(and(>= bb 0)(= bb dc)){(if(!= cg be)(u ey))(var cm(append ey ea))(var ez(length cm))(var ed(rgbled-buffer ez be))(rgbled-color ed 0 cm aa)(if(not-eq(first(trap(rgbled-init bb cg)))'exit-ok){(o'bb -1)(an"Invalid Pin")(am'bb -1)(am'crc(ah))}{(bl 0.01)(rgbled-update fd)(bl 0.01)})(free ed)}{(if(>= bb 0){(var fd(rgbled-buffer(length ey)cg))(rgbled-color fd 0 ey(bf'gg))(if(not-eq(first(trap(rgbled-init bb cg)))'exit-ok){(o'bb -1)(an"Invalid Pin")(am'bb -1)(am'crc(ah))}{(bl 0.01)(rgbled-update fd)(bl 0.01)})(free fd)})(if(>= dc 0){(var gw(rgbled-buffer dv cg))(rgbled-color gw 0 ea aa)(if(not-eq(first(trap(rgbled-init dc be)))'exit-ok){(o'dc -1)(an"Invalid Pin")(am'dc -1)(am'crc(ah))}{(bl 0.01)(rgbled-update gw)(bl 0.01)})(free gw)})})(if(>= ag 0){(var de(rgbled-buffer gq cg))(rgbled-color de 0 id aa)(if(not-eq(first(trap(rgbled-init ag hm)))'exit-ok){(o'ag -1)(an"Invalid Pin")(am'ag -1)(am'crc(ah))}{(bl 0.01)(rgbled-update de)(bl 0.01)})(free de)})})})})(defunret bo(){(var bs'())(var fj(bf'hu))(o'hu -1)(var he(systime))(loopwhile-thd 150(<=(secs-since he)10){(if(and(>= fj 0)(<=(secs-since he)5)){(setq bs(list fj))}{(setq bs(can-scan))})(loopforeach hu bs {(setq cj hu)(aq hu(list(assoc di'hr)))(bl 0.5)(if(>=(bf'hu)0){(if(not-eq(bf'hu)fj){(am'hu(bf'hu))(am'crc(ah))})(return 1)})})})(return 0)})(defun aq(hu bv){(send-data(append(list hj)bv)2 hu)})(defun status (){(var k"status ")(setq k(str-merge k(str-from-n(if(<(secs-since c)1)1 0)"%d ")))(setq k(str-merge k(str-from-n(if(<(secs-since hn)1)1 0)"%d ")))(setq k(str-merge k(str-from-n(if(<(secs-since ga)1)1 0)"%d ")))(send-data k)})(defun eo(){(var hi(bf'hi))(var au(bf'au))(uart-stop)(if(>= au 0){(if(not-eq(first(trap(gpio-configure au'pin-mode-out)))'exit-ok){(o'au -1)(an"Invalid Pin")(am'au -1)(am'crc(ah))})})(if(>= hi 0){(if(not-eq(first(trap(gpio-configure hi'pin-mode-in-pu)))'exit-ok){(o'hi -1)(an"Invalid Pin")(am'hi -1)(am'crc(ah))}{(uart-start 1 hi -1 115200)(set-bms-val'bms-cell-num 15)(set-bms-val'bms-temp-adc-num 4)(set-bms-val'bms-temp-cell-max 45)})})})(defunret bf(ic){(var bq(assoc dl ic))(if bq(return(car(cdr(cdr(cdr bq)))))(return nil))})(defun save-config(){(loopforeach gr dl {(var ic(first gr))(if(eq ic'crc){(am ic(ah))}{(am ic(bf ic))})})(send-data"Settings Saved!")})(defunret ah(){(var i 0)(var y(-(length dl)1))(var ay(bufcreate y))(loopforeach gr dl {(var ic(first gr))(if(not-eq ic'crc){(bufset-i32 ay i(bf ic))(+ i 1)})})(var crc(crc16 ay))(free ay)(return crc)})(defun ef(){(loopforeach gr dl {(var ic(first gr))(var ha(ec ic))(o ic ha)})})(defun restore-config(){(loopforeach gr dl {(var ic(first gr))(var da(if(eq ic'bw)ce(ix gr 3)))(am ic da)})(ef)(send-data"Settings Restored!")})(defun ec(ic)(let((bd(first(assoc dl ic)))(ft(second(assoc dl ic))))(cond((eq ft'i)(eeprom-read-i bd))((eq ft'f)(eeprom-read-f bd))((eq ft'b)(eeprom-read-i bd)))))(defun am(ic ha)(let((bd(first(assoc dl ic)))(ft(second(assoc dl ic))))(cond((eq ft'i)(eeprom-store-i bd ha))((eq ft'f)(eeprom-store-f bd ha))((eq ft'b)(eeprom-store-i bd ha)))))(defun an(fy)(send-data(str-merge"msg "fy)))(defun m(ac ha)(map(fn(x)ha)(range ac)))(defun ib(){(if(!=(str-cmp(to-str(sysinfo'hw-type))"hw-express")0){(exit-error"bi running on hw-express")})(var fk(+(first(sysinfo'fw-ver))(*(second(sysinfo'fw-ver))0.01)))(if(< fk 6.05)(exit-error"hw-express du ia hk running 6.05"))(if(not-eq(ec'bw)ce)(restore-config)(ef))(if(!=(ah)(to-i(ec'crc))){(an"Error: crc corrupt")(restore-config)})(spawn hb)(event-register-handler(spawn hz))(event-enable'event-data-rx)(spawn bo)(if(=(conf-get'wifi-mode)0){(an"WiFi is disabled. Please enable and reboot.")}{(event-enable'event-esp-now-rx)(setq s(list(bf'dn)(bf'al)(bf'ie)(bf'ho)(bf'fx)(bf'a)))(hy s)(spawn hh)})(eo)(spawn fa)})(defun recv-config(fz dt dj ej es fu eg bk cu ci et ck hs gi gg bb gf cg ee ag gq hm cl ct dc dv be cs l hi au eh){(o'fz(to-i fz))(o'dt(to-i dt))(o'dj(to-i dj))(o'ej(to-i ej))(o'es(to-i es))(o'fu(to-i fu))(o'eg(to-i eg))(o'bk(to-i bk))(o'cu(to-float cu))(o'ci(to-i ci))(o'et(to-i et))(o'ck(to-float ck))(o'hs(to-float hs))(o'gi(to-float gi))(o'gg(to-float gg))(o'bb(to-i bb))(o'gf(to-i gf))(o'cg(to-i cg))(o'ee(to-i ee))(o'ag(to-i ag))(o'gq(to-i gq))(o'hm(to-i hm))(o'cl(to-i cl))(o'ct(to-i ct))(o'dc(to-i dc))(o'dv(to-i dv))(o'be(to-i be))(o'cs(to-i cs))(o'l(to-i l))(var bc(bf'hi))(o'hi(to-i hi))(var dg(bf'au))(o'au(to-i au))(o'eh(to-i eh))(if(or(!=(to-i hi)bc)(!=(to-i au)dg)){(eo)})})(defun dy(gs)(let((hf(max 0(min(- gs 2700)(- 1500 1)))))(let((i(* hf(/ 30.0 1500))))(let((cr(floor i)))(let((f(- i cr)))(let((fw(bufget-u8 bj cr))(b(bufget-u8 bj(+ cr 1))))(max 0(min(round(+ fw(* f(- b fw))))100))))))))(defun ax(ad){(atomic {(if(and(>(buflen ad)1)(=(bufget-u8 ad 0)cd)){(bufcpy ad 0 ad 1(-(buflen ad)1))(eval(read ad))})})(if(and(>(buflen ad)1)(=(bufget-u8 ad 0)hj)){(setq c(systime))(match(cossa di(bufget-u8 ad 1))(hr {(o'hu cj)})(hv {(var hq(bufget-u8 ad 2))(o'fz(bits-dec-int hq 0 1))(o'dt(bits-dec-int hq 1 1))})(dp {(setq el(bufget-u8 ad 2))(setq en(bufget-u8 ad 3))(if(= el 3){(setq gn 0.0)(setq ab(bufget-u8 ad 4))}{(setq gn(to-float(bufget-i8 ad 4)))(setq ab 0.0)})(setq ep(/(to-float(bufget-i16 ad 5))10))(setq cq(/(to-float(bufget-i16 ad 7))10))(setq hg(/(to-float(bufget-i16 ad 9))10))(o'ck(/(bufget-u8 ad 11)100.0))(o'gi(/(bufget-u8 ad 12)100.0))(o'gg(/(bufget-u8 ad 13)100.0))})(ar {(setq ao(/(bufget-u8 ad 2)100.0))})(cy {(var gb(bufget-u8 ad 2))(if(= gb 69){(setq en(bufget-u8 ad 3))} {(setq gn(/(to-float(bufget-i16 ad 5))10))(setq gu(/(to-float(bufget-i16 ad 7))10))(setq el(bufget-u8 ad 9))(setq gj(bufget-u8 ad 10))(setq hg(/(to-float(bufget-i16 ad 22))10))(setq ep(to-float(bufget-i16 ad 24)))(setq ex(/(to-float(bufget-i16 ad 26))10))(setq cq(/(to-float(bufget-i16 ad 28))10))(setq ab(-(/(bufget-u8 ad 30)100.0)0.5))(if(>= gb 2){(setq fo(bufget-f32 ad 34))(setq at(/(bufget-u8 ad 38)2.0))(setq p(/(bufget-u8 ad 39)2.0))})(if(>= gb 3){(setq dh(bufget-u32 ad 41))(setq q(/(bufget-u8 ad 53)2.0))})})})(_ nil))})(free ad)})(defun hb(){(var v 0)(var hx 0)(var bg(secs-since 0))(var ba 0)(var bx 0)(loopwhile-thd 100 t {(setq ba(secs-since 0))(var hu(bf'hu))(aq hu(append(list(assoc di'dp))'(102 108 111 97 116 45 97 99 99 101 115 115 111 114 105 101 115 49 46 48 0)))(aq hu(list(assoc di'hv)))(aq hu(list(assoc di'ar)))(if(=(bf'fz)1){(setq ey(m(bf'gf)0))(setq id(m(bf'gq)0))(setq ea(m(bf'dv)0))(setq v 0)(var ak 10)(if(= el 4)(setq ak(*ak -1)))(if(> ep ak){(setq v 1)})(if(< ep(* ak -1)){(setq v -1)})(if(=(bf'eg)1){(if(> gn 70)(setq hx 1)(setq hx 0))})(fh(secs-since fc)v hx)(if(or(!= v 0)(= hx 1)){(setq fc(systime))})} {(ht)})(dx v)(setq bg(+ bg 0.1))(var hp(- bg(secs-since 0)))(if(> hp 0){(bl hp)(setq bg(secs-since 0))})})})(defun send-config(){(var j"settings ")(loopforeach gr dl {(let((ic(first gr))(ft(third gr))){(var value(ec ic))(setq j(str-merge j(cond((eq ft'b)(str-from-n value"%d "))((eq ft'i)(str-from-n value"%d "))((eq ft'f)(str-from-n value"%.2f ")))))})})(send-data j)(send-data"Settings Read!")})(defun hy(fm){(esp-now-start)(esp-now-del-peer s)(esp-now-add-peer s)})(defun pair-pubmote(e){(if(=(conf-get'wifi-mode)0){(an"WiFi is disabled. Please enable and reboot.")}{(cond((>= e 0){(o'bt e)(setq by(systime))(setq gz 1)})((= e -1){(hy s)(am'dn(ix s 0))(am'al(ix s 1))(am'ie(ix s 2))(am'ho(ix s 3))(am'fx(ix s 4))(am'a(ix s 5))(am'bt bt)(am'crc(ah))(setq gz 0)})((= e -2){(setq s'())(am'dn -1)(am'crc(ah))(setq gz 0)}))})})(defun hh(){(var bg(secs-since 0))(var ba 0)(var bx 0)(loopwhile-thd 100 t {(setq ba(secs-since 0))(if(and(>(secs-since by)30)(>= gz 2)){(atomic(pair-pubmote -2))})(if(= gz 1){(esp-now-del-peer s)(setq s'(255 255 255 255 255 255))(esp-now-add-peer s)(esp-now-send s"42069")(esp-now-del-peer s)(setq gz 2)})(if(and(= gz 0)(>=(bf'dn)0)(<=(secs-since hn)5)(>=(bf'hu)0)){(aq(bf'hu)(list(assoc di'cy)3))(var ad(bufcreate 32))(bufset-u8 ad 0 69)(bufset-u8 ad 1 en)(bufset-i16 ad 2(floor(* gn 10)))(bufset-i16 ad 4(floor(* gu 10)))(bufset-u8 ad 6 el)(bufset-u8 ad 7 gj)(bufset-i16 ad 8(floor(* hg 10)))(bufset-i16 ad 10(floor ep))(bufset-i16 ad 12(floor(* ex 10)))(bufset-i16 ad 14(floor(* cq 10)))(bufset-u8 ad 16(floor(*(+ ab 0.5)100)))(bufset-f32 ad 17 fo'little-endian)(bufset-u8 ad 21(floor(* at 2)))(bufset-u8 ad 22(floor(* p 2)))(bufset-u32 ad 23 dh)(bufset-u8 ad 27(floor(* q 2)))(bufset-i32 ad 28(bf'bt))(esp-now-send s ad)(free ad)})(setq bx(secs-since 0))(setq bg(+ bg 0.05))(var hp(- bg(secs-since 0)))(if(> hp 0){(bl hp)(setq bg(secs-since 0))})})})(defun hz()(loopwhile t(recv((event-esp-now-rx(? fm)(? ca)(? ad)(? gt))(fv fm ca ad gt))((event-data-rx .(? ad))(ax ad))(_ nil))))(defun o(ic value){(let((bq(assoc dl ic)))(if bq(loopforeach ae dl {(if(eq(car ae)ic)(setcdr ae(list(car(cdr ae))(car(cdr(cdr ae)))(car(cdr(cdr(cdr ae))))value)))})(setq dl(cons(cons ic(list 0'ft 0 value))dl))))})(defun fv(fm ca ad gt){(if(= gz 2){(setq s fm)(esp-now-add-peer s)(esp-now-send s(bf'bt))(esp-now-del-peer s)(setq gz 3)}{(if(and(=(buflen ad)15)(=(bufget-i32 ad 11)(bf'bt))){(setq hn(systime))(var jsx(bufget-f32 ad 0'little-endian))(var jsy(bufget-f32 ad 4'little-endian))(var bt-c(bufget-u8 ad 8))(var bt-z(bufget-u8 ad 9))(var is-rev(bufget-u8 ad 10))(ap(bf'hu)(gm(to-str(list jsy jsx bt-c bt-z is-rev))"(""(set-remote-state "))})})})(defun bl(x)(yield(* x 1000000)))@const-end(defun fh(gd v hx){(var ci(bf'ci))(var ds(secs-since c))(if(>(length ey)0){(if(=(bf'es)0)(em))})(var fl(bf'dj))(setq aa(bf'ck))(var ci(bf'ci))(if(>= gd ci){(setq fl(bf'ej))(setq aa(bf'gi))})(if(and(<=(secs-since 0)ci)(= v 0))(setq fl(bf'fu)))(if(and(>(length id)0)(>(length ea)0)){(cond((= el 15){(ht)(bp ey)(bp id)})((and(> gd(bf'et))(< ds 1)){(ht)})((and(or(= fl 1)(= hx 1))(< ds 1)){(ew id)(ew ea)})((or(= fl 0)(and(> ds 1)(>(secs-since 0)ci))){(z(if(>= v 0)id ea)0xFFFFFFFFu32)(z(if(< v 0)id ea)0x00FF0000u32)})((= fl 2){(z(if(>= v 0)id ea)0x0000FFFFu32)(z(if(< v 0)id ea)0x00FF00FFu32)})((= fl 3){(z(if(>= v 0)id ea)0x000000FFu32)(z(if(< v 0)id ea)0x0000FF00u32)})((= fl 4){(z(if(>= v 0)id ea)0x00FFFF00u32)(z(if(< v 0)id ea)0x0000FF00u32)})((= fl 5){(co)})((= fl 6){(cz)})((= fl 7){(gy 0)})((= fl 8){(gy 1)})((= fl 9){(hc)})((= fl 10){(cv)}))(if(and(=(bf'bk)1)(<= cq(bf'cu)))(az))})})(defun fa(){(var dm 5)(var bg(secs-since 0))(var ba 0)(var bx 0)(var hl(bufcreate 64))(loopwhile-thd 100 t {(setq ba(secs-since 0))(if(>=(bf'hi)0){(var w(uart-read hl(buflen hl)nil nil 0.5))(if(> w 5){(var dq 0)(var er 0)(var cf 0)(var eb 0)(var bu 0)(var i 0)(loopwhile(and(< i(- w 5))(not(and(= dq 1)(= er 1)(= cf 1)(= eb 1)(= bu 1)))){(if(and(<(+ i 2)w)(=(bufget-u8 hl i)0xFF)(=(bufget-u8 hl(+ i 1))0x55)(=(bufget-u8 hl(+ i 2))0xAA)){(setq ga(systime))(if(<(+ i 3)w){(var ek(bufget-u8 hl(+ i 3)))(var af(+ i 4))(loopwhile(and(< af(- w 2))(not(and(<(+ af 2)w)(=(bufget-u8 hl af)0xFF)(=(bufget-u8 hl(+ af 1))0x55)(=(bufget-u8 hl(+ af 2))0xAA)))){(setq af(+ af 1))})(var ac(- af i))(if(>= ac 6){(var cx(bufcreate ac))(bufcpy cx 0 hl i ac)(if(>=(buflen cx)2){(var crc(bufget-u16 hl(- af 2)))(var fp 0)(looprange gp 0(-(buflen cx)2){(setq fp(+ fp(bufget-u8 cx gp)))})(if(eq crc fp){(cond((and(= ek 2)(= er 0)){(setq er 1)(var fq 0)(var h 0)(looprange gp 4(-(buflen cx)4){(if(eq(mod gp 2)0){(if(and(= fq 0)(=(bf'eh)1)){(set-bms-val'bms-soc(/(dy(bufget-i16 cx gp))100.0))})(var n(/(bufget-i16 cx gp)1000.0))(set-bms-val'bms-v-cell fq n)(setq fq(+ fq 1))(setq h(+ h n))})})(set-bms-val'bms-v-tot h)})((and(= ek 3)(= cf 0)){(setq cf 1)(if(=(bf'eh)0){(set-bms-val'bms-soc(/(bufget-u8 cx 4)100.0))})})((and(= ek 5)(= bu 0)){(setq bu 1)(var fs 0.055)(var br(*(bufget-i16 cx 4)fs))(set-bms-val'bms-i-in-ic br)})((and(= ek 0)(= dq 0)){(setq dq 1)})((and(= ek 4)(= eb 0)){(setq eb 1)(set-bms-val'bms-temp-ic(bufget-i8 cx(-(buflen cx)3)))(looprange gp 4(-(buflen cx)3){(set-bms-val'bms-temps-adc(- gp 4)(bufget-i8 cx gp))})}))(setq i af)})})(free cx)})(setq i af)} {(setq i(+ i 1))})} {(setq i(+ i 1))})})(send-bms-can)}{ })(if(>=(bf'au)0){(if(and(>(secs-since ga)dm)(<(secs-since c)1)(or(= el 0)(> el 5))){(gpio-write(bf'au)1)(bl 0.1)(gpio-write(bf'au)0)})})})(setq bx(secs-since 0))(setq bg(+ bg 0.05))(var hp(- bg(secs-since 0)))(if(> hp 0){(bl hp)(setq bg(secs-since 0))})})})(ib)