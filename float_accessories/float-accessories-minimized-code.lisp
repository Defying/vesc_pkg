@const-symbol-strings(def dx -1)(def ba -1)(def cv -1)(def bo -1)(def j -1)(def ev -1)(def gk -1)(def ho -1)(def dq -1)(def gp -1)(def gi -1)(def ef -1)(def eu -1)(def gg -1)(def be -1)(def bx 1)(def am'())(def c'())(def id'())(def bk 0)(def eo -1)(def fm'())(def dy 31)(def en(systime))(def fh(systime))(def fs(systime))(def gj(systime))(def fe'(0xFF0000u32 0xFFFF00u32 0x00FF00u32 0x00FFFFu32 0x0000FFu32 0xFF00FFu32))(def k'(0x00FFFF00 0x0000FF00 0x0000FFFF 0x000000FF 0x00FF00FF 0x00FF0000))(def bs 101)(def bj 102)(def hy'((v . 0)(gt . 10)(fy . 24)(fg . 29)(bi . 202)))(def dp 0)(def hc 0)(def ds 0)(def at 0)(def dr 1)(def br 0)(def hh 0)(def dv 0)(def bt [0 0 0 0 1 2 3 4 5 7 8 11 14 16 18 19 25 30 33 37 43 48 53 60 67 71 76 82 92 97 100])(def hg 422i32)(def fx'((by .(0 i hg -1))(crc .(1 i 60967 -1))(dm .(2 i -1 -1))(fk .(3 b 1 -1))(bn .(4 b 1 -1))(cw .(5 i 0 -1))(hw .(6 i 5 -1))(es .(7 i 0 -1))(gf .(8 i 5 -1))(cp .(9 b 1 -1))(hr .(10 b 1 -1))(u .(11 f -4.0 -1))(di .(12 i 30 -1))(bv .(13 i 120 -1))(ei .(14 f 0.5 -1))(ea .(15 f 0.5 -1))(cd .(16 f 0.2 -1))(g .(17 f 0.5 -1))(s .(18 i -1 -1))(bf .(19 i 10 -1))(gy .(20 i 2 -1))(ie .(21 b 0 -1))(fo .(22 i 18 -1))(gb .(23 i 13 -1))(bg .(24 i 2 -1))(dk .(25 b 0 -1))(cc .(26 b 1 -1))(hs .(27 i 17 -1))(cr .(28 i 13 -1))(bq .(29 i 2 -1))(bh .(30 b 0 -1))(bl .(31 b 1 -1))(bu .(32 i -1 -1))(fj .(33 i -1 -1))(ep .(34 i 1 -1))(cm .(35 i -1 -1))(ax .(36 i -1 -1))(fp .(37 i -1 -1))(el .(38 i -1 -1))(fb .(39 i -1 -1))(fu .(40 i -1 -1))(cb .(41 i -1 -1))))@const-start(defun gn(bm){(var ez(length bm))(var gz(floor(/ ez 4.0)))(var ay(floor(* ez 3(/ 1 4.0))))(looprange i 0 ez {(if(and(>= i gz)(< i ay)){(if(or(= i gz)(= i(- ay 1))){(setix bm i 0x007F0000)} {(setix bm i 0x00FF0000)})} {(setix bm i 0x00000000)})})})(defun af(){(setq dp(mod(+ dp 1)2))(var co(if(= dp 0)0xFFFFFFFF 0x00000000))(he c co)(he id co)})(defun hp(){(setq hc(mod(+ hc 1)2))(he id(if(= hc 0)0x00FF0000 0x00000000))})(defun bc(fc){(var ed(ix k ds))(he c(if(= fc 0)ed 0xFF000000))(he id ed)(setq ds(mod(+ ds 1)6))})(defun max(ej b)(if(> ej b)ej b))(defun min(ej b)(if(< ej b)ej b))(defun bp(){(var aa(+(length c)(length id)))(looprange i 0 aa {(var hl(abs(- i at)))(var cu(max 0(- 255(* hl 51))))(var co(color-make cu 0 0))(if(< i(length c))(setix c i co)(setix id(- i(length c))co))})(setq at(+ at dr))(if(or(>= at aa)(< at 0))(setq dr(* dr -1)))})(defun ao(du){(var ez(length du))(var ct(floor(* ez bk)))(looprange e 0 ez {(var cz 0)(var eh 0)(if(or(< e ct)(and(= e 0)(<= ct 1))){(if(or(< bk 0.2)(and(= e 0)(<= ct 1))){(setq cz 255)(setq eh 0)} {(setq cz(floor(* 255(- 1(/ bk 0.8)))))(setq eh(floor(* 255(/ bk 0.8))))})} {(setq cz 0)(setq eh 0)})(var co 0x00)(setq co(bits-enc-int co 16 cz 8))(setq co(bits-enc-int co 8 eh 8))(setix du e co)})})(defun dl(){(var df(length fe))(looprange e 0(length c){(var er(mod(+ br e(length c))df))(var co(ix fe er))(setix c e co)})(looprange e 0(length id){(var er(mod(+ br e(length id))df))(var co(ix fe er))(setix id e co)})(setq br(mod(+ br 1)df))})(defun hi(){(var ft(mod hh 3))(var gb(length c))(var cr(length id))(var ag(floor(/ gb 2)))(var ah(floor(/ cr 2)))(cond((= ft 0){(looprange i 0 ag(setix c i 0x00000000))(looprange i ag gb(setix c i 0x00FF0000))(looprange i 0 ah(setix id i 0x00000000))(looprange i ah cr(setix id i 0x00FF0000))})((= ft 1){(looprange i 0 ag(setix c i 0x00FF0000))(looprange i ag gb(setix c i 0x000000FF))(looprange i 0 ah(setix id i 0x00FF0000))(looprange i ah cr(setix id i 0x000000FF))})((= ft 2){(looprange i 0 ag(setix c i 0x000000FF))(looprange i ag gb(setix c i 0x00000000))(looprange i 0 ah(setix id i 0x000000FF))(looprange i ah cr(setix id i 0x00000000))}))(setq hh(mod(+ hh 1)3))})(defun ae(){(if(> ev 250.0){(ga)}{(if(and(!= j 1)(!= j 2)(!= j 3)){(ao am)}{(gh j)})})})(defun ga(){(var bf(length am))(var ce(*(abs gp)1.1112))(var hm 0.0)(if(< ce 1.0){(setq hm ce)} {(setq hm 1.0)})(var fd(floor(* hm bf)))(var gq 0x00FFFF00u32)(if(>(abs gp)0.85){(setq gq 0x00FF0000u32)} {(if(>(abs gp)0.7){(setq gq 0x00FF8800u32)})})(looprange e 0 bf {(setix am e(if(< e fd)gq 0x00000000u32))})})(defun gh(j){(var bf(length am))(var m(if(or(= j 1)(= j 3))0xFF 0x00))(var gl(if(or(= j 2)(= j 3))0xFF 0x00))(looprange e 0 bf {(setix am e(if(< e(/ bf 2))m gl))})})(defun he(bm co){(looprange e 0(length bm){(setix bm e co)})})(defun hd(){(he am 0x00)(he c 0x00)(he id 0x00)})(defun cf(du){(looprange e 0(length du){(var co(color-split(ix du e)1))(var ck(color-make(ix co 1)(ix co 0)(ix co 2)(ix co 3)))(setix du e ck)})})(defun n(eb){(if(=(gw'ie)1){(setq am(reverse am))})(if(=(gw'dk)1){(setq c(reverse c))})(if(=(gw'bh)1){(setq id(reverse id))})(var bn(gw'bn))(var ea(gw'ea))(var s(gw's))(var fo(gw'fo))(var hs(gw'hs))(var cc(gw'cc))(var bl(gw'bl))(var ic(if(and(>= eb 0)(!= bn 0))(to-i(* 0xFF ea))0x00))(var ch(if(and(< eb 0)(!= bn 0))(to-i(* 0xFF ea))0x00))(if(or(= cc 2)(= cc 3)){(setq c(append(list ic)c))})(if(or(= bl 2)(= bl 3)){(setq id(append(list ch)id))})(if(or(= cc 4)(= cc 5)){(var ai(take c(length c)))(setq c(dh(+(length c)4)0))(var ec 0)(looprange gx 0(length c){(if(or(and(= cc 4)(or(= gx 2)(= gx 7)(= gx 13)(= gx 18)))(and(= cc 5)(or(= gx 1)(= gx 5)(= gx 10)(= gx 3)))){(setix c gx ic)}{(setix c gx(ix ai ec))(setq ec(+ ec 1))})})})(if(or(= bl 4)(= bl 5)){(var ai(take id(length id)))(setq id(dh(+(length id)4)0))(var ec 0)(looprange gx 0(length id){(if(or(and(= bl 4)(or(= gx 2)(= gx 7)(= gx 13)(= gx 18)))(and(= bl 5)(or(= gx 1)(= gx 5)(= gx 10)(= gx 3)))){(setix id gx ch)}{(setix id gx(ix ai ec))(setq ec(+ ec 1))})})})(var gy(gw'gy))(var bg(gw'bg))(var bq(gw'bq))(var gb(length c))(var cr(length id))(if(and(>= fo 0)(= s fo)(= fo hs)){(var gv(append am c id))(var aa(length gv))(var hz(rgbled-buffer aa gy))(rgbled-color hz 0 gv bx)(if(not-eq(first(trap(rgbled-init fo bg)))'exit-ok){(et'fo -1)(cn"Invalid Pin")(gs'fo -1)(gs'crc(p))}{(hx 0.01)(rgbled-update hz)(hx 0.01)})(free hz)} {(if(and(>= fo 0)(= fo hs)){(var gv(append c id))(var aa(length gv))(var hz(rgbled-buffer aa bg))(rgbled-color hz 0 gv bx)(if(not-eq(first(trap(rgbled-init fo bg)))'exit-ok){(et'fo -1)(cn"Invalid Pin")(gs'fo -1)(gs'crc(p))}{(hx 0.01)(rgbled-update hz)(hx 0.01)})(free hz)}{(if(and(>= s 0)(= s hs)){(if(!= gy bq)(cf am))(var gv(append am id))(var aa(length gv))(var hz(rgbled-buffer aa bq))(rgbled-color hz 0 gv bx)(if(not-eq(first(trap(rgbled-init s gy)))'exit-ok){(et's -1)(cn"Invalid Pin")(gs's -1)(gs'crc(p))}{(hx 0.01)(rgbled-update hz)(hx 0.01)})(free hz)}{(if(>= s 0){(var ia(rgbled-buffer(length am)gy))(rgbled-color ia 0 am(gw'g))(if(not-eq(first(trap(rgbled-init s gy)))'exit-ok){(et's -1)(cn"Invalid Pin")(gs's -1)(gs'crc(p))}{(hx 0.01)(rgbled-update ia)(hx 0.01)})(free ia)})(if(>= hs 0){(var aw(rgbled-buffer cr gy))(rgbled-color aw 0 id bx)(if(not-eq(first(trap(rgbled-init hs bq)))'exit-ok){(et'hs -1)(cn"Invalid Pin")(gs'hs -1)(gs'crc(p))}{(hx 0.01)(rgbled-update aw)(hx 0.01)})(free aw)})})(if(>= fo 0){(var ek(rgbled-buffer gb gy))(rgbled-color ek 0 c bx)(if(not-eq(first(trap(rgbled-init fo bg)))'exit-ok){(et'fo -1)(cn"Invalid Pin")(gs'fo -1)(gs'crc(p))}{(hx 0.01)(rgbled-update ek)(hx 0.01)})(free ek)})})})})(defunret bz(){(var aj'())(var ab(gw'dm))(et'dm -1)(var an(systime))(loopwhile-thd 150(<=(secs-since an)10){(if(and(>= ab 0)(<=(secs-since an)5)){(setq aj(list ab))}{(setq aj(can-scan))})(loopforeach dm aj {(setq eo dm)(da dm(list(assoc hy'v)))(hx 0.5)(if(>=(gw'dm)0){(if(not-eq(gw'dm)ab){(gs'dm(gw'dm))(gs'crc(p))})(return 1)})})})(return 0)})(defun da(dm w){(send-data(append(list bs)w)2 dm)})(defun status (){(var o"status ")(setq o(str-merge o(str-from-n(if(<(secs-since gj)1)1 0)"%d ")))(setq o(str-merge o(str-from-n(if(<(secs-since en)1)1 0)"%d ")))(setq o(str-merge o(str-from-n(if(<(secs-since fh)1)1 0)"%d ")))(send-data o)})(defun fl(){(var bu(gw'bu))(var fj(gw'fj))(uart-stop)(if(>= fj 0){(if(not-eq(first(trap(gpio-configure fj'pin-mode-out)))'exit-ok){(et'fj -1)(cn"Invalid Pin")(gs'fj -1)(gs'crc(p))})})(if(>= bu 0){(if(not-eq(first(trap(gpio-configure bu'pin-mode-in-pu)))'exit-ok){(et'bu -1)(cn"Invalid Pin")(gs'bu -1)(gs'crc(p))}{(uart-start 1 bu -1 115200)(set-bms-val'bms-cell-num 15)(set-bms-val'bms-temp-adc-num 4)(set-bms-val'bms-temp-cell-max 45)})})})(defunret gw(dz){(var hq(assoc fx dz))(if hq(return(car(cdr(cdr(cdr hq)))))(return nil))})(defun save-config(){(loopforeach ht fx {(var dz(first ht))(if(eq dz'crc){(gs dz(p))}{(gs dz(gw dz))})})(send-data"Settings Saved!")})(defunret p(){(var i 0)(var fi(-(length fx)1))(var h(bufcreate fi))(loopforeach ht fx {(var dz(first ht))(if(not-eq dz'crc){(bufset-i32 h i(gw dz))(+ i 1)})})(var crc(crc16 h))(free h)(return crc)})(defun bw(){(loopforeach ht fx {(var dz(first ht))(var dd(ff dz))(et dz dd)})})(defun restore-config(){(loopforeach ht fx {(var dz(first ht))(var ge(if(eq dz'by)hg(ix ht 3)))(gs dz ge)})(bw)(send-data"Settings Restored!")})(defun ff(dz)(let((y(first(assoc fx dz)))(fc(second(assoc fx dz))))(cond((eq fc'i)(eeprom-read-i y))((eq fc'f)(eeprom-read-f y))((eq fc'b)(eeprom-read-i y)))))(defun gs(dz dd)(let((y(first(assoc fx dz)))(fc(second(assoc fx dz))))(cond((eq fc'i)(eeprom-store-i y dd))((eq fc'f)(eeprom-store-f y dd))((eq fc'b)(eeprom-store-i y dd)))))(defun cn(ey)(send-data(str-merge"msg "ey)))(defun dh(ar dd)(map(fn(x)dd)(range ar)))(defun gd(){(if(!=(str-cmp(to-str(sysinfo'hw-type))"hw-express")0){(exit-error"ap running on hw-express")})(var dc(+(first(sysinfo'fw-ver))(*(second(sysinfo'fw-ver))0.01)))(if(< dc 6.05)(exit-error"hw-express ib au hf running 6.05"))(if(not-eq(ff'by)hg)(restore-config)(bw))(if(!=(p)(to-i(ff'crc))){(cn"Error: crc corrupt")(restore-config)})(spawn hn)(event-register-handler(spawn fr))(event-enable'event-data-rx)(spawn bz)(if(=(conf-get'wifi-mode)0){(cn"WiFi is disabled. Please enable and reboot.")}{(event-enable'event-esp-now-rx)(setq fm(list(gw'cm)(gw'ax)(gw'fp)(gw'el)(gw'fb)(gw'fu)))(ac fm)(spawn hk)})(fl)(spawn dn)})(defun recv-config(fk bn cw hw es gf cp hr u di bv ei ea cd g s bf gy ie fo gb bg dk cc hs cr bq bh bl bu fj ep){(et'fk(to-i fk))(et'bn(to-i bn))(et'cw(to-i cw))(et'hw(to-i hw))(et'es(to-i es))(et'gf(to-i gf))(et'cp(to-i cp))(et'hr(to-i hr))(et'u(to-float u))(et'di(to-i di))(et'bv(to-i bv))(et'ei(to-float ei))(et'ea(to-float ea))(et'cd(to-float cd))(et'g(to-float g))(et's(to-i s))(et'bf(to-i bf))(et'gy(to-i gy))(et'ie(to-i ie))(et'fo(to-i fo))(et'gb(to-i gb))(et'bg(to-i bg))(et'dk(to-i dk))(et'cc(to-i cc))(et'hs(to-i hs))(et'cr(to-i cr))(et'bq(to-i bq))(et'bh(to-i bh))(et'bl(to-i bl))(var fz(gw'bu))(et'bu(to-i bu))(var gm(gw'fj))(et'fj(to-i fj))(et'ep(to-i ep))(if(or(!=(to-i bu)fz)(!=(to-i fj)gm)){(fl)})})(defun z(fv)(let((db(max 0(min(- fv 2700)(- 1500 1)))))(let((i(* db(/ 30.0 1500))))(let((hu(floor i)))(let((f(- i hu)))(let((ej(bufget-u8 bt hu))(b(bufget-u8 bt(+ hu 1))))(max 0(min(round(+ ej(* f(- b ej))))100))))))))(defun hj(aq){(atomic {(if(and(>(buflen aq)1)(=(bufget-u8 aq 0)bj)){(bufcpy aq 0 aq 1(-(buflen aq)1))(eval(read aq))})})(if(and(>(buflen aq)1)(=(bufget-u8 aq 0)bs)){(setq gj(systime))(match(cossa hy(bufget-u8 aq 1))(v {(et'dm eo)})(bi {(var ca(bufget-u8 aq 2))(et'fk(bits-dec-int ca 0 1))(et'bn(bits-dec-int ca 1 1))})(fy {(setq bo(bufget-u8 aq 2))(setq dx(bufget-u8 aq 3))(if(= bo 3){(setq ba 0.0)(setq gp(bufget-u8 aq 4))}{(setq ba(to-float(bufget-i8 aq 4)))(setq gp 0.0)})(setq ev(/(to-float(bufget-i16 aq 5))10))(setq dq(/(to-float(bufget-i16 aq 7))10))(setq gk(/(to-float(bufget-i16 aq 9))10))(et'ei(/(bufget-u8 aq 11)100.0))(et'cd(/(bufget-u8 aq 12)100.0))(et'g(/(bufget-u8 aq 13)100.0))})(fg {(setq bk(/(bufget-u8 aq 2)100.0))})(gt {(var cx(bufget-u8 aq 2))(if(= cx 69){(setq dx(bufget-u8 aq 3))} {(setq ba(/(to-float(bufget-i16 aq 5))10))(setq cv(/(to-float(bufget-i16 aq 7))10))(setq bo(bufget-u8 aq 9))(setq j(bufget-u8 aq 10))(setq gk(/(to-float(bufget-i16 aq 22))10))(setq ev(to-float(bufget-i16 aq 24)))(setq ho(/(to-float(bufget-i16 aq 26))10))(setq dq(/(to-float(bufget-i16 aq 28))10))(setq gp(-(/(bufget-u8 aq 30)100.0)0.5))(if(>= cx 2){(setq gi(bufget-f32 aq 34))(setq ef(/(bufget-u8 aq 38)2.0))(setq eu(/(bufget-u8 aq 39)2.0))})(if(>= cx 3){(setq gg(bufget-u32 aq 41))(setq be(/(bufget-u8 aq 53)2.0))})})})(_ nil))})(free aq)})(defun hn(){(var eb 0)(var ex 0)(var ha(secs-since 0))(var cj 0)(var a 0)(loopwhile-thd 100 t {(setq cj(secs-since 0))(var dm(gw'dm))(da dm(append(list(assoc hy'fy))'(102 108 111 97 116 45 97 99 99 101 115 115 111 114 105 101 115 49 46 48 0)))(da dm(list(assoc hy'bi)))(da dm(list(assoc hy'fg)))(if(=(gw'fk)1){(setq am(dh(gw'bf)0))(setq c(dh(gw'gb)0))(setq id(dh(gw'cr)0))(setq eb 0)(var cg 10)(if(= bo 4)(setq cg(*cg -1)))(if(> ev cg){(setq eb 1)})(if(< ev(* cg -1)){(setq eb -1)})(if(=(gw'cp)1){(if(> ba 70)(setq ex 1)(setq ex 0))})(fw(secs-since fs)eb ex)(if(or(!= eb 0)(= ex 1)){(setq fs(systime))})} {(hd)})(n eb)(setq ha(+ ha 0.1))(var hv(- ha(secs-since 0)))(if(> hv 0){(hx hv)(setq ha(secs-since 0))})})})(defun send-config(){(var hb"settings ")(loopforeach ht fx {(let((dz(first ht))(fc(third ht))){(var value(ff dz))(setq hb(str-merge hb(cond((eq fc'b)(str-from-n value"%d "))((eq fc'i)(str-from-n value"%d "))((eq fc'f)(str-from-n value"%.2f ")))))})})(send-data hb)(send-data"Settings Read!")})(defun ac(gu){(esp-now-start)(esp-now-del-peer fm)(esp-now-add-peer fm)})(defun pair-pubmote(av){(if(=(conf-get'wifi-mode)0){(cn"WiFi is disabled. Please enable and reboot.")}{(cond((>= av 0){(et'cb av)(setq dy(systime))(setq dv 1)})((= av -1){(ac fm)(gs'cm(ix fm 0))(gs'ax(ix fm 1))(gs'fp(ix fm 2))(gs'el(ix fm 3))(gs'fb(ix fm 4))(gs'fu(ix fm 5))(gs'cb cb)(gs'crc(p))(setq dv 0)})((= av -2){(setq fm'())(gs'cm -1)(gs'crc(p))(setq dv 0)}))})})(defun hk(){(var ha(secs-since 0))(var cj 0)(var a 0)(loopwhile-thd 100 t {(setq cj(secs-since 0))(if(and(>(secs-since dy)30)(>= dv 2)){(atomic(pair-pubmote -2))})(if(= dv 1){(esp-now-del-peer fm)(setq fm'(255 255 255 255 255 255))(esp-now-add-peer fm)(esp-now-send fm"42069")(esp-now-del-peer fm)(setq dv 2)})(if(and(= dv 0)(>=(gw'cm)0)(<=(secs-since en)5)(>=(gw'dm)0)){(da(gw'dm)(list(assoc hy'gt)3))(var aq(bufcreate 32))(bufset-u8 aq 0 69)(bufset-u8 aq 1 dx)(bufset-i16 aq 2(floor(* ba 10)))(bufset-i16 aq 4(floor(* cv 10)))(bufset-u8 aq 6 bo)(bufset-u8 aq 7 j)(bufset-i16 aq 8(floor(* gk 10)))(bufset-i16 aq 10(floor ev))(bufset-i16 aq 12(floor(* ho 10)))(bufset-i16 aq 14(floor(* dq 10)))(bufset-u8 aq 16(floor(*(+ gp 0.5)100)))(bufset-f32 aq 17 gi'little-endian)(bufset-u8 aq 21(floor(* ef 2)))(bufset-u8 aq 22(floor(* eu 2)))(bufset-u32 aq 23 gg)(bufset-u8 aq 27(floor(* be 2)))(bufset-i32 aq 28(gw'cb))(esp-now-send fm aq)(free aq)})(setq a(secs-since 0))(setq ha(+ ha 0.05))(var hv(- ha(secs-since 0)))(if(> hv 0){(hx hv)(setq ha(secs-since 0))})})})(defun fr()(loopwhile t(recv((event-esp-now-rx(? gu)(? gr)(? aq)(? fq))(al gu gr aq fq))((event-data-rx .(? aq))(hj aq))(_ nil))))(defun et(dz value){(let((hq(assoc fx dz)))(if hq(loopforeach de fx {(if(eq(car de)dz)(setcdr de(list(car(cdr de))(car(cdr(cdr de)))(car(cdr(cdr(cdr de))))value)))})(setq fx(cons(cons dz(list 0'fc 0 value))fx))))})(defun al(gu gr aq fq){(if(= dv 2){(setq fm gu)(esp-now-add-peer fm)(esp-now-send fm(gw'cb))(esp-now-del-peer fm)(setq dv 3)}{(if(and(=(buflen aq)15)(=(bufget-i32 aq 11)(gw'cb))){(setq en(systime))(var jsx(bufget-f32 aq 0'little-endian))(var jsy(bufget-f32 aq 4'little-endian))(var bt-c(bufget-u8 aq 8))(var bt-z(bufget-u8 aq 9))(var is-rev(bufget-u8 aq 10))(ee(gw'dm)(cy(to-str(list jsy jsx bt-c bt-z is-rev))"(""(set-remote-state "))})})})(defun hx(x)(yield(* x 1000000)))@const-end(defun fw(q eb ex){(var di(gw'di))(var r(secs-since gj))(if(>(length am)0){(if(=(gw'es)0)(ae))})(var bb(gw'cw))(setq bx(gw'ei))(var di(gw'di))(if(and(>= q di)(<= r 1)){(setq bb(gw'hw))(setq bx(gw'cd))})(if(and(<=(secs-since 0)di)(= eb 0))(setq bb(gw'gf)))(if(and(>(length c)0)(>(length id)0)){(cond((= bo 15){(hd)(gn am)(gn c)})((and(> q(gw'bv))(< r 1)){(hd)})((and(or(= bb 1)(= ex 1))(< r 1)){(ao c)(ao id)})((or(= bb 0)(and(> r 1)(>(secs-since 0)di))){(he(if(>= eb 0)c id)0xFFFFFFFFu32)(he(if(< eb 0)c id)0x00FF0000u32)})((= bb 2){(he(if(>= eb 0)c id)0x0000FFFFu32)(he(if(< eb 0)c id)0x00FF00FFu32)})((= bb 3){(he(if(>= eb 0)c id)0x000000FFu32)(he(if(< eb 0)c id)0x0000FF00u32)})((= bb 4){(he(if(>= eb 0)c id)0x00FFFF00u32)(he(if(< eb 0)c id)0x0000FF00u32)})((= bb 5){(dl)})((= bb 6){(af)})((= bb 7){(bc 0)})((= bb 8){(bc 1)})((= bb 9){(bp)})((= bb 10){(hi)}))(if(and(=(gw'hr)1)(<= dq(gw'u)))(hp))})})(defun dn(){(var l 5)(var ha(secs-since 0))(var cj 0)(var a 0)(var az(bufcreate 64))(loopwhile-thd 100 t {(setq cj(secs-since 0))(if(>=(gw'bu)0){(var bd(uart-read az(buflen az)nil nil 0.5))(if(> bd 5){(var ci 0)(var eg 0)(var ew 0)(var dt 0)(var cl 0)(var i 0)(loopwhile(and(< i(- bd 5))(not(and(= ci 1)(= eg 1)(= ew 1)(= dt 1)(= cl 1)))){(if(and(<(+ i 2)bd)(=(bufget-u8 az i)0xFF)(=(bufget-u8 az(+ i 1))0x55)(=(bufget-u8 az(+ i 2))0xAA)){(setq fh(systime))(if(<(+ i 3)bd){(var cq(bufget-u8 az(+ i 3)))(var fa(+ i 4))(loopwhile(and(< fa(- bd 2))(not(and(<(+ fa 2)bd)(=(bufget-u8 az fa)0xFF)(=(bufget-u8 az(+ fa 1))0x55)(=(bufget-u8 az(+ fa 2))0xAA)))){(setq fa(+ fa 1))})(var ar(- fa i))(if(>= ar 6){(var ad(bufcreate ar))(bufcpy ad 0 az i ar)(if(>=(buflen ad)2){(var crc(bufget-u16 az(- fa 2)))(var dj 0)(looprange gx 0(-(buflen ad)2){(setq dj(+ dj(bufget-u8 ad gx)))})(if(eq crc dj){(cond((and(= cq 2)(= eg 0)){(setq eg 1)(var em 0)(var dw 0)(looprange gx 4(-(buflen ad)4){(if(eq(mod gx 2)0){(if(and(= em 0)(=(gw'ep)1)){(set-bms-val'bms-soc(/(z(bufget-i16 ad gx))100.0))})(var cs(/(bufget-i16 ad gx)1000.0))(set-bms-val'bms-v-cell em cs)(setq em(+ em 1))(setq dw(+ dw cs))})})(set-bms-val'bms-v-tot dw)})((and(= cq 3)(= ew 0)){(setq ew 1)(if(=(gw'ep)0){(set-bms-val'bms-soc(/(bufget-u8 ad 4)100.0))})})((and(= cq 5)(= cl 0)){(setq cl 1)(var ak 0.055)(var dg(*(bufget-i16 ad 4)ak))(set-bms-val'bms-i-in-ic dg)})((and(= cq 0)(= ci 0)){(setq ci 1)})((and(= cq 4)(= dt 0)){(setq dt 1)(set-bms-val'bms-temp-ic(bufget-i8 ad(-(buflen ad)3)))(looprange gx 4(-(buflen ad)3){(set-bms-val'bms-temps-adc(- gx 4)(bufget-i8 ad gx))})}))(setq i fa)})})(free ad)})(setq i fa)} {(setq i(+ i 1))})} {(setq i(+ i 1))})})(send-bms-can)}{ })(if(>=(gw'fj)0){(if(and(>(secs-since fh)l)(<(secs-since gj)1)(or(= bo 0)(> bo 5))){(gpio-write(gw'fj)1)(hx 0.1)(gpio-write(gw'fj)0)})})})(setq a(secs-since 0))(setq ha(+ ha 0.05))(var hv(- ha(secs-since 0)))(if(> hv 0){(hx hv)(setq ha(secs-since 0))})})})(gd)