@const-symbol-strings(def ca -1)(def n -1)(def hh -1)(def hd -1)(def fg -1)(def an -1)(def cd -1)(def gy -1)(def gs -1)(def q -1)(def fz -1)(def gm -1)(def da -1)(def fh -1)(def ic -1)(def bv 1)(def en'())(def ds'())(def hj'())(def hv 0)(def gt -1)(def gz'())(def ap 31)(def ez 0)(def dd 0)(def cv 0)(def bn 0)(def ii'(0xFF0000u32 0xFFFF00u32 0x00FF00u32 0x00FFFFu32 0x0000FFu32 0xFF00FFu32))(def ef'(0x00FFFF00 0x0000FF00 0x0000FFFF 0x000000FF 0x00FF00FF 0x00FF0000))(def dp 0)(def du 420i32)(def ia'((fk .(0 i du -1))(crc .(1 i 60967 -1))(cm .(2 i -1 -1))(cy .(3 b 1 -1))(ax .(4 b 1 -1))(ik .(5 i 0 -1))(bc .(6 i 5 -1))(dl .(7 i 0 -1))(hf .(8 i 5 -1))(bm .(9 b 1 -1))(cj .(10 b 1 -1))(v .(11 f -4.0 -1))(im .(12 i 30 -1))(aw .(13 i 120 -1))(hw .(14 f 0.5 -1))(dv .(15 f 0.5 -1))(ar .(16 f 0.2 -1))(gk .(17 f 0.5 -1))(ha .(18 i -1 -1))(fe .(19 i 10 -1))(fs .(20 i 2 -1))(hr .(21 b 0 -1))(dc .(22 i 18 -1))(am .(23 i 13 -1))(dm .(24 i 2 -1))(fj .(25 b 0 -1))(ep .(26 b 0 -1))(bq .(27 i 17 -1))(fw .(28 i 13 -1))(fm .(29 i 2 -1))(hk .(30 b 0 -1))(p .(31 b 0 -1))(ai .(32 i -1 -1))(fa .(33 i -1 -1))(br .(34 i 1 -1))(w .(35 i -1 -1))(aj .(36 i -1 -1))(dn .(37 i -1 -1))(l .(38 i -1 -1))(ak .(39 i -1 -1))(ck .(40 i -1 -1))(cq .(41 i -1 -1))))@const-start(def al 0)(defun cp(){(setq al(mod(+ al 1)2))(var ao(if(= al 0)0xFFFFFFFF 0x00000000))(looprange i 0(length ds){(setix ds i ao)})(looprange i 0(length hj){(setix hj i ao)})})(def ba 0)(defun gr(){(setq ba(mod(+ ba 1)2))(var ao(if(= ba 0)0x00FF0000 0x00000000))(looprange i 0(length hj){(setix hj i ao)})})(def ig 0)(defun fy(){(var cr(ix ef ig))(looprange i 0(length ds)(setix ds i cr))(looprange i 0(length hj)(setix hj i cr))(setq ig(mod(+ ig 1)6))})(def bi 0)(defun bg(){(var di(bufget-u32 ef(* bi 4)))(looprange i 0(length ds)(setix ds i 0xFFFFFFFF))(looprange i 0(length hj)(setix hj i di))(setq bi(mod(+ bi 1)6))})(def e 0)(def de 1)(defun max(cw b)(if(> cw b)cw b))(defun min(cw b)(if(< cw b)cw b))(defun ay(){(var fl(+(length ds)(length hj)))(looprange i 0 fl {(var ek(abs(- i e)))(var ff(max 0(- 255(* ek 51))))(var ao(color-make ff 0 0))(if(< i(length ds))(setix ds i ao)(setix hj(- i(length ds))ao))})(setq e(+ e de))(if(or(>= e fl)(< e 0))(setq de(* de -1)))})(defun hi(hl){(var et(length hl))(var fb(floor(* et hv)))(looprange dq 0 et {(var ey 0)(var gh 0)(if(or(< dq fb)(and(= dq 0)(<= fb 1))){(if(or(< hv 0.2)(and(= dq 0)(<= fb 1))){(setq ey 255)(setq gh 0)} {(setq ey(floor(* 255(- 1(/ hv 0.8)))))(setq gh(floor(* 255(/ hv 0.8))))})} {(setq ey 0)(setq gh 0)})(var ao 0x00)(setq ao(bits-enc-int ao 16 ey 8))(setq ao(bits-enc-int ao 8 gh 8))(setix hl dq ao)})})(def gb 0)(defun ea(){(var dr(length ii))(looprange dq 0(length ds){(var hp(mod(+ gb dq(length ds))dr))(var ao(ix ii hp))(setix ds dq ao)})(looprange dq 0(length hj){(var hp(mod(+ gb dq(length hj))dr))(var ao(ix ii hp))(setix hj dq ao)})(setq gb(mod(+ gb 1)dr))})(def c 0)(defun cl(){(var aq(mod c 3))(var am(length ds))(var fw(length hj))(var eo(floor(/ am 2)))(var ec(floor(/ fw 2)))(cond((= aq 0){(looprange i 0 eo(setix ds i 0x00000000))(looprange i eo am(setix ds i 0x00FF0000))(looprange i 0 ec(setix hj i 0x00000000))(looprange i ec fw(setix hj i 0x00FF0000))})((= aq 1){(looprange i 0 eo(setix ds i 0x00FF0000))(looprange i eo am(setix ds i 0x000000FF))(looprange i 0 ec(setix hj i 0x00FF0000))(looprange i ec fw(setix hj i 0x000000FF))})((= aq 2){(looprange i 0 eo(setix ds i 0x000000FF))(looprange i eo am(setix ds i 0x00000000))(looprange i 0 ec(setix hj i 0x000000FF))(looprange i ec fw(setix hj i 0x00000000))}))(setq c(mod(+ c 1)3))})(defun gq(){(if(> an 250.0){(bh)}{(if(and(!= fg 1)(!= fg 2)(!= fg 3)){(hi en)}{(k fg)})})})(defun bh(){(var fe(length en))(var fq(*(abs q)1.1112))(var hc 0.0)(if(< fq 1.0){(setq hc fq)} {(setq hc 1.0)})(var fo(floor(* hc fe)))(var hb 0x00FFFF00u32)(if(>(abs q)0.85){(setq hb 0x00FF0000u32)} {(if(>(abs q)0.7){(setq hb 0x00FF8800u32)})})(looprange dq 0 fe {(setix en dq(if(< dq fo)hb 0x00000000u32))})})(defun k(fg){(var fe(length en))(var ce(if(or(= fg 1)(= fg 3))0xFF 0x00))(var r(if(or(= fg 2)(= fg 3))0xFF 0x00))(looprange dq 0 fe {(setix en dq(if(< dq(/ fe 2))ce r))})})(defun dg(){(looprange dq 0(length en){(setix en dq 0x00)})(looprange dq 0(length ds){(setix ds dq 0x00)})(looprange dq 0(length hj){(setix hj dq 0x00)})})(defun ho(hl){(looprange dq 0(length hl){(var ao(color-split(ix hl dq)1))(var cf(color-make(ix ao 1)(ix ao 0)(ix ao 2)(ix ao 3)))(setix hl dq cf)})})(defun g(ih){(if(=(hg'hr)1){(setq en(reverse en))})(if(=(hg'fj)1){(setq ds(reverse ds))})(if(=(hg'hk)1){(setq hj(reverse hj))})(var ax(hg'ax))(var dv(hg'dv))(var ha(hg'ha))(var dc(hg'dc))(var bq(hg'bq))(var ep(hg'ep))(var p(hg'p))(var ci(if(or(< ih 0)(= ax 0))0x00(to-i(* 0xFF dv))))(var he(if(or(>= ih 0)(= ax 0))0x00(to-i(* 0xFF dv))))(if(= ep 1){(setq ds(append(list ci)ds))})(if(= p 1){(setq hj(append(list he)hj))})(if(or(= ep 2)(= ep 3)){(var o(take ds(length ds)))(setq ds(bz(+(length ds)4)0))(var bo 0)(looprange dx 0(length ds){(if(or(and(= ep 2)(or(= dx 2)(= dx 7)(= dx 13)(= dx 18)))(and(= ep 3)(or(= dx 1)(= dx 5)(= dx 10)(= dx 3)))){(setix ds dx ci)}{(setix ds dx(ix o bo))(setq bo(+ bo 1))})})})(if(or(= p 2)(= p 3)){(var o(take hj(length hj)))(setq hj(bz(+(length hj)4)0))(var bo 0)(looprange dx 0(length hj){(if(or(and(= p 2)(or(= dx 2)(= dx 7)(= dx 13)(= dx 18)))(and(= p 3)(or(= dx 1)(= dx 5)(= dx 10)(= dx 3)))){(setix hj dx he)}{(setix hj dx(ix o bo))(setq bo(+ bo 1))})})})(var fs(hg'fs))(var dm(hg'dm))(var fm(hg'fm))(var am(length ds))(var fw(length hj))(if(and(>= dc 0)(= ha dc)(= dc bq)){(var cc(append en ds hj))(var fl(length cc))(var s(rgbled-buffer fl fs))(rgbled-color s 0 cc bv)(if(not-eq(first(trap(rgbled-init dc dm)))'exit-ok){(cu'dc -1)(db"Invalid Pin")(gg'dc -1)(gg'crc(bj))}{(cs 0.01)(rgbled-update dz)(cs 0.01)})(free s)} {(if(and(>= dc 0)(= dc bq)){(var cc(append ds hj))(var fl(length cc))(var s(rgbled-buffer fl dm))(rgbled-color s 0 cc bv)(if(not-eq(first(trap(rgbled-init dc dm)))'exit-ok){(cu'dc -1)(db"Invalid Pin")(gg'dc -1)(gg'crc(bj))}{(cs 0.01)(rgbled-update dz)(cs 0.01)})(free s)}{(if(and(>= ha 0)(= ha bq)){(if(!= fs fm)(ho en))(var cc(append en hj))(var fl(length cc))(var s(rgbled-buffer fl fm))(rgbled-color s 0 cc bv)(if(not-eq(first(trap(rgbled-init ha fs)))'exit-ok){(cu'ha -1)(db"Invalid Pin")(gg'ha -1)(gg'crc(bj))}{(cs 0.01)(rgbled-update dt)(cs 0.01)})(free s)}{(if(>= ha 0){(var dt(rgbled-buffer(length en)fs))(rgbled-color dt 0 en(hg'gk))(if(not-eq(first(trap(rgbled-init ha fs)))'exit-ok){(cu'ha -1)(db"Invalid Pin")(gg'ha -1)(gg'crc(bj))}{(cs 0.01)(rgbled-update dt)(cs 0.01)})(free dt)})(if(>= bq 0){(var bt(rgbled-buffer fw fs))(rgbled-color bt 0 hj bv)(if(not-eq(first(trap(rgbled-init bq fm)))'exit-ok){(cu'bq -1)(db"Invalid Pin")(gg'bq -1)(gg'crc(bj))}{(cs 0.01)(rgbled-update bt)(cs 0.01)})(free bt)})})(if(>= dc 0){(var dz(rgbled-buffer am fs))(rgbled-color dz 0 ds bv)(if(not-eq(first(trap(rgbled-init dc dm)))'exit-ok){(cu'dc -1)(db"Invalid Pin")(gg'dc -1)(gg'crc(bj))}{(cs 0.01)(rgbled-update dz)(cs 0.01)})(free dz)})})})})(defunret fd(){(var dk'())(var cb(hg'cm))(cu'cm -1)(var fi(systime))(loopwhile-thd 150(<=(secs-since fi)10){(if(and(>= cb 0)(<=(secs-since fi)5)){(setq dk(list cb))}{(setq dk(can-scan))})(loopforeach cm dk {(setq gt cm)(bw cm(list(assoc ah'fc)))(cs 0.5)(if(>=(hg'cm)0){(if(not-eq(hg'cm)cb){(gg'cm(hg'cm))(gg'crc(bj))})(return 1)})})})(return 0)})(def bs 101)(def ie 102)(def ah'((fc . 0)(es . 10)(hz . 24)(gv . 29)(ac . 202)))(defun bw(cm ed){(send-data(append(list bs)ed)2 cm)})(defun status (){(var hn"status ")(setq hn(str-merge hn(str-from-n(if(<(secs-since bn)1)1 0)"%d ")))(setq hn(str-merge hn(str-from-n(if(<(secs-since ez)1)1 0)"%d ")))(setq hn(str-merge hn(str-from-n(if(<(secs-since dd)1)1 0)"%d ")))(send-data hn)})(defun h(){(var ai(hg'ai))(var fa(hg'fa))(uart-stop)(if(>= fa 0){(if(not-eq(first(trap(gpio-configure fa'pin-mode-out)))'exit-ok){(cu'fa -1)(db"Invalid Pin")(gg'fa -1)(gg'crc(bj))})})(if(>= ai 0){(if(not-eq(first(trap(gpio-configure ai'pin-mode-in-pu)))'exit-ok){(cu'ai -1)(db"Invalid Pin")(gg'ai -1)(gg'crc(bj))}{(uart-start 1 ai -1 115200)(set-bms-val'bms-cell-num 15)(set-bms-val'bms-temp-adc-num 4)(set-bms-val'bms-temp-cell-max 45)})})})(defunret hg(id){(var io(assoc ia id))(if io(return(car(cdr(cdr(cdr io)))))(return nil))})(defun save-config(){(loopforeach eb ia {(var id(first eb))(if(eq id'crc){(gg id(bj))}{(gg id(hg id))})})(send-data"Settings Saved!")})(defunret bj(){(var i 0)(var gp(-(length ia)1))(var gj(bufcreate gp))(loopforeach eb ia {(var id(first eb))(if(not-eq id'crc){(bufset-i32 gj i(hg id))(+ i 1)})})(var crc(crc16 gj))(free gj)(return crc)})(defun ej(){(loopforeach eb ia {(var id(first eb))(var fx(u id))(cu id fx)})})(defun restore-config(){(loopforeach eb ia {(var id(first eb))(var bk(if(eq id'fk)du(ix eb 3)))(gg id bk)})(ej)(send-data"Settings Restored!")})(defun u(id)(let((ge(first(assoc ia id)))(ch(second(assoc ia id))))(cond((eq ch'i)(eeprom-read-i ge))((eq ch'f)(eeprom-read-f ge))((eq ch'b)(eeprom-read-i ge)))))(defun gg(id fx)(let((ge(first(assoc ia id)))(ch(second(assoc ia id))))(cond((eq ch'i)(eeprom-store-i ge fx))((eq ch'f)(eeprom-store-f ge fx))((eq ch'b)(eeprom-store-i ge fx)))))(defun db(bu)(send-data(str-merge"msg "bu)))(defun bz(hs fx)(map(fn(x)fx)(range hs)))(defun ga(ih y bb){(var gd(if(< ih 0)y bb))(var fp(if(< ih 0)bb y))(looprange dq 0(length ds){(setix ds dq fp)})(looprange dq 0(length hj){(setix hj dq gd)})})(defun er(){(if(!=(str-cmp(to-str(sysinfo'hw-type))"hw-express")0){(exit-error"av running on hw-express")})(def ex(+(first(sysinfo'fw-ver))(*(second(sysinfo'fw-ver))0.01)))(if(< ex 6.05)(exit-error"hw-express em ij eh running 6.05"))(if(not-eq(u'fk)du)(restore-config)(ej))(if(!=(bj)(to-i(u'crc))){(db"Error: crc corrupt")(restore-config)})(spawn au)(event-register-handler(spawn df))(event-enable'event-data-rx)(spawn fd)(if(=(conf-get'wifi-mode)0){(db"WiFi is disabled. Please enable and reboot.")}{(event-enable'event-esp-now-rx)(setq gz(list(hg'w)(hg'aj)(hg'dn)(hg'l)(hg'ak)(hg'ck)))(fv gz)(spawn gl)})(h)(spawn ct)})(defun recv-config(cy ax ik bc dl hf bm cj v im aw hw dv ar gk ha fe fs hr dc am dm fj ep bq fw fm hk p ai fa br){(cu'cy(to-i cy))(cu'ax(to-i ax))(cu'ik(to-i ik))(cu'bc(to-i bc))(cu'dl(to-i dl))(cu'hf(to-i hf))(cu'bm(to-i bm))(cu'cj(to-i cj))(cu'v(to-float v))(cu'im(to-i im))(cu'aw(to-i aw))(cu'hw(to-float hw))(cu'dv(to-float dv))(cu'ar(to-float ar))(cu'gk(to-float gk))(cu'ha(to-i ha))(cu'fe(to-i fe))(cu'fs(to-i fs))(cu'hr(to-i hr))(cu'dc(to-i dc))(cu'am(to-i am))(cu'dm(to-i dm))(cu'fj(to-i fj))(cu'ep(to-i ep))(cu'bq(to-i bq))(cu'fw(to-i fw))(cu'fm(to-i fm))(cu'hk(to-i hk))(cu'p(to-i p))(var by(hg'ai))(cu'ai(to-i ai))(var ht(hg'fa))(cu'fa(to-i fa))(cu'br(to-i br))(if(or(!=(to-i ai)by)(!=(to-i fa)ht)){(h)})})(def hm [0 0 0 0 1 2 3 4 5 7 8 11 14 16 18 19 25 30 33 37 43 48 53 60 67 71 76 82 92 97 100])(defun ei(aa)(let((ev(max 0(min(- aa 2700)(- 1500 1)))))(let((i(* ev(/ 30.0 1500))))(let((ad(floor i)))(let((f(- i ad)))(let((cw(bufget-u8 hm ad))(b(bufget-u8 hm(+ ad 1))))(max 0(min(round(+ cw(* f(- b cw))))100))))))))(defun eu(gi){(atomic {(if(and(>(buflen gi)1)(=(bufget-u8 gi 0)ie)){(bufcpy gi 0 gi 1(-(buflen gi)1))(eval(read gi))})})(if(and(>(buflen gi)1)(=(bufget-u8 gi 0)bs)){(setq bn(systime))(match(cossa ah(bufget-u8 gi 1))(fc {(cu'cm gt)})(ac {(var gx(bufget-u8 gi 2))(cu'cy(bits-dec-int gx 0 1))(cu'ax(bits-dec-int gx 1 1))})(hz {(setq hd(bufget-u8 gi 2))(setq ca(bufget-u8 gi 3))(if(= hd 3){(setq n 0.0)(setq q(bufget-u8 gi 4))}{(setq n(to-float(bufget-i8 gi 4)))(setq q 0.0)})(setq an(/(to-float(bufget-i16 gi 5))10))(setq gs(/(to-float(bufget-i16 gi 7))10))(setq cd(/(to-float(bufget-i16 gi 9))10))(cu'hw(/(bufget-u8 gi 11)100.0))(cu'ar(/(bufget-u8 gi 12)100.0))(cu'gk(/(bufget-u8 gi 13)100.0))})(gv {(setq hv(/(bufget-u8 gi 2)100.0))})(es {(var gw(bufget-u8 gi 2))(if(= gw 69){(setq ca(bufget-u8 gi 3))} {(setq n(/(to-float(bufget-i16 gi 5))10))(setq hh(/(to-float(bufget-i16 gi 7))10))(setq hd(bufget-u8 gi 9))(setq fg(bufget-u8 gi 10))(setq cd(/(to-float(bufget-i16 gi 22))10))(setq an(to-float(bufget-i16 gi 24)))(setq gy(/(to-float(bufget-i16 gi 26))10))(setq gs(/(to-float(bufget-i16 gi 28))10))(setq q(-(/(bufget-u8 gi 30)100.0)0.5))(if(>= gw 2){(setq fz(bufget-f32 gi 34))(setq gm(/(bufget-u8 gi 38)2.0))(setq da(/(bufget-u8 gi 39)2.0))})(if(>= gw 3){(setq fh(bufget-u32 gi 41))(setq ic(/(bufget-u8 gi 53)2.0))})})})(_ nil))})(free gi)})(defun au(){(var ih 0)(var j 0)(var az 1)(var cx(systime))(var eg 0)(var dh 0)(var bd(secs-since 0))(var bx 0)(var gu 0)(loopwhile-thd 100 t {(setq bx(secs-since 0))(var cm(hg'cm))(bw cm(append(list(assoc ah'hz))'(102 108 111 97 116 45 97 99 99 101 115 115 111 114 105 101 115 49 46 48 0)))(bw cm(list(assoc ah'ac)))(bw cm(list(assoc ah'gv)))(if(=(hg'cy)1){(setq en(bz(hg'fe)0))(setq ds(bz(hg'am)0))(setq hj(bz(hg'fw)0))(setq ih 0)(var ew 10)(if(= hd 4)(setq ew(*ew -1)))(if(> an ew){(setq ih 1)})(if(< an(* ew -1)){(setq ih -1)})(if(=(hg'bm)1){(if(> n 70)(setq dh 1)(setq dh 0))})(if(= dp 1){(setq ih 0)(cu'im 10)(cu'aw 20)(if(<(secs-since cx)(hg'im)){(setq ih az)(setq az(* az -1))})})(dj(secs-since cv)j ih eg dh)(setq j ih)(if(or(!= ih 0)(= dh 1)){(setq eg 0)(setq cv(systime))})(if(< eg 2)(g ih))} {(dg)(g ih)})(setq bd(+ bd 0.1))(var cg(- bd(secs-since 0)))(if(> cg 0){(cs cg)(setq bd(secs-since 0))})})})(defun send-config(){(var cz"settings ")(loopforeach eb ia {(let((id(first eb))(ch(third eb))){(var value(u id))(setq cz(str-merge cz(cond((eq ch'b)(str-from-n value"%d "))((eq ch'i)(str-from-n value"%d "))((eq ch'f)(str-from-n value"%.2f ")))))})})(send-data cz)(send-data"Settings Read!")})(defun fv(dy){(esp-now-start)(esp-now-del-peer gz)(esp-now-add-peer gz)})(def hq 0)(defun pair-pubmote(z){(if(=(conf-get'wifi-mode)0){(db"WiFi is disabled. Please enable and reboot.")}{(cond((>= z 0){(cu'cq z)(setq ap(systime))(setq hq 1)})((= z -1){(fv gz)(gg'w(ix gz 0))(gg'aj(ix gz 1))(gg'dn(ix gz 2))(gg'l(ix gz 3))(gg'ak(ix gz 4))(gg'ck(ix gz 5))(gg'cq cq)(gg'crc(bj))(setq hq 0)})((= z -2){(setq gz'())(gg'w -1)(gg'crc(bj))(setq hq 0)}))})})(defun gl(){(var bd(secs-since 0))(var bx 0)(var gu 0)(loopwhile-thd 100 t {(setq bx(secs-since 0))(if(and(>(secs-since ap)30)(>= hq 2)){(atomic(pair-pubmote -2))})(if(= hq 1){(esp-now-del-peer gz)(setq gz'(255 255 255 255 255 255))(esp-now-add-peer gz)(esp-now-send gz"42069")(esp-now-del-peer gz)(setq hq 2)})(if(and(= hq 0)(>=(hg'w)0)(<=(secs-since ez)5)(>=(hg'cm)0)){(bw(hg'cm)(list(assoc ah'es)3))(var gi(bufcreate 32))(bufset-u8 gi 0 69)(bufset-u8 gi 1 ca)(bufset-i16 gi 2(floor(* n 10)))(bufset-i16 gi 4(floor(* hh 10)))(bufset-u8 gi 6 hd)(bufset-u8 gi 7 fg)(bufset-i16 gi 8(floor(* cd 10)))(bufset-i16 gi 10(floor an))(bufset-i16 gi 12(floor(* gy 10)))(bufset-i16 gi 14(floor(* gs 10)))(bufset-u8 gi 16(floor(*(+ q 0.5)100)))(bufset-f32 gi 17 fz'little-endian)(bufset-u8 gi 21(floor(* gm 2)))(bufset-u8 gi 22(floor(* da 2)))(bufset-u32 gi 23 fh)(bufset-u8 gi 27(floor(* ic 2)))(bufset-i32 gi 28(hg'cq))(esp-now-send gz gi)(free gi)})(setq gu(secs-since 0))(setq bd(+ bd 0.05))(var cg(- bd(secs-since 0)))(if(> cg 0){(cs cg)(setq bd(secs-since 0))})})})(defun df()(loopwhile t(recv((event-esp-now-rx(? dy)(? gn)(? gi)(? bp))(hx dy gn gi bp))((event-data-rx .(? gi))(eu gi))(_ nil))))(defun cu(id value){(let((io(assoc ia id)))(if io(loopforeach be ia {(if(eq(car be)id)(setcdr be(list(car(cdr be))(car(cdr(cdr be)))(car(cdr(cdr(cdr be))))value)))})(setq ia(cons(cons id(list 0'ch 0 value))ia))))})@const-end(defun hx(dy gn gi bp){(if(= hq 2){(setq gz dy)(esp-now-add-peer gz)(esp-now-send gz(hg'cq))(esp-now-del-peer gz)(setq hq 3)}{(if(and(=(buflen gi)15)(=(bufget-i32 gi 11)(hg'cq))){(setq ez(systime))(var jsx(bufget-f32 gi 0'little-endian))(var jsy(bufget-f32 gi 4'little-endian))(var bt-c(bufget-u8 gi 8))(var bt-z(bufget-u8 gi 9))(var is-rev(bufget-u8 gi 10))(dw(hg'cm)(co(to-str(list jsy jsx bt-c bt-z is-rev))"(""(set-remote-state "))})})(free gi)})(defun cs(x)(yield(* x 1000000)))(defun dj(ae j ih eg dh){(var im(hg'im))(var il(secs-since bn))(if(or(> il im)(< ae(hg'aw))){(if(>(length en)0){(if(=(hg'dl)0)(gq))})(var ee(hg'ik))(setq bv(hg'hw))(var im(hg'im))(if(>= il im){(setq ee 0)}{(if(and(<=(secs-since 0)im)(= ih 0))(setq ee(hg'hf)))(if(> ae im){(setq ee(hg'bc))(setq bv(hg'ar))})})(var y 0x00)(var bb 0x00)(if(and(>(length ds)0)(>(length hj)0)){(cond((or(= ee 1)(= dh 1)){(hi ds)(hi hj)})((= ee 0){(setq y 0xFFFFFFFFu32)(setq bb 0x00FF0000u32)(ga ih y bb)})((= ee 2){(setq y 0xFF00FFFFu32)(setq bb 0x00FF00FFu32)(ga ih y bb)})((= ee 3){(setq y 0xFF0000FFu32)(setq bb 0x0000FF00u32)(ga ih y bb)})((= ee 4){(setq y 0xFFFFFF00u32)(setq bb 0x0000FF00u32)(ga ih y bb)})((= ee 5){(ea)})((= ee 6){(cp)})((= ee 7){(fy)})((= ee 8){(bg)})((= ee 9){(ay)})((= ee 10){(cl)}))(if(and(=(hg'cj)1)(<= gs(hg'v)))(gr))})} {(if(< eg 2){(dg)(setq eg(+ eg 1))})})})(defun ct(){(var bf 5)(var bd(secs-since 0))(var bx 0)(var gu 0)(var hu(bufcreate 64))(loopwhile-thd 100 t {(setq bx(secs-since 0))(if(>=(hg'ai)0){(var at(uart-read hu(buflen hu)nil nil 0.5))(if(> at 5){(var a 0)(var af 0)(var m 0)(var gf 0)(var bl 0)(var i 0)(loopwhile(and(< i(- at 5))(not(and(= a 1)(= af 1)(= m 1)(= gf 1)(= bl 1)))){(if(and(<(+ i 2)at)(=(bufget-u8 hu i)0xFF)(=(bufget-u8 hu(+ i 1))0x55)(=(bufget-u8 hu(+ i 2))0xAA)){(setq dd(systime))(if(<(+ i 3)at){(var ib(bufget-u8 hu(+ i 3)))(var ag(+ i 4))(loopwhile(and(< ag(- at 2))(not(and(<(+ ag 2)at)(=(bufget-u8 hu ag)0xFF)(=(bufget-u8 hu(+ ag 1))0x55)(=(bufget-u8 hu(+ ag 2))0xAA)))){(setq ag(+ ag 1))})(var hs(- ag i))(if(>= hs 6){(var ab(bufcreate hs))(bufcpy ab 0 hu i hs)(if(>=(buflen ab)2){(var crc(bufget-u16 hu(- ag 2)))(var hy 0)(looprange dx 0(-(buflen ab)2){(setq hy(+ hy(bufget-u8 ab dx)))})(if(eq crc hy){(cond((and(= ib 2)(= af 0)){(setq af 1)(var cn 0)(var fu 0)(looprange dx 4(-(buflen ab)4){(if(eq(mod dx 2)0){(if(and(= cn 0)(=(hg'br)1)){(set-bms-val'bms-soc(/(ei(bufget-i16 ab dx))100.0))})(var fr(/(bufget-i16 ab dx)1000.0))(set-bms-val'bms-v-cell cn fr)(setq cn(+ cn 1))(setq fu(+ fu fr))})})(set-bms-val'bms-v-tot fu)})((and(= ib 3)(= m 0)){(setq m 1)(if(=(hg'br)0){(set-bms-val'bms-soc(/(bufget-u8 ab 4)100.0))})})((and(= ib 5)(= bl 0)){(setq bl 1)(var el 0.055)(var ft(*(bufget-i16 ab 4)el))(set-bms-val'bms-i-in-ic ft)})((and(= ib 0)(= a 0)){(setq a 1)})((and(= ib 4)(= gf 0)){(setq gf 1)(set-bms-val'bms-temp-ic(bufget-i8 ab(-(buflen ab)3)))(looprange dx 4(-(buflen ab)3){(set-bms-val'bms-temps-adc(- dx 4)(bufget-i8 ab dx))})}))(setq i ag)})})(free ab)})(setq i ag)} {(setq i(+ i 1))})} {(setq i(+ i 1))})})(send-bms-can)}{ })(if(>=(hg'fa)0){(if(and(>(secs-since dd)bf)(<(secs-since bn)1)(or(= hd 0)(> hd 5))){(gpio-write(hg'fa)1)(cs 0.1)(gpio-write(hg'fa)0)})})})(setq gu(secs-since 0))(setq bd(+ bd 0.05))(var cg(- bd(secs-since 0)))(if(> cg 0){(cs cg)(setq bd(secs-since 0))})})})(er)