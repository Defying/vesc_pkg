@const-symbol-strings(def gv -1)(def de -1)(def di -1)(def cp -1)(def gk -1)(def bf -1)(def fa -1)(def ba -1)(def fv -1)(def bs -1)(def bb -1)(def ex -1)(def eu -1)(def by -1)(def fb -1)(def ed 1)(def hu'())(def ez'())(def hw'())(def fx 0)(def ci -1)(def hg'())(def ej 31)(def h(systime))(def ih(systime))(def ig(systime))(def gz(systime))(def fz'(0xFF0000u32 0xFFFF00u32 0x00FF00u32 0x00FFFFu32 0x0000FFu32 0xFF00FFu32))(def cv'(0x00FFFF00 0x0000FF00 0x0000FFFF 0x000000FF 0x00FF00FF 0x00FF0000))(def bv 101)(def gd 102)(def bc'((eo . 0)(aa . 10)(ha . 24)(k . 29)(fj . 202)))(def z 0)(def cd 0)(def ar 0)(def bu 0)(def fg 1)(def cn 0)(def bz 0)(def ic 0)(def ca [0 0 0 0 1 2 3 4 5 7 8 11 14 16 18 19 25 30 33 37 43 48 53 60 67 71 76 82 92 97 100])(def fm 422i32)(def et'((gb .(0 i fm -1))(crc .(1 i 60967 -1))(ea .(2 i -1 -1))(ao .(3 b 1 -1))(gr .(4 b 1 -1))(fi .(5 i 0 -1))(eg .(6 i 5 -1))(cx .(7 i 0 -1))(gi .(8 i 5 -1))(ap .(9 b 1 -1))(hr .(10 b 1 -1))(bj .(11 f -4.0 -1))(ec .(12 i 30 -1))(aq .(13 i 120 -1))(bm .(14 f 0.5 -1))(hj .(15 f 0.5 -1))(ab .(16 f 0.2 -1))(hv .(17 f 0.5 -1))(fl .(18 i -1 -1))(bx .(19 i 10 -1))(hk .(20 i 2 -1))(aj .(21 b 0 -1))(p .(22 i 18 -1))(hn .(23 i 13 -1))(cs .(24 i 2 -1))(fq .(25 b 0 -1))(cm .(26 b 1 -1))(gf .(27 i 17 -1))(he .(28 i 13 -1))(em .(29 i 2 -1))(ia .(30 b 0 -1))(dr .(31 b 1 -1))(ct .(32 i -1 -1))(fy .(33 i -1 -1))(ew .(34 i 1 -1))(hc .(35 i -1 -1))(hd .(36 i -1 -1))(gn .(37 i -1 -1))(dv .(38 i -1 -1))(da .(39 i -1 -1))(gh .(40 i -1 -1))(ef .(41 i -1 -1))))@const-start(defun dz(bd){(var g(length bd))(var hp(floor(/ g 4.0)))(var ep(floor(* g 3(/ 1 4.0))))(looprange i 0 g {(if(and(>= i hp)(< i ep)){(if(or(= i hp)(= i(- ep 1))){(setix bd i 0x007F0000)} {(setix bd i 0x00FF0000)})} {(setix bd i 0x00000000)})})})(defun bi(){(setq z(mod(+ z 1)2))(var gu(if(= z 0)0xFFFFFFFF 0x00000000))(hx ez gu)(hx hw gu)})(defun en(){(setq cd(mod(+ cd 1)2))(hx hw(if(= cd 0)0x00FF0000 0x00000000))})(defun db(ds){(var ge(ix cv ar))(hx ez(if(= ds 0)ge 0xFF000000))(hx hw ge)(setq ar(mod(+ ar 1)6))})(defun max(el b)(if(> el b)el b))(defun min(el b)(if(< el b)el b))(defun bq(){(var gs(+(length ez)(length hw)))(looprange i 0 gs {(var gw(abs(- i bu)))(var az(max 0(- 255(* gw 51))))(var gu(color-make az 0 0))(if(< i(length ez))(setix ez i gu)(setix hw(- i(length ez))gu))})(setq bu(+ bu fg))(if(or(>= bu gs)(< bu 0))(setq fg(* fg -1)))})(defun dm(fw){(var g(length fw))(var s(floor(* g fx)))(looprange hh 0 g {(var co 0)(var gl 0)(if(or(< hh s)(and(= hh 0)(<= s 1))){(if(or(< fx 0.2)(and(= hh 0)(<= s 1))){(setq co 255)(setq gl 0)} {(setq co(floor(* 255(- 1(/ fx 0.8)))))(setq gl(floor(* 255(/ fx 0.8))))})} {(setq co 0)(setq gl 0)})(var gu 0x00)(setq gu(bits-enc-int gu 16 co 8))(setq gu(bits-enc-int gu 8 gl 8))(setix fw hh gu)})})(defun cf(){(var gt(length fz))(looprange hh 0(length ez){(var dk(mod(+ cn hh(length ez))gt))(var gu(ix fz dk))(setix ez hh gu)})(looprange hh 0(length hw){(var dk(mod(+ cn hh(length hw))gt))(var gu(ix fz dk))(setix hw hh gu)})(setq cn(mod(+ cn 1)gt))})(defun es(){(var gq(mod bz 3))(var hn(length ez))(var he(length hw))(var gm(floor(/ hn 2)))(var ax(floor(/ he 2)))(cond((= gq 0){(looprange i 0 gm(setix ez i 0x00000000))(looprange i gm hn(setix ez i 0x00FF0000))(looprange i 0 ax(setix hw i 0x00000000))(looprange i ax he(setix hw i 0x00FF0000))})((= gq 1){(looprange i 0 gm(setix ez i 0x00FF0000))(looprange i gm hn(setix ez i 0x000000FF))(looprange i 0 ax(setix hw i 0x00FF0000))(looprange i ax he(setix hw i 0x000000FF))})((= gq 2){(looprange i 0 gm(setix ez i 0x000000FF))(looprange i gm hn(setix ez i 0x00000000))(looprange i 0 ax(setix hw i 0x000000FF))(looprange i ax he(setix hw i 0x00000000))}))(setq bz(mod(+ bz 1)3))})(defun hy(){(if(> bf 250.0){(gg)}{(if(and(!= gk 1)(!= gk 2)(!= gk 3)){(dm hu)}{(fo gk)})})})(defun gg(){(var bx(length hu))(var ag(*(abs bs)1.1112))(var hs 0.0)(if(< ag 1.0){(setq hs ag)} {(setq hs 1.0)})(var bk(floor(* hs bx)))(var dh 0x00FFFF00u32)(if(>(abs bs)0.85){(setq dh 0x00FF0000u32)} {(if(>(abs bs)0.7){(setq dh 0x00FF8800u32)})})(looprange hh 0 bx {(setix hu hh(if(< hh bk)dh 0x00000000u32))})})(defun fo(gk){(var bx(length hu))(var dd(if(or(= gk 1)(= gk 3))0xFF 0x00))(var v(if(or(= gk 2)(= gk 3))0xFF 0x00))(looprange hh 0 bx {(setix hu hh(if(< hh(/ bx 2))dd v))})})(defun hx(bd gu){(looprange hh 0(length bd){(setix bd hh gu)})})(defun hb(){(hx hu 0x00)(hx ez 0x00)(hx hw 0x00)})(defun ce(fw){(looprange hh 0(length fw){(var gu(color-split(ix fw hh)1))(var ho(color-make(ix gu 1)(ix gu 0)(ix gu 2)(ix gu 3)))(setix fw hh ho)})})(defun m(av){(if(=(dw'aj)1){(setq hu(reverse hu))})(if(=(dw'fq)1){(setq ez(reverse ez))})(if(=(dw'ia)1){(setq hw(reverse hw))})(var gr(dw'gr))(var hj(dw'hj))(var fl(dw'fl))(var p(dw'p))(var gf(dw'gf))(var cm(dw'cm))(var dr(dw'dr))(var ie(if(and(>= av 0)(!= gr 0))(to-i(* 0xFF hj))0x00))(var hz(if(and(< av 0)(!= gr 0))(to-i(* 0xFF hj))0x00))(if(or(= cm 2)(= cm 3)){(setq ez(append(list ie)ez))})(if(or(= dr 2)(= dr 3)){(setq hw(append(list hz)hw))})(if(or(= cm 4)(= cm 5)){(var o(take ez(length ez)))(setq ez(cj(+(length ez)4)0))(var cb 0)(looprange fr 0(length ez){(if(or(and(= cm 4)(or(= fr 2)(= fr 7)(= fr 13)(= fr 18)))(and(= cm 5)(or(= fr 1)(= fr 5)(= fr 10)(= fr 3)))){(setix ez fr ie)}{(setix ez fr(ix o cb))(setq cb(+ cb 1))})})})(if(or(= dr 4)(= dr 5)){(var o(take hw(length hw)))(setq hw(cj(+(length hw)4)0))(var cb 0)(looprange fr 0(length hw){(if(or(and(= dr 4)(or(= fr 2)(= fr 7)(= fr 13)(= fr 18)))(and(= dr 5)(or(= fr 1)(= fr 5)(= fr 10)(= fr 3)))){(setix hw fr hz)}{(setix hw fr(ix o cb))(setq cb(+ cb 1))})})})(var hk(dw'hk))(var cs(dw'cs))(var em(dw'em))(var hn(length ez))(var he(length hw))(if(and(>= p 0)(= fl p)(= p gf)){(var gy(append hu ez hw))(var gs(length gy))(var w(rgbled-buffer gs hk))(rgbled-color w 0 gy ed)(if(not-eq(first(trap(rgbled-init p cs)))'exit-ok){(eh'p -1)(cl"Invalid Pin")(fs'p -1)(fs'crc(dl))}{(dx 0.01)(rgbled-update w)(dx 0.01)})(free w)} {(if(and(>= p 0)(= p gf)){(var gy(append ez hw))(var gs(length gy))(var w(rgbled-buffer gs cs))(rgbled-color w 0 gy ed)(if(not-eq(first(trap(rgbled-init p cs)))'exit-ok){(eh'p -1)(cl"Invalid Pin")(fs'p -1)(fs'crc(dl))}{(dx 0.01)(rgbled-update w)(dx 0.01)})(free w)}{(if(and(>= fl 0)(= fl gf)){(if(!= hk em)(ce hu))(var gy(append hu hw))(var gs(length gy))(var w(rgbled-buffer gs em))(rgbled-color w 0 gy ed)(if(not-eq(first(trap(rgbled-init fl hk)))'exit-ok){(eh'fl -1)(cl"Invalid Pin")(fs'fl -1)(fs'crc(dl))}{(dx 0.01)(rgbled-update w)(dx 0.01)})(free w)}{(if(>= fl 0){(var dp(rgbled-buffer(length hu)hk))(rgbled-color dp 0 hu(dw'hv))(if(not-eq(first(trap(rgbled-init fl hk)))'exit-ok){(eh'fl -1)(cl"Invalid Pin")(fs'fl -1)(fs'crc(dl))}{(dx 0.01)(rgbled-update dp)(dx 0.01)})(free dp)})(if(>= gf 0){(var be(rgbled-buffer he hk))(rgbled-color be 0 hw ed)(if(not-eq(first(trap(rgbled-init gf em)))'exit-ok){(eh'gf -1)(cl"Invalid Pin")(fs'gf -1)(fs'crc(dl))}{(dx 0.01)(rgbled-update be)(dx 0.01)})(free be)})})(if(>= p 0){(var ib(rgbled-buffer hn hk))(rgbled-color ib 0 ez ed)(if(not-eq(first(trap(rgbled-init p cs)))'exit-ok){(eh'p -1)(cl"Invalid Pin")(fs'p -1)(fs'crc(dl))}{(dx 0.01)(rgbled-update ib)(dx 0.01)})(free ib)})})})})(defunret cz(){(var bh'())(var n(dw'ea))(eh'ea -1)(var fe(systime))(loopwhile-thd 150(<=(secs-since fe)10){(if(and(>= n 0)(<=(secs-since fe)5)){(setq bh(list n))}{(setq bh(can-scan))})(loopforeach ea bh {(setq ci ea)(at ea(list(assoc bc'eo)))(dx 0.5)(if(>=(dw'ea)0){(if(not-eq(dw'ea)n){(fs'ea(dw'ea))(fs'crc(dl))})(return 1)})})})(return 0)})(defun at(ea ac){(send-data(append(list bv)ac)2 ea)})(defun status (){(var bo"status ")(setq bo(str-merge bo(str-from-n(if(<(secs-since gz)1)1 0)"%d ")))(setq bo(str-merge bo(str-from-n(if(<(secs-since h)1)1 0)"%d ")))(setq bo(str-merge bo(str-from-n(if(<(secs-since ih)1)1 0)"%d ")))(send-data bo)})(defun a(){(var ct(dw'ct))(var fy(dw'fy))(uart-stop)(if(>= fy 0){(if(not-eq(first(trap(gpio-configure fy'pin-mode-out)))'exit-ok){(eh'fy -1)(cl"Invalid Pin")(fs'fy -1)(fs'crc(dl))})})(if(>= ct 0){(if(not-eq(first(trap(gpio-configure ct'pin-mode-in-pu)))'exit-ok){(eh'ct -1)(cl"Invalid Pin")(fs'ct -1)(fs'crc(dl))}{(uart-start 1 ct -1 115200)(set-bms-val'bms-cell-num 15)(set-bms-val'bms-temp-adc-num 4)(set-bms-val'bms-temp-cell-max 45)})})})(defunret dw(cq){(var gj(assoc et cq))(if gj(return(car(cdr(cdr(cdr gj)))))(return nil))})(defun save-config(){(loopforeach bl et {(var cq(first bl))(if(eq cq'crc){(fs cq(dl))}{(fs cq(dw cq))})})(send-data"Settings Saved!")})(defunret dl(){(var i 0)(var gp(-(length et)1))(var aw(bufcreate gp))(loopforeach bl et {(var cq(first bl))(if(not-eq cq'crc){(bufset-i32 aw i(dw cq))(+ i 1)})})(var crc(crc16 aw))(free aw)(return crc)})(defun l(){(loopforeach bl et {(var cq(first bl))(var gx(ga cq))(eh cq gx)})})(defun restore-config(){(loopforeach bl et {(var cq(first bl))(var hi(if(eq cq'gb)fm(ix bl 3)))(fs cq hi)})(l)(send-data"Settings Restored!")})(defun ga(cq)(let((y(first(assoc et cq)))(ds(second(assoc et cq))))(cond((eq ds'i)(eeprom-read-i y))((eq ds'f)(eeprom-read-f y))((eq ds'b)(eeprom-read-i y)))))(defun fs(cq gx)(let((y(first(assoc et cq)))(ds(second(assoc et cq))))(cond((eq ds'i)(eeprom-store-i y gx))((eq ds'f)(eeprom-store-f y gx))((eq ds'b)(eeprom-store-i y gx)))))(defun cl(ev)(send-data(str-merge"msg "ev)))(defun cj(ah gx)(map(fn(x)gx)(range ah)))(defun dj(){(if(!=(str-cmp(to-str(sysinfo'hw-type))"hw-express")0){(exit-error"ei running on hw-express")})(var fp(+(first(sysinfo'fw-ver))(*(second(sysinfo'fw-ver))0.01)))(if(< fp 6.05)(exit-error"hw-express q ai id running 6.05"))(if(not-eq(ga'gb)fm)(restore-config)(l))(if(!=(dl)(to-i(ga'crc))){(cl"Error: crc corrupt")(restore-config)})(spawn fu)(event-register-handler(spawn cc))(event-enable'event-data-rx)(spawn cz)(if(=(conf-get'wifi-mode)0){(cl"WiFi is disabled. Please enable and reboot.")}{(event-enable'event-esp-now-rx)(setq hg(list(dw'hc)(dw'hd)(dw'gn)(dw'dv)(dw'da)(dw'gh)))(bt hg)(spawn ek)})(a)(spawn fk)})(defun recv-config(ao gr fi eg cx gi ap hr bj ec aq bm hj ab hv fl bx hk aj p hn cs fq cm gf he em ia dr ct fy ew){(eh'ao(to-i ao))(eh'gr(to-i gr))(eh'fi(to-i fi))(eh'eg(to-i eg))(eh'cx(to-i cx))(eh'gi(to-i gi))(eh'ap(to-i ap))(eh'hr(to-i hr))(eh'bj(to-float bj))(eh'ec(to-i ec))(eh'aq(to-i aq))(eh'bm(to-float bm))(eh'hj(to-float hj))(eh'ab(to-float ab))(eh'hv(to-float hv))(eh'fl(to-i fl))(eh'bx(to-i bx))(eh'hk(to-i hk))(eh'aj(to-i aj))(eh'p(to-i p))(eh'hn(to-i hn))(eh'cs(to-i cs))(eh'fq(to-i fq))(eh'cm(to-i cm))(eh'gf(to-i gf))(eh'he(to-i he))(eh'em(to-i em))(eh'ia(to-i ia))(eh'dr(to-i dr))(var dq(dw'ct))(eh'ct(to-i ct))(var ee(dw'fy))(eh'fy(to-i fy))(eh'ew(to-i ew))(if(or(!=(to-i ct)dq)(!=(to-i fy)ee)){(a)})})(defun cu(e)(let((er(max 0(min(- e 2700)(- 1500 1)))))(let((i(* er(/ 30.0 1500))))(let((fc(floor i)))(let((f(- i fc)))(let((el(bufget-u8 ca fc))(b(bufget-u8 ca(+ fc 1))))(max 0(min(round(+ el(* f(- b el))))100))))))))(defun hm(fh){(atomic {(if(and(>(buflen fh)1)(=(bufget-u8 fh 0)gd)){(bufcpy fh 0 fh 1(-(buflen fh)1))(eval(read fh))})})(if(and(>(buflen fh)1)(=(bufget-u8 fh 0)bv)){(setq gz(systime))(match(cossa bc(bufget-u8 fh 1))(eo {(eh'ea ci)})(fj {(var ay(bufget-u8 fh 2))(eh'ao(bits-dec-int ay 0 1))(eh'gr(bits-dec-int ay 1 1))})(ha {(setq cp(bufget-u8 fh 2))(setq gv(bufget-u8 fh 3))(if(= cp 3){(setq de 0.0)(setq bs(bufget-u8 fh 4))}{(setq de(to-float(bufget-i8 fh 4)))(setq bs 0.0)})(setq bf(/(to-float(bufget-i16 fh 5))10))(print"al")(setq fv(/(to-float(bufget-i16 fh 7))10))(setq fa(/(to-float(bufget-i16 fh 9))10))(eh'bm(/(bufget-u8 fh 11)100.0))(eh'ab(/(bufget-u8 fh 12)100.0))(eh'hv(/(bufget-u8 fh 13)100.0))})(k {(setq fx(/(bufget-u8 fh 2)100.0))})(aa {(var du(bufget-u8 fh 2))(if(= du 69){(setq gv(bufget-u8 fh 3))} {(setq de(/(to-float(bufget-i16 fh 5))10))(setq di(/(to-float(bufget-i16 fh 7))10))(setq cp(bufget-u8 fh 9))(setq gk(bufget-u8 fh 10))(setq fa(/(to-float(bufget-i16 fh 22))10))(setq bf(to-float(bufget-i16 fh 24)))(setq ba(/(to-float(bufget-i16 fh 26))10))(setq fv(/(to-float(bufget-i16 fh 28))10))(setq bs(-(/(bufget-u8 fh 30)100.0)0.5))(if(>= du 2){(setq bb(bufget-f32 fh 34))(setq ex(/(bufget-u8 fh 38)2.0))(setq eu(/(bufget-u8 fh 39)2.0))})(if(>= du 3){(setq by(bufget-u32 fh 41))(setq fb(/(bufget-u8 fh 53)2.0))})})})(_ nil))})(free fh)})(defun fu(){(var av 0)(var bn 0)(var au(secs-since 0))(var eb 0)(var ak 0)(loopwhile-thd 100 t {(setq eb(secs-since 0))(var ea(dw'ea))(at ea(list(assoc bc'ha)))(at ea(list(assoc bc'fj)))(at ea(list(assoc bc'k)))(if(=(dw'ao)1){(setq hu(cj(dw'bx)0))(setq ez(cj(dw'hn)0))(setq hw(cj(dw'he)0))(setq av 0)(var ch 10)(if(= cp 4)(setq ch(*ch -1)))(if(> bf ch){(setq av 1)})(if(< bf(* ch -1)){(setq av -1)})(if(=(dw'ap)1){(if(> de 70)(setq bn 1)(setq bn 0))})(c(secs-since ig)av bn)(if(or(!= av 0)(= bn 1)){(setq ig(systime))})} {(hb)})(m av)(setq au(+ au 0.1))(var dc(- au(secs-since 0)))(if(> dc 0){(dx dc)(setq au(secs-since 0))})})})(defun send-config(){(var ae"settings ")(loopforeach bl et {(let((cq(first bl))(ds(third bl))){(var value(ga cq))(setq ae(str-merge ae(cond((eq ds'b)(str-from-n value"%d "))((eq ds'i)(str-from-n value"%d "))((eq ds'f)(str-from-n value"%.2f ")))))})})(send-data ae)(send-data"Settings Read!")})(defun bt(dg){(esp-now-start)(esp-now-del-peer hg)(esp-now-add-peer hg)})(defun pair-pubmote(bg){(if(=(conf-get'wifi-mode)0){(cl"WiFi is disabled. Please enable and reboot.")}{(cond((>= bg 0){(eh'ef(to-i32 bg))(setq ej(systime))(setq ic 1)})((= bg -1){(bt hg)(fs'hc(ix hg 0))(fs'hd(ix hg 1))(fs'gn(ix hg 2))(fs'dv(ix hg 3))(fs'da(ix hg 4))(fs'gh(ix hg 5))(fs'ef(dw'ef))(fs'crc(dl))(setq ic 0)})((= bg -2){(setq hg'())(fs'hc -1)(fs'crc(dl))(setq ic 0)}))})})(defun ek(){(var au(secs-since 0))(var eb 0)(var ak 0)(loopwhile-thd 100 t {(setq eb(secs-since 0))(if(and(>(secs-since ej)30)(>= ic 2)){(atomic(pair-pubmote -2))})(if(= ic 1){(esp-now-del-peer hg)(setq hg'(255 255 255 255 255 255))(esp-now-add-peer hg)(var fh(bufcreate 6))(var af(get-mac-addr))(looprange i 0(buflen fh){(bufset-u8 fh i(ix af i))})(esp-now-send hg fh)(free fh)(esp-now-del-peer hg)(setq ic 2)})(if(and(= ic 0)(>=(dw'hc)0)(<=(secs-since h)5)(>=(dw'ea)0)){(at(dw'ea)(list(assoc bc'aa)3))(var fh(bufcreate 32))(bufset-u8 fh 0 69)(bufset-u8 fh 1 gv)(bufset-i16 fh 2(floor(* de 10)))(bufset-i16 fh 4(floor(* di 10)))(bufset-u8 fh 6 cp)(bufset-u8 fh 7 gk)(bufset-i16 fh 8(floor(* fa 10)))(bufset-i16 fh 10(floor bf))(bufset-i16 fh 12(floor(* ba 10)))(bufset-i16 fh 14(floor(* fv 10)))(bufset-u8 fh 16(floor(*(+ bs 0.5)100)))(bufset-f32 fh 17 bb'little-endian)(bufset-u8 fh 21(floor(* ex 2)))(bufset-u8 fh 22(floor(* eu 2)))(bufset-u32 fh 23 by)(bufset-u8 fh 27(floor(* fb 2)))(bufset-i32 fh 28(dw'ef))(esp-now-send hg fh)(free fh)})(setq ak(secs-since 0))(setq au(+ au 0.05))(var dc(- au(secs-since 0)))(if(> dc 0){(dx dc)(setq au(secs-since 0))})})})(defun cc()(loopwhile t(recv((event-esp-now-rx(? dg)(? ff)(? fh)(? hf))(cy dg ff fh hf))((event-data-rx .(? fh))(hm fh))(_ nil))))(defun eh(cq value){(let((gj(assoc et cq)))(if gj(loopforeach df et {(if(eq(car df)cq)(setcdr df(list(car(cdr df))(car(cdr(cdr df)))(car(cdr(cdr(cdr df))))value)))})(setq et(cons(cons cq(list 0'ds 0 value))et))))})(defun cy(dg ff fh hf){(if(= ic 2){(setq hg dg)(esp-now-add-peer hg)(var j(bufcreate 4))(bufset-i32 j 0(dw'ef))(esp-now-send hg j)(free j)(esp-now-del-peer hg)(atomic(pair-pubmote -1))}{(if(and(=(buflen fh)16)(=(bufget-i32 fh 0'little-endian)(dw'ef))){(setq h(systime))(print(list"ht"dg ff fh hf))(var jsx(bufget-f32 fh 4'little-endian))(var jsy(bufget-f32 fh 8'little-endian))(var bt-c(bufget-u8 fh 12))(var bt-z(bufget-u8 fh 13))(var is-rev(bufget-u8 fh 14))(print(list jsy jsx bt-c bt-z is-rev))(if(>=(dw'ea)0){(can-cmd(dw'ea)(str-replace(to-str(list jsy jsx bt-c bt-z is-rev))"(""(set-remote-state "))})})})})(defun dx(x)(yield(* x 1000000)))@const-end(defun c(ey av bn){(var ec(dw'ec))(var am(secs-since gz))(if(>(length hu)0){(if(=(dw'cx)0)(hy))})(var ad(dw'fi))(setq ed(dw'bm))(var ec(dw'ec))(if(and(>= ey ec)(<= am 1)){(setq ad(dw'eg))(setq ed(dw'ab))})(if(and(<=(secs-since 0)ec)(= av 0))(setq ad(dw'gi)))(if(and(>(length ez)0)(>(length hw)0)){(cond((= cp 15){(hb)(dz hu)(dz ez)})((and(> ey(dw'aq))(< am 1)){(hb)})((and(or(= ad 1)(= bn 1))(< am 1)){(dm ez)(dm hw)})((or(= ad 0)(and(> am 1)(>(secs-since 0)ec))){(hx(if(>= av 0)ez hw)0xFFFFFFFFu32)(hx(if(< av 0)ez hw)0x00FF0000u32)})((= ad 2){(hx(if(>= av 0)ez hw)0x0000FFFFu32)(hx(if(< av 0)ez hw)0x00FF00FFu32)})((= ad 3){(hx(if(>= av 0)ez hw)0x000000FFu32)(hx(if(< av 0)ez hw)0x0000FF00u32)})((= ad 4){(hx(if(>= av 0)ez hw)0x00FFFF00u32)(hx(if(< av 0)ez hw)0x0000FF00u32)})((= ad 5){(cf)})((= ad 6){(bi)})((= ad 7){(db 0)})((= ad 8){(db 1)})((= ad 9){(bq)})((= ad 10){(es)}))(if(and(=(dw'hr)1)(<= fv(dw'bj)))(en))})})(defun fk(){(var br 5)(var au(secs-since 0))(var eb 0)(var ak 0)(var an(bufcreate 64))(loopwhile-thd 100 t {(setq eb(secs-since 0))(if(>=(dw'ct)0){(var dn(uart-read an(buflen an)nil nil 0.5))(if(> dn 5){(var cg 0)(var bw 0)(var fd 0)(var bp 0)(var dt 0)(var i 0)(loopwhile(and(< i(- dn 5))(not(and(= cg 1)(= bw 1)(= fd 1)(= bp 1)(= dt 1)))){(if(and(<(+ i 2)dn)(=(bufget-u8 an i)0xFF)(=(bufget-u8 an(+ i 1))0x55)(=(bufget-u8 an(+ i 2))0xAA)){(setq ih(systime))(if(<(+ i 3)dn){(var u(bufget-u8 an(+ i 3)))(var hl(+ i 4))(loopwhile(and(< hl(- dn 2))(not(and(<(+ hl 2)dn)(=(bufget-u8 an hl)0xFF)(=(bufget-u8 an(+ hl 1))0x55)(=(bufget-u8 an(+ hl 2))0xAA)))){(setq hl(+ hl 1))})(var ah(- hl i))(if(>= ah 6){(var ft(bufcreate ah))(bufcpy ft 0 an i ah)(if(>=(buflen ft)2){(var crc(bufget-u16 an(- hl 2)))(var r 0)(looprange fr 0(-(buflen ft)2){(setq r(+ r(bufget-u8 ft fr)))})(if(eq crc r){(cond((and(= u 2)(= bw 0)){(setq bw 1)(var cw 0)(var cr 0)(looprange fr 4(-(buflen ft)4){(if(eq(mod fr 2)0){(if(and(= cw 0)(=(dw'ew)1)){(set-bms-val'bms-soc(/(cu(bufget-i16 ft fr))100.0))})(var ck(/(bufget-i16 ft fr)1000.0))(set-bms-val'bms-v-cell cw ck)(setq cw(+ cw 1))(setq cr(+ cr ck))})})(set-bms-val'bms-v-tot cr)})((and(= u 3)(= fd 0)){(setq fd 1)(if(=(dw'ew)0){(set-bms-val'bms-soc(/(bufget-u8 ft 4)100.0))})})((and(= u 5)(= dt 0)){(setq dt 1)(var dy 0.055)(var hq(*(bufget-i16 ft 4)dy))(set-bms-val'bms-i-in-ic hq)})((and(= u 0)(= cg 0)){(setq cg 1)})((and(= u 4)(= bp 0)){(setq bp 1)(set-bms-val'bms-temp-ic(bufget-i8 ft(-(buflen ft)3)))(looprange fr 4(-(buflen ft)3){(set-bms-val'bms-temps-adc(- fr 4)(bufget-i8 ft fr))})}))(setq i hl)})})(free ft)})(setq i hl)} {(setq i(+ i 1))})} {(setq i(+ i 1))})})(send-bms-can)}{ })(if(>=(dw'fy)0){(if(and(>(secs-since ih)br)(<(secs-since gz)1)(or(= cp 0)(> cp 5))){(gpio-write(dw'fy)1)(dx 0.1)(gpio-write(dw'fy)0)})})})(setq ak(secs-since 0))(setq au(+ au 0.05))(var dc(- au(secs-since 0)))(if(> dc 0){(dx dc)(setq au(secs-since 0))})})})(dj)