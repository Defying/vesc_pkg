@const-symbol-strings(def dg -1)(def af -1)(def aj -1)(def cw -1)(def cz -1)(def ei -1)(def fj -1)(def dh -1)(def ew -1)(def hj -1)(def fc -1)(def eu -1)(def cy -1)(def hs -1)(def fs -1)(def ds 1)(def co'())(def an'())(def m'())(def er 0)(def ac -1)(def dd'())(def gm 31)(def ev 0)(def u 0)(def am 0)(def s 0)(def dq'(0xFF0000u32 0xFFFF00u32 0x00FF00u32 0x00FFFFu32 0x0000FFu32 0xFF00FFu32))(def bg'(0x00FFFF00 0x0000FF00 0x0000FFFF 0x000000FF 0x00FF00FF 0x00FF0000))(def gd 422i32)(def hz'((dz .(0 i gd -1))(crc .(1 i 60967 -1))(hq .(2 i -1 -1))(ah .(3 b 1 -1))(fk .(4 b 1 -1))(dl .(5 i 0 -1))(ht .(6 i 5 -1))(dx .(7 i 0 -1))(cl .(8 i 5 -1))(ig .(9 b 1 -1))(cn .(10 b 1 -1))(gr .(11 f -4.0 -1))(cc .(12 i 30 -1))(et .(13 i 120 -1))(bt .(14 f 0.5 -1))(ga .(15 f 0.5 -1))(gl .(16 f 0.2 -1))(hn .(17 f 0.5 -1))(gk .(18 i -1 -1))(cq .(19 i 10 -1))(gu .(20 i 2 -1))(fm .(21 b 0 -1))(ie .(22 i 18 -1))(a .(23 i 13 -1))(bl .(24 i 2 -1))(hi .(25 b 0 -1))(bj .(26 b 1 -1))(dv .(27 i 17 -1))(fx .(28 i 13 -1))(ez .(29 i 2 -1))(bp .(30 b 0 -1))(ce .(31 b 1 -1))(gn .(32 i -1 -1))(hx .(33 i -1 -1))(aw .(34 i 1 -1))(bw .(35 i -1 -1))(ci .(36 i -1 -1))(cx .(37 i -1 -1))(dm .(38 i -1 -1))(dt .(39 i -1 -1))(gq .(40 i -1 -1))(dp .(41 i -1 -1))))@const-start(def ej 0)(defun v(){(setq ej(mod(+ ej 1)2))(var ao(if(= ej 0)0xFFFFFFFF 0x00000000))(looprange i 0(length an){(setix an i ao)})(looprange i 0(length m){(setix m i ao)})})(def bo 0)(defun cd(){(setq bo(mod(+ bo 1)2))(looprange i 0(length m){(setix m i(if(= bo 0)0x00FF0000 0x00000000))})})(def al 0)(defun g(hk){(var hd(ix bg al))(looprange i 0(length an)(setix an i(if(= hk 0)hd 0xFF000000)))(looprange i 0(length m)(setix m i hd))(setq al(mod(+ al 1)6))})(def gg 0)(def ax 1)(defun max(dw b)(if(> dw b)dw b))(defun min(dw b)(if(< dw b)dw b))(defun cm(){(var cb(+(length an)(length m)))(looprange i 0 cb {(var av(abs(- i gg)))(var bu(max 0(- 255(* av 51))))(var ao(color-make bu 0 0))(if(< i(length an))(setix an i ao)(setix m(- i(length an))ao))})(setq gg(+ gg ax))(if(or(>= gg cb)(< gg 0))(setq ax(* ax -1)))})(defun ep(fo){(var id(length fo))(var gf(floor(* id er)))(looprange eg 0 id {(var gw 0)(var bd 0)(if(or(< eg gf)(and(= eg 0)(<= gf 1))){(if(or(< er 0.2)(and(= eg 0)(<= gf 1))){(setq gw 255)(setq bd 0)} {(setq gw(floor(* 255(- 1(/ er 0.8)))))(setq bd(floor(* 255(/ er 0.8))))})} {(setq gw 0)(setq bd 0)})(var ao 0x00)(setq ao(bits-enc-int ao 16 gw 8))(setq ao(bits-enc-int ao 8 bd 8))(setix fo eg ao)})})(def gj 0)(defun bb(){(var fe(length dq))(looprange eg 0(length an){(var fg(mod(+ gj eg(length an))fe))(var ao(ix dq fg))(setix an eg ao)})(looprange eg 0(length m){(var fg(mod(+ gj eg(length m))fe))(var ao(ix dq fg))(setix m eg ao)})(setq gj(mod(+ gj 1)fe))})(def aa 0)(defun ft(){(var ch(mod aa 3))(var a(length an))(var fx(length m))(var bh(floor(/ a 2)))(var bf(floor(/ fx 2)))(cond((= ch 0){(looprange i 0 bh(setix an i 0x00000000))(looprange i bh a(setix an i 0x00FF0000))(looprange i 0 bf(setix m i 0x00000000))(looprange i bf fx(setix m i 0x00FF0000))})((= ch 1){(looprange i 0 bh(setix an i 0x00FF0000))(looprange i bh a(setix an i 0x000000FF))(looprange i 0 bf(setix m i 0x00FF0000))(looprange i bf fx(setix m i 0x000000FF))})((= ch 2){(looprange i 0 bh(setix an i 0x000000FF))(looprange i bh a(setix an i 0x00000000))(looprange i 0 bf(setix m i 0x000000FF))(looprange i bf fx(setix m i 0x00000000))}))(setq aa(mod(+ aa 1)3))})(defun ai(){(if(> ei 250.0){(gb)}{(if(and(!= cz 1)(!= cz 2)(!= cz 3)){(ep co)}{(eo cz)})})})(defun gb(){(var cq(length co))(var ag(*(abs hj)1.1112))(var br 0.0)(if(< ag 1.0){(setq br ag)} {(setq br 1.0)})(var bi(floor(* br cq)))(var ar 0x00FFFF00u32)(if(>(abs hj)0.85){(setq ar 0x00FF0000u32)} {(if(>(abs hj)0.7){(setq ar 0x00FF8800u32)})})(looprange eg 0 cq {(setix co eg(if(< eg bi)ar 0x00000000u32))})})(defun eo(cz){(var cq(length co))(var hv(if(or(= cz 1)(= cz 3))0xFF 0x00))(var cu(if(or(= cz 2)(= cz 3))0xFF 0x00))(looprange eg 0 cq {(setix co eg(if(< eg(/ cq 2))hv cu))})})(defun w(){(looprange eg 0(length co){(setix co eg 0x00)})(looprange eg 0(length an){(setix an eg 0x00)})(looprange eg 0(length m){(setix m eg 0x00)})})(defun gv(fo){(looprange eg 0(length fo){(var ao(color-split(ix fo eg)1))(var y(color-make(ix ao 1)(ix ao 0)(ix ao 2)(ix ao 3)))(setix fo eg y)})})(defun fr(e){(if(=(ic'fm)1){(setq co(reverse co))})(if(=(ic'hi)1){(setq an(reverse an))})(if(=(ic'bp)1){(setq m(reverse m))})(var fk(ic'fk))(var ga(ic'ga))(var gk(ic'gk))(var ie(ic'ie))(var dv(ic'dv))(var bj(ic'bj))(var ce(ic'ce))(var hb(if(and(> e 0)(= fk 0))(to-i(* 0xFF ga))0x00))(var gp(if(and(< e 0)(= fk 0))(to-i(* 0xFF ga))0x00))(if(or(= bj 2)(= bj 3)){(setq an(append(list hb)an))})(if(or(= ce 2)(= ce 3)){(setq m(append(list gp)m))})(if(or(= bj 4)(= bj 5)){(var at(take an(length an)))(setq an(l(+(length an)4)0))(var r 0)(looprange bs 0(length an){(if(or(and(= bj 4)(or(= bs 2)(= bs 7)(= bs 13)(= bs 18)))(and(= bj 5)(or(= bs 1)(= bs 5)(= bs 10)(= bs 3)))){(setix an bs hb)}{(setix an bs(ix at r))(setq r(+ r 1))})})})(if(or(= ce 4)(= ce 5)){(var at(take m(length m)))(setq m(l(+(length m)4)0))(var r 0)(looprange bs 0(length m){(if(or(and(= ce 4)(or(= bs 2)(= bs 7)(= bs 13)(= bs 18)))(and(= ce 5)(or(= bs 1)(= bs 5)(= bs 10)(= bs 3)))){(setix m bs gp)}{(setix m bs(ix at r))(setq r(+ r 1))})})})(var gu(ic'gu))(var bl(ic'bl))(var ez(ic'ez))(var a(length an))(var fx(length m))(if(and(>= ie 0)(= gk ie)(= ie dv)){(var ca(append co an m))(var cb(length ca))(var ih(rgbled-buffer cb gu))(rgbled-color ih 0 ca ds)(if(not-eq(first(trap(rgbled-init ie bl)))'exit-ok){(dk'ie -1)(dj"Invalid Pin")(bz'ie -1)(bz'crc(c))}{(ff 0.01)(rgbled-update ay)(ff 0.01)})(free ih)} {(if(and(>= ie 0)(= ie dv)){(var ca(append an m))(var cb(length ca))(var ih(rgbled-buffer cb bl))(rgbled-color ih 0 ca ds)(if(not-eq(first(trap(rgbled-init ie bl)))'exit-ok){(dk'ie -1)(dj"Invalid Pin")(bz'ie -1)(bz'crc(c))}{(ff 0.01)(rgbled-update ay)(ff 0.01)})(free ih)}{(if(and(>= gk 0)(= gk dv)){(if(!= gu ez)(gv co))(var ca(append co m))(var cb(length ca))(var ih(rgbled-buffer cb ez))(rgbled-color ih 0 ca ds)(if(not-eq(first(trap(rgbled-init gk gu)))'exit-ok){(dk'gk -1)(dj"Invalid Pin")(bz'gk -1)(bz'crc(c))}{(ff 0.01)(rgbled-update j)(ff 0.01)})(free ih)}{(if(>= gk 0){(var j(rgbled-buffer(length co)gu))(rgbled-color j 0 co(ic'hn))(if(not-eq(first(trap(rgbled-init gk gu)))'exit-ok){(dk'gk -1)(dj"Invalid Pin")(bz'gk -1)(bz'crc(c))}{(ff 0.01)(rgbled-update j)(ff 0.01)})(free j)})(if(>= dv 0){(var fb(rgbled-buffer fx gu))(rgbled-color fb 0 m ds)(if(not-eq(first(trap(rgbled-init dv ez)))'exit-ok){(dk'dv -1)(dj"Invalid Pin")(bz'dv -1)(bz'crc(c))}{(ff 0.01)(rgbled-update fb)(ff 0.01)})(free fb)})})(if(>= ie 0){(var ay(rgbled-buffer a gu))(rgbled-color ay 0 an ds)(if(not-eq(first(trap(rgbled-init ie bl)))'exit-ok){(dk'ie -1)(dj"Invalid Pin")(bz'ie -1)(bz'crc(c))}{(ff 0.01)(rgbled-update ay)(ff 0.01)})(free ay)})})})})(defunret ex(){(var cs'())(var es(ic'hq))(dk'hq -1)(var fu(systime))(loopwhile-thd 150(<=(secs-since fu)10){(if(and(>= es 0)(<=(secs-since fu)5)){(setq cs(list es))}{(setq cs(can-scan))})(loopforeach hq cs {(setq ac hq)(ak hq(list(assoc hp'ia)))(ff 0.5)(if(>=(ic'hq)0){(if(not-eq(ic'hq)es){(bz'hq(ic'hq))(bz'crc(c))})(return 1)})})})(return 0)})(def cp 101)(def hl 102)(def hp'((ia . 0)(ib . 10)(hg . 24)(hy . 29)(ho . 202)))(defun ak(hq eh){(send-data(append(list cp)eh)2 hq)})(defun status (){(var fz"status ")(setq fz(str-merge fz(str-from-n(if(<(secs-since s)1)1 0)"%d ")))(setq fz(str-merge fz(str-from-n(if(<(secs-since ev)1)1 0)"%d ")))(setq fz(str-merge fz(str-from-n(if(<(secs-since u)1)1 0)"%d ")))(send-data fz)})(defun ba(){(var gn(ic'gn))(var hx(ic'hx))(uart-stop)(if(>= hx 0){(if(not-eq(first(trap(gpio-configure hx'pin-mode-out)))'exit-ok){(dk'hx -1)(dj"Invalid Pin")(bz'hx -1)(bz'crc(c))})})(if(>= gn 0){(if(not-eq(first(trap(gpio-configure gn'pin-mode-in-pu)))'exit-ok){(dk'gn -1)(dj"Invalid Pin")(bz'gn -1)(bz'crc(c))}{(uart-start 1 gn -1 115200)(set-bms-val'bms-cell-num 15)(set-bms-val'bms-temp-adc-num 4)(set-bms-val'bms-temp-cell-max 45)})})})(defunret ic(cv){(var dn(assoc hz cv))(if dn(return(car(cdr(cdr(cdr dn)))))(return nil))})(defun save-config(){(loopforeach aq hz {(var cv(first aq))(if(eq cv'crc){(bz cv(c))}{(bz cv(ic cv))})})(send-data"Settings Saved!")})(defunret c(){(var i 0)(var hm(-(length hz)1))(var by(bufcreate hm))(loopforeach aq hz {(var cv(first aq))(if(not-eq cv'crc){(bufset-i32 by i(ic cv))(+ i 1)})})(var crc(crc16 by))(free by)(return crc)})(defun n(){(loopforeach aq hz {(var cv(first aq))(var gy(gh cv))(dk cv gy)})})(defun restore-config(){(loopforeach aq hz {(var cv(first aq))(var ct(if(eq cv'dz)gd(ix aq 3)))(bz cv ct)})(n)(send-data"Settings Restored!")})(defun gh(cv)(let((ea(first(assoc hz cv)))(hk(second(assoc hz cv))))(cond((eq hk'i)(eeprom-read-i ea))((eq hk'f)(eeprom-read-f ea))((eq hk'b)(eeprom-read-i ea)))))(defun bz(cv gy)(let((ea(first(assoc hz cv)))(hk(second(assoc hz cv))))(cond((eq hk'i)(eeprom-store-i ea gy))((eq hk'f)(eeprom-store-f ea gy))((eq hk'b)(eeprom-store-i ea gy)))))(defun dj(bk)(send-data(str-merge"msg "bk)))(defun l(de gy)(map(fn(x)gy)(range de)))(defun eb(e cg el){(var z(if(< e 0)cg el))(var ab(if(< e 0)el cg))(looprange eg 0(length an){(setix an eg ab)})(looprange eg 0(length m){(setix m eg z)})})(defun be(){(if(!=(str-cmp(to-str(sysinfo'hw-type))"hw-express")0){(exit-error"fd running on hw-express")})(def ap(+(first(sysinfo'fw-ver))(*(second(sysinfo'fw-ver))0.01)))(if(< ap 6.05)(exit-error"hw-express ad hc gx running 6.05"))(if(not-eq(gh'dz)gd)(restore-config)(n))(if(!=(c)(to-i(gh'crc))){(dj"Error: crc corrupt")(restore-config)})(spawn fp)(event-register-handler(spawn he))(event-enable'event-data-rx)(spawn ex)(if(=(conf-get'wifi-mode)0){(dj"WiFi is disabled. Please enable and reboot.")}{(event-enable'event-esp-now-rx)(setq dd(list(ic'bw)(ic'ci)(ic'cx)(ic'dm)(ic'dt)(ic'gq)))(cf dd)(spawn bq)})(ba)(spawn ef)})(defun recv-config(ah fk dl ht dx cl ig cn gr cc et bt ga gl hn gk cq gu fm ie a bl hi bj dv fx ez bp ce gn hx aw){(dk'ah(to-i ah))(dk'fk(to-i fk))(dk'dl(to-i dl))(dk'ht(to-i ht))(dk'dx(to-i dx))(dk'cl(to-i cl))(dk'ig(to-i ig))(dk'cn(to-i cn))(dk'gr(to-float gr))(dk'cc(to-i cc))(dk'et(to-i et))(dk'bt(to-float bt))(dk'ga(to-float ga))(dk'gl(to-float gl))(dk'hn(to-float hn))(dk'gk(to-i gk))(dk'cq(to-i cq))(dk'gu(to-i gu))(dk'fm(to-i fm))(dk'ie(to-i ie))(dk'a(to-i a))(dk'bl(to-i bl))(dk'hi(to-i hi))(dk'bj(to-i bj))(dk'dv(to-i dv))(dk'fx(to-i fx))(dk'ez(to-i ez))(dk'bp(to-i bp))(dk'ce(to-i ce))(var ck(ic'gn))(dk'gn(to-i gn))(var fy(ic'hx))(dk'hx(to-i hx))(dk'aw(to-i aw))(if(or(!=(to-i gn)ck)(!=(to-i hx)fy)){(ba)})})(def o [0 0 0 0 1 2 3 4 5 7 8 11 14 16 18 19 25 30 33 37 43 48 53 60 67 71 76 82 92 97 100])(defun bm(hu)(let((en(max 0(min(- hu 2700)(- 1500 1)))))(let((i(* en(/ 30.0 1500))))(let((df(floor i)))(let((f(- i df)))(let((dw(bufget-u8 o df))(b(bufget-u8 o(+ df 1))))(max 0(min(round(+ dw(* f(- b dw))))100))))))))(defun gi(ee){(atomic {(if(and(>(buflen ee)1)(=(bufget-u8 ee 0)hl)){(bufcpy ee 0 ee 1(-(buflen ee)1))(eval(read ee))})})(if(and(>(buflen ee)1)(=(bufget-u8 ee 0)cp)){(setq s(systime))(match(cossa hp(bufget-u8 ee 1))(ia {(dk'hq ac)})(ho {(var hw(bufget-u8 ee 2))(dk'ah(bits-dec-int hw 0 1))(dk'fk(bits-dec-int hw 1 1))})(hg {(setq cw(bufget-u8 ee 2))(setq dg(bufget-u8 ee 3))(if(= cw 3){(setq af 0.0)(setq hj(bufget-u8 ee 4))}{(setq af(to-float(bufget-i8 ee 4)))(setq hj 0.0)})(setq ei(/(to-float(bufget-i16 ee 5))10))(setq ew(/(to-float(bufget-i16 ee 7))10))(setq fj(/(to-float(bufget-i16 ee 9))10))(dk'bt(/(bufget-u8 ee 11)100.0))(dk'gl(/(bufget-u8 ee 12)100.0))(dk'hn(/(bufget-u8 ee 13)100.0))})(hy {(setq er(/(bufget-u8 ee 2)100.0))})(ib {(var fi(bufget-u8 ee 2))(if(= fi 69){(setq dg(bufget-u8 ee 3))} {(setq af(/(to-float(bufget-i16 ee 5))10))(setq aj(/(to-float(bufget-i16 ee 7))10))(setq cw(bufget-u8 ee 9))(setq cz(bufget-u8 ee 10))(setq fj(/(to-float(bufget-i16 ee 22))10))(setq ei(to-float(bufget-i16 ee 24)))(setq dh(/(to-float(bufget-i16 ee 26))10))(setq ew(/(to-float(bufget-i16 ee 28))10))(setq hj(-(/(bufget-u8 ee 30)100.0)0.5))(if(>= fi 2){(setq fc(bufget-f32 ee 34))(setq eu(/(bufget-u8 ee 38)2.0))(setq cy(/(bufget-u8 ee 39)2.0))})(if(>= fi 3){(setq hs(bufget-u32 ee 41))(setq fs(/(bufget-u8 ee 53)2.0))})})})(_ nil))})(free ee)})(defun fp(){(var e 0)(var ge 0)(var ae 0)(var bx 0)(var bn(secs-since 0))(var hh 0)(var gs 0)(loopwhile-thd 100 t {(setq hh(secs-since 0))(var hq(ic'hq))(ak hq(append(list(assoc hp'hg))'(102 108 111 97 116 45 97 99 99 101 115 115 111 114 105 101 115 49 46 48 0)))(ak hq(list(assoc hp'ho)))(ak hq(list(assoc hp'hy)))(if(=(ic'ah)1){(setq co(l(ic'cq)0))(setq an(l(ic'a)0))(setq m(l(ic'fx)0))(setq e 0)(var dy 10)(if(= cw 4)(setq dy(*dy -1)))(if(> ei dy){(setq e 1)})(if(< ei(* dy -1)){(setq e -1)})(if(=(ic'ig)1){(if(> af 70)(setq bx 1)(setq bx 0))})(cj(secs-since am)ge e ae bx)(setq ge e)(if(or(!= e 0)(= bx 1)){(setq ae 0)(setq am(systime))})(if(< ae 2)(fr e))} {(w)(fr e)})(setq bn(+ bn 0.1))(var au(- bn(secs-since 0)))(if(> au 0){(ff au)(setq bn(secs-since 0))})})})(defun send-config(){(var ey"settings ")(loopforeach aq hz {(let((cv(first aq))(hk(third aq))){(var value(gh cv))(setq ey(str-merge ey(cond((eq hk'b)(str-from-n value"%d "))((eq hk'i)(str-from-n value"%d "))((eq hk'f)(str-from-n value"%.2f ")))))})})(send-data ey)(send-data"Settings Read!")})(defun cf(fa){(esp-now-start)(esp-now-del-peer dd)(esp-now-add-peer dd)})(def k 0)(defun pair-pubmote(fw){(if(=(conf-get'wifi-mode)0){(dj"WiFi is disabled. Please enable and reboot.")}{(cond((>= fw 0){(dk'dp fw)(setq gm(systime))(setq k 1)})((= fw -1){(cf dd)(bz'bw(ix dd 0))(bz'ci(ix dd 1))(bz'cx(ix dd 2))(bz'dm(ix dd 3))(bz'dt(ix dd 4))(bz'gq(ix dd 5))(bz'dp dp)(bz'crc(c))(setq k 0)})((= fw -2){(setq dd'())(bz'bw -1)(bz'crc(c))(setq k 0)}))})})(defun bq(){(var bn(secs-since 0))(var hh 0)(var gs 0)(loopwhile-thd 100 t {(setq hh(secs-since 0))(if(and(>(secs-since gm)30)(>= k 2)){(atomic(pair-pubmote -2))})(if(= k 1){(esp-now-del-peer dd)(setq dd'(255 255 255 255 255 255))(esp-now-add-peer dd)(esp-now-send dd"42069")(esp-now-del-peer dd)(setq k 2)})(if(and(= k 0)(>=(ic'bw)0)(<=(secs-since ev)5)(>=(ic'hq)0)){(ak(ic'hq)(list(assoc hp'ib)3))(var ee(bufcreate 32))(bufset-u8 ee 0 69)(bufset-u8 ee 1 dg)(bufset-i16 ee 2(floor(* af 10)))(bufset-i16 ee 4(floor(* aj 10)))(bufset-u8 ee 6 cw)(bufset-u8 ee 7 cz)(bufset-i16 ee 8(floor(* fj 10)))(bufset-i16 ee 10(floor ei))(bufset-i16 ee 12(floor(* dh 10)))(bufset-i16 ee 14(floor(* ew 10)))(bufset-u8 ee 16(floor(*(+ hj 0.5)100)))(bufset-f32 ee 17 fc'little-endian)(bufset-u8 ee 21(floor(* eu 2)))(bufset-u8 ee 22(floor(* cy 2)))(bufset-u32 ee 23 hs)(bufset-u8 ee 27(floor(* fs 2)))(bufset-i32 ee 28(ic'dp))(esp-now-send dd ee)(free ee)})(setq gs(secs-since 0))(setq bn(+ bn 0.05))(var au(- bn(secs-since 0)))(if(> au 0){(ff au)(setq bn(secs-since 0))})})})(defun he()(loopwhile t(recv((event-esp-now-rx(? fa)(? gt)(? ee)(? dr))(hr fa gt ee dr))((event-data-rx .(? ee))(gi ee))(_ nil))))(defun dk(cv value){(let((dn(assoc hz cv)))(if dn(loopforeach az hz {(if(eq(car az)cv)(setcdr az(list(car(cdr az))(car(cdr(cdr az)))(car(cdr(cdr(cdr az))))value)))})(setq hz(cons(cons cv(list 0'hk 0 value))hz))))})(defun hr(fa gt ee dr){(if(= k 2){(setq dd fa)(esp-now-add-peer dd)(esp-now-send dd(ic'dp))(esp-now-del-peer dd)(setq k 3)}{(if(and(=(buflen ee)15)(=(bufget-i32 ee 11)(ic'dp))){(setq ev(systime))(var jsx(bufget-f32 ee 0'little-endian))(var jsy(bufget-f32 ee 4'little-endian))(var bt-c(bufget-u8 ee 8))(var bt-z(bufget-u8 ee 9))(var is-rev(bufget-u8 ee 10))(db(ic'hq)(bc(to-str(list jsy jsx bt-c bt-z is-rev))"(""(set-remote-state "))})})(free ee)})(defun ff(x)(yield(* x 1000000)))@const-end(defun cj(em ge e ae bx){(var cc(ic'cc))(var fh(secs-since s))(if(or(> fh cc)(< em(ic'et))){(if(>(length co)0){(if(=(ic'dx)0)(ai))})(var fl(ic'dl))(setq ds(ic'bt))(var cc(ic'cc))(if(>= fh cc){(setq fl 0)}{(if(and(<=(secs-since 0)cc)(= e 0))(setq fl(ic'cl)))(if(> em cc){(setq fl(ic'ht))(setq ds(ic'gl))})})(var cg 0x00)(var el 0x00)(if(and(>(length an)0)(>(length m)0)){(cond((or(= fl 1)(= bx 1)){(ep an)(ep m)})((= fl 0){(setq cg 0xFFFFFFFFu32)(setq el 0x00FF0000u32)(eb e cg el)})((= fl 2){(setq cg 0x0000FFFFu32)(setq el 0x00FF00FFu32)(eb e cg el)})((= fl 3){(setq cg 0x000000FFu32)(setq el 0x0000FF00u32)(eb e cg el)})((= fl 4){(setq cg 0x00FFFF00u32)(setq el 0x0000FF00u32)(eb e cg el)})((= fl 5){(bb)})((= fl 6){(v)})((= fl 7){(g 0)})((= fl 8){(g 1)})((= fl 9){(cm)})((= fl 10){(ft)}))(if(and(=(ic'cn)1)(<= ew(ic'gr)))(cd))})} {(if(< ae 2){(w)(setq ae(+ ae 1))})})})(defun ef(){(var dc 5)(var bn(secs-since 0))(var hh 0)(var gs 0)(var hf(bufcreate 64))(loopwhile-thd 100 t {(setq hh(secs-since 0))(if(>=(ic'gn)0){(var ha(uart-read hf(buflen hf)nil nil 0.5))(if(> ha 5){(var cr 0)(var ec 0)(var q 0)(var h 0)(var di 0)(var i 0)(loopwhile(and(< i(- ha 5))(not(and(= cr 1)(= ec 1)(= q 1)(= h 1)(= di 1)))){(if(and(<(+ i 2)ha)(=(bufget-u8 hf i)0xFF)(=(bufget-u8 hf(+ i 1))0x55)(=(bufget-u8 hf(+ i 2))0xAA)){(setq u(systime))(if(<(+ i 3)ha){(var gz(bufget-u8 hf(+ i 3)))(var du(+ i 4))(loopwhile(and(< du(- ha 2))(not(and(<(+ du 2)ha)(=(bufget-u8 hf du)0xFF)(=(bufget-u8 hf(+ du 1))0x55)(=(bufget-u8 hf(+ du 2))0xAA)))){(setq du(+ du 1))})(var de(- du i))(if(>= de 6){(var bv(bufcreate de))(bufcpy bv 0 hf i de)(if(>=(buflen bv)2){(var crc(bufget-u16 hf(- du 2)))(var ed 0)(looprange bs 0(-(buflen bv)2){(setq ed(+ ed(bufget-u8 bv bs)))})(if(eq crc ed){(cond((and(= gz 2)(= ec 0)){(setq ec 1)(var ek 0)(var fq 0)(looprange bs 4(-(buflen bv)4){(if(eq(mod bs 2)0){(if(and(= ek 0)(=(ic'aw)1)){(set-bms-val'bms-soc(/(bm(bufget-i16 bv bs))100.0))})(var da(/(bufget-i16 bv bs)1000.0))(set-bms-val'bms-v-cell ek da)(setq ek(+ ek 1))(setq fq(+ fq da))})})(set-bms-val'bms-v-tot fq)})((and(= gz 3)(= q 0)){(setq q 1)(if(=(ic'aw)0){(set-bms-val'bms-soc(/(bufget-u8 bv 4)100.0))})})((and(= gz 5)(= di 0)){(setq di 1)(var fv 0.055)(var p(*(bufget-i16 bv 4)fv))(set-bms-val'bms-i-in-ic p)})((and(= gz 0)(= cr 0)){(setq cr 1)})((and(= gz 4)(= h 0)){(setq h 1)(set-bms-val'bms-temp-ic(bufget-i8 bv(-(buflen bv)3)))(looprange bs 4(-(buflen bv)3){(set-bms-val'bms-temps-adc(- bs 4)(bufget-i8 bv bs))})}))(setq i du)})})(free bv)})(setq i du)} {(setq i(+ i 1))})} {(setq i(+ i 1))})})(send-bms-can)}{ })(if(>=(ic'hx)0){(if(and(>(secs-since u)dc)(<(secs-since s)1)(or(= cw 0)(> cw 5))){(gpio-write(ic'hx)1)(ff 0.1)(gpio-write(ic'hx)0)})})})(setq gs(secs-since 0))(setq bn(+ bn 0.05))(var au(- bn(secs-since 0)))(if(> au 0){(ff au)(setq bn(secs-since 0))})})})(be)